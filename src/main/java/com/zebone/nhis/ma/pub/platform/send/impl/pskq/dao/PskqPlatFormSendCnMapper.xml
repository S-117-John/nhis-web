<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zebone.nhis.ma.pub.platform.send.impl.pskq.dao.PskqPlatFormSendCnMapper">
    <resultMap id="OpBaseResultMap" type="com.zebone.nhis.ma.pub.platform.pskq.model.SurgeryApplicationOrder">
        <id column="empi_id" jdbcType="VARCHAR" property="empiId" />
        <result column="age_day" jdbcType="VARCHAR" property="ageDay" />
        <result column="age_hour" jdbcType="VARCHAR" property="ageHour" />
        <result column="age_month" jdbcType="VARCHAR" property="ageMonth" />
        <result column="age_year" jdbcType="VARCHAR" property="ageYear" />
        <result column="anesth_method_code" jdbcType="VARCHAR" property="anesthMethodCode" />
        <result column="anesth_method_name" jdbcType="VARCHAR" property="anesthMethodName" />
        <result column="anesthetist_id" jdbcType="VARCHAR" property="anesthetistId" />
        <result column="anesthetist_name" jdbcType="VARCHAR" property="anesthetistName" />
        <result column="apply_date_time" jdbcType="VARCHAR" property="applyDateTime" />
        <result column="apply_dept_id" jdbcType="VARCHAR" property="applyDeptId" />
        <result column="apply_dept_name" jdbcType="VARCHAR" property="applyDeptName" />
        <result column="apply_doctor_id" jdbcType="VARCHAR" property="applyDoctorId" />
        <result column="apply_doctor_name" jdbcType="VARCHAR" property="applyDoctorName" />
        <result column="apply_status_code" jdbcType="VARCHAR" property="applyStatusCode" />
        <result column="apply_status_name" jdbcType="VARCHAR" property="applyStatusName" />
        <result column="assistant_first_id" jdbcType="VARCHAR" property="assistantFirstId" />
        <result column="assistant_first_name" jdbcType="VARCHAR" property="assistantFirstName" />
        <result column="assistant_second_id" jdbcType="VARCHAR" property="assistantSecondId" />
        <result column="assistant_second_name" jdbcType="VARCHAR" property="assistantSecondName" />
        <result column="assistant_third_id" jdbcType="VARCHAR" property="assistantThirdId" />
        <result column="assistant_third_name" jdbcType="VARCHAR" property="assistantThirdName" />
        <result column="bed_no" jdbcType="VARCHAR" property="bedNo" />
        <result column="cancel_date_time" jdbcType="VARCHAR" property="cancelDateTime" />
        <result column="cancel_flag" jdbcType="VARCHAR" property="cancelFlag" />
        <result column="cancel_opera_id" jdbcType="VARCHAR" property="cancelOperaId" />
        <result column="cancel_opera_name" jdbcType="VARCHAR" property="cancelOperaName" />
        <result column="cancel_reason_desc" jdbcType="VARCHAR" property="cancelReasonDesc" />
        <result column="date_of_birth" jdbcType="DATE" property="dateOfBirth" />
        <result column="dept_id" jdbcType="VARCHAR" property="deptId" />
        <result column="dept_name" jdbcType="VARCHAR" property="deptName" />
        <result column="diag_code_before_surgery" jdbcType="VARCHAR" property="diagCodeBeforeSurgery" />
        <result column="diag_desc_before_surgery" jdbcType="VARCHAR" property="diagDescBeforeSurgery" />
        <result column="diag_name_before_surgery" jdbcType="VARCHAR" property="diagNameBeforeSurgery" />
        <result column="emer_flag" jdbcType="VARCHAR" property="emerFlag" />
        <result column="encounter_id" jdbcType="VARCHAR" property="encounterId" />
        <result column="encounter_type_code" jdbcType="VARCHAR" property="encounterTypeCode" />
        <result column="encounter_type_name" jdbcType="VARCHAR" property="encounterTypeName" />
        <result column="exec_dept_id" jdbcType="VARCHAR" property="execDeptId" />
        <result column="exec_dept_name" jdbcType="VARCHAR" property="execDeptName" />
        <result column="gender_code" jdbcType="VARCHAR" property="genderCode" />
        <result column="gender_name" jdbcType="VARCHAR" property="genderName" />
        <result column="hand_washing_nurse_id" jdbcType="VARCHAR" property="handWashingNurseId" />
        <result column="hand_washing_nurse_name" jdbcType="VARCHAR" property="handWashingNurseName" />
        <result column="incision_class_code" jdbcType="VARCHAR" property="incisionClassCode" />
        <result column="incision_class_name" jdbcType="VARCHAR" property="incisionClassName" />
        <result column="isolation_flag" jdbcType="VARCHAR" property="isolationFlag" />
        <result column="org_code" jdbcType="VARCHAR" property="orgCode" />
        <result column="org_name" jdbcType="VARCHAR" property="orgName" />
        <result column="patient_name" jdbcType="VARCHAR" property="patientName" />
        <result column="pk_patient" jdbcType="VARCHAR" property="pkPatient" />
        <result column="placer_order_no" jdbcType="VARCHAR" property="placerOrderNo" />
        <result column="primary_surgery_flag" jdbcType="VARCHAR" property="primarySurgeryFlag" />
        <result column="room_code" jdbcType="VARCHAR" property="roomCode" />
        <result column="room_name" jdbcType="VARCHAR" property="roomName" />
        <result column="schedule_end_date_time" jdbcType="VARCHAR" property="scheduleEndDateTime" />
        <result column="schedule_start_date_time" jdbcType="VARCHAR" property="scheduleStartDateTime" />
        <result column="surgeon_id" jdbcType="VARCHAR" property="surgeonId" />
        <result column="surgeon_name" jdbcType="VARCHAR" property="surgeonName" />
        <result column="surgery_apply_id" jdbcType="VARCHAR" property="surgeryApplyId" />
        <result column="surgery_apply_no" jdbcType="VARCHAR" property="surgeryApplyNo" />
        <result column="surgery_code" jdbcType="VARCHAR" property="surgeryCode" />
        <result column="surgery_desc" jdbcType="VARCHAR" property="surgeryDesc" />
        <result column="surgery_grade_code" jdbcType="VARCHAR" property="surgeryGradeCode" />
        <result column="surgery_grade_name" jdbcType="VARCHAR" property="surgeryGradeName" />
        <result column="surgery_name" jdbcType="VARCHAR" property="surgeryName" />
        <result column="surgery_part_code" jdbcType="VARCHAR" property="surgeryPartCode" />
        <result column="surgery_part_name" jdbcType="VARCHAR" property="surgeryPartName" />
        <result column="surgery_position_code" jdbcType="VARCHAR" property="surgeryPositionCode" />
        <result column="surgery_position_name" jdbcType="VARCHAR" property="surgeryPositionName" />
        <result column="surgery_seq_no" jdbcType="VARCHAR" property="surgerySeqNo" />
        <result column="surgery_use_desc" jdbcType="VARCHAR" property="surgeryUseDesc" />
        <result column="tour_nurse_id" jdbcType="VARCHAR" property="tourNurseId" />
        <result column="tour_nurse_name" jdbcType="VARCHAR" property="tourNurseName" />
        <result column="visit_date_time" jdbcType="VARCHAR" property="visitDateTime" />
        <result column="visit_id" jdbcType="VARCHAR" property="visitId" />
        <result column="visit_no" jdbcType="VARCHAR" property="visitNo" />
        <result column="ward_id" jdbcType="VARCHAR" property="wardId" />
        <result column="ward_name" jdbcType="VARCHAR" property="wardName" />
        <result column="operation_type" jdbcType="VARCHAR" property="operationType" />
    </resultMap>
    <select id="getOpApplyInfoById" parameterType = "java.util.Map" resultMap="OpBaseResultMap">
        select
        pi.mpi empi_id,
        pi.code_pi pk_patient,
        pv.CODE_PV encounter_id,
        oe.CODE_ORG org_code,
        oe.NAME_ORG org_name,
        pv.eu_pvtype encounter_type_code,
        case pv.eu_pvtype when '1' then '门诊' when '3' then '住院'  else '其他' end as encounter_type_name ,
        pv.code_pv visit_id,
        case when pv.eu_pvtype = '3' then  pvIp.ip_times  when pv.eu_pvtype = '1' then   pvOp.op_times  else 1 end  as visit_no,
        pi.NAME_PI patient_name,
        def.code gender_code,
        def.name gender_name,
        pi.birth_date date_of_birth,
        pv.age_pv age_year,
        pv.date_begin  visit_date_time,
        de.code_dept dept_id,
        de.name_dept dept_name,
        dept.code_dept ward_id,
        dept.name_dept ward_name,
        pv.bed_no bed_no,
        ord.code_apply  surgery_apply_no,
        ord.ORDSN placer_order_no,
        op.date_apply apply_date_time,
        deptOrd.code_dept apply_dept_id,
        deptOrd.name_dept apply_dept_name,
        emp.code_emp apply_doctor_id,
        emp.name_emp apply_doctor_name,
        cndiag.code_cd diag_code_before_surgery,
        cndiag.name_cd diag_name_before_surgery,
        op.desc_diag_pre diag_desc_before_surgery,
        leve.CODE surgery_grade_code,
        leve.NAME surgery_grade_name,
        diag.diagcode  surgery_code,
        diag.diagname surgery_name,
        op.desc_op surgery_desc,
        doc.NAME anesth_method_name ,
        doc.CODE anesth_method_code,
        docInci.NAME incision_class_code,
        docInci.CODE incision_class_name,
        docBody.NAME surgery_part_code,
        docBody.CODE surgery_part_name,
        op.date_plan  schedule_start_date_time,
        op.pk_opt room_code,
        '' room_name,
--         opt.code room_code,
--         opt.name room_name,
        op.ticketno surgery_seq_no,
        op.desc_op surgery_use_desc,
        empOp.code_emp surgeon_id,
        empOp.name_emp surgeon_name,
        empAsis1.code_emp assistant_first_id,
        empAsis1.name_emp assistant_first_name,
        empAsis2.code_emp assistant_second_id,
        empAsis2.name_emp assistant_second_name,
        empAsis3.code_emp assistant_third_id,
        empAsis3.name_emp assistant_third_name,
        empAnae.code_emp anesthetist_id,
        empAnae.name_emp anesthetist_name,
        empScrub.code_emp hand_washing_nurse_id,
        empScrub.name_emp hand_washing_nurse_name,
        empCircul.code_emp tour_nurse_id,
        empCircul.name_emp tour_nurse_name,
        <if test=" 'OC' ==control or 'CA' == control">
           '1' as cancel_flag,
            sysdate as cancel_date_time,
        </if>
        empErase.code_emp cancel_opera_id,
        empErase.name_emp cancelOperaName,
        deptExec.code_dept exec_dept_id,
        deptExec.name_dept exec_dept_name,
        case op.pk_op when NULL then 0 ELSE  1 END primary_surgery_flag,
        ord.eu_status_ord apply_status_code,
        case ord.eu_status_ord when '0' then '开立' when '1' then '签署' when '2' then '核对' when '3' then '执行' when '4' then '停止'  when '9' then '作废' end apply_status_name,
        op.eu_optype  operation_type
        from cn_order ord
        INNER  JOIN PI_MASTER pi on pi.pk_pi = ord.pk_pi
        INNER JOIN  PV_ENCOUNTER pv on pv.pk_pv = ord.pk_pv
        inner join cn_op_apply op on ord.pk_cnord = op.pk_cnord
        left join PV_OP pvOp on pvOp.PK_PV = pv.PK_PV
        left join PV_IP pvIp on pvIp.PK_PV =  pv.PK_PV
        left join bd_defdoc def on pi.dt_sex = def.CODE and def.code_defdoclist='000000'
        left join bd_ou_org oe on ord.pk_org_exec=oe.pk_org
        left join bd_ou_dept de on pv.pk_dept=de.pk_dept
        left join bd_ou_dept dept on pv.pk_dept_ns=dept.pk_dept
        left join bd_ou_dept deptOrd on ord.pk_dept_ns=deptOrd.pk_dept
        left join bd_ou_dept deptExec on ord.pk_dept_exec=deptExec.pk_dept
        left join BD_OU_EMPLOYEE emp on emp.pk_emp = ord.pk_emp_ord
        left join BD_OU_EMPLOYEE empOp on empOp.pk_emp = op.pk_emp_phy_op
        left join BD_OU_EMPLOYEE empAsis1 on empAsis1.pk_emp = op.pk_emp_asis
        left join BD_OU_EMPLOYEE empAsis2 on empAsis2.pk_emp = op.pk_emp_asis2
        left join BD_OU_EMPLOYEE empAsis3 on empAsis3.pk_emp = op.pk_emp_asis3
        left join BD_OU_EMPLOYEE empAnae on empAnae.pk_emp = op.pk_emp_anae
        left join BD_OU_EMPLOYEE empScrub on empScrub.pk_emp = op.pk_emp_scrub
        left join BD_OU_EMPLOYEE empCircul on empCircul.pk_emp = op.pk_emp_circul
        left join BD_OU_EMPLOYEE empErase on empErase.pk_emp = ord.pk_emp_erase
        left join bd_cndiag cndiag on cndiag.pk_cndiag = op.pk_diag_pre
        left join bd_defdoc leve on leve.code=op.dt_oplevel and leve.code_defdoclist='030305'
        left join bd_defdoc doc on doc.code=op.dt_anae and doc.code_defdoclist='030300'
        left join bd_defdoc docInci on docInci.code=op.dt_incitype and docInci.code_defdoclist='030300'
        left join bd_defdoc docBody on docBody.code=op.dt_opbody and docBody.code_defdoclist='030302'
        LEFT JOIN BD_TERM_DIAG diag ON diag.PK_DIAG = op.PK_OP
--         left outer join bd_res_opt opt on opt.pk_opt=op.pk_opt and opt.del_flag='0'
        where
        <choose>
            <when test="pkCnList == null">
                ord.CODE_APPLY = #{codeApply}
            </when>
            <otherwise>
                ord.pk_cnord in
                <foreach collection="pkCnList" item="pkCnList" index="no" open="("
                         separator="," close=")">
                    #{pkCnList}
                </foreach>
            </otherwise>
        </choose>

    </select>
	<select id="qryRisInfo" parameterType="java.util.Map" resultMap="BaseResultRisMap">
	 	SELECT DISTINCT pi.code_pi PK_PATIENT,pv.CODE_PV ENCOUNTER_ID,bo.code_org ORG_CODE,bo.name_org ORG_NAME
			,pv.EU_PVTYPE ENCOUNTER_TYPE_CODE,case when pv.EU_PVTYPE='1' then '门诊' else '住院' end ENCOUNTER_TYPE_NAME
			,'' VISIT_ID,'' VISIT_NO,pi.name_pi PATIENT_NAME,pi.dt_sex GENDER_CODE,bd.name GENDER_NAME,pi.birth_date DATE_OF_BIRTH
			,pv.age_pv AGE_YEAR,'' AGE_MONTH,'' AGE_DAY,'' AGE_HOUR,pv.DATE_BEGIN VISIT_DATE_TIME,bod.code_dept DEPT_ID
			,bod.name_dept DEPT_NAME,bod1.code_dept WARD_ID,bod1.name_dept WARD_NAME,pv.BED_NO BED_NO
			,co.CODE_APPLY EXAM_APPLY_ID,co.CODE_APPLY EXAM_APPLY_NO,co.CODE_ORD PLACER_ORDER_NO
			,cra.CREATE_TIME APPLY_DATE_TIME,bod2.code_dept APPLY_DEPT_ID,bod2.name_dept APPLY_DEPT_NAME
			,boe.code_emp APPLY_DOCTOR_ID,boe.name_emp APPLY_DOCTOR_NAME
			,cra.NOTE_DISE DISEASE_DESC,'' PRESENT_HISTORY_DESC
			,(select DATE_DIAG from PV_DIAG d where d.PK_PV=co.PK_PV and FLAG_MAJ='1') DIAG_DATE_TIME
			,(select CODE_ICD from PV_DIAG d where d.PK_PV=co.PK_PV and FLAG_MAJ='1') DIAG_CODE
			,(select name_diag from PV_DIAG d where d.PK_PV=co.PK_PV and FLAG_MAJ='1') DIAG_NAME
			,(select name_diag from PV_DIAG d where d.PK_PV=co.PK_PV and FLAG_MAJ='1') DESC_DIAG
			,cra.PURPOSE APPLY_PURPOSE_DESC,'' EXAM_CATEGORY_CODE,'' EXAM_CATEGORY_NAME
			,'' EXAM_CLASS_CODE,'' EXAM_CLASS_NAME,co.code_ord UNIVERSAL_SERVICE_CODE,co.name_ord UNIVERSAL_SERVICE_NAME
			,'' EXAM_PART_CODE, cra.DESC_BODY EXAM_PART_NAME,cra.NOTE APPLY_CMMT,co.DATE_PLAN_EX SCHEDULE_START_DATE_TIME
			,'' SCHEDULE_END_DATE_TIME,'' REGISTRANT_DATE_TIME,'' REGISTRANT_OPERA_ID,'' REGISTRANT_OPERA_NAME
			,cra.DEL_FLAG CANCEL_FLAG,'' CANCEL_DATE_TIME,'' CANCEL_REASON_DESC,'' CANCEL_OPERA_ID,'' CANCEL_OPERA_NAME
			,bo1.code_org EXEC_ORG_CODE,bo1.name_org EXEC_ORG_NAME,'' EXEC_SYSTEM_CODE,'' EXEC_SYSTEM_NAME
			,bod3.code_dept EXEC_DEPT_ID,bod3.name_dept EXEC_DEPT_NAME,co.FLAG_EMER EMER_FLAG ,'' GREEN_CHANNEL_FLAG
			,cra.EU_STATUS APPLY_STATUS_CODE,co.DATE_LAST_EX EXEC_DATE_TIME,boe1.code_emp EXEC_OPERA_ID,boe1.name_emp EXEC_OPERA_NAME
		FROM
			CN_RIS_APPLY cra
			INNER JOIN CN_ORDER co ON cra.PK_CNORD = co.PK_CNORD 
			left join PI_MASTER pi on pi.PK_PI=co.PK_PI
			left join PV_ENCOUNTER pv on pv.pk_pv=co.pk_pv
			left join BD_OU_ORG bo on bo.pk_Org=pv.pk_org
			left join BD_DEFDOC bd on bd.code=pi.dt_sex and bd.CODE_DEFDOCLIST = '000000'
			left join BD_OU_DEPT bod on bod.pk_dept=pv.pk_dept
			left join BD_OU_DEPT bod1 on bod1.pk_dept=pv.PK_DEPT_NS and bod1.DEL_FLAG='0'
			left join BD_OU_DEPT bod2 on bod2.pk_dept=co.PK_DEPT and bod2.DEL_FLAG='0'
			left join BD_OU_EMPLOYEE boe on boe.pk_emp=co.PK_EMP_ORD and boe.DEL_FLAG='0'
			left join BD_OU_ORG bo1 on bo1.pk_Org=co.PK_ORG_EXEC and bo1.DEL_FLAG='0'
			left join BD_OU_DEPT bod3 on bod3.pk_dept=co.PK_DEPT_EXEC and bod3.DEL_FLAG='0'
			left join BD_OU_EMPLOYEE boe1 on boe1.pk_emp=co.PK_EMP_EX and boe1.DEL_FLAG='0'
		WHERE
			co.PK_CNORD=#{pkCnord,jdbcType=VARCHAR}
   </select>
   <resultMap id="BaseResultRisMap" type="com.zebone.nhis.ma.pub.platform.pskq.model.ExamApply">
        <id column="empi_id" jdbcType="VARCHAR" property="empiId" />
        <id column="PK_PATIENT" jdbcType="VARCHAR" property="pkPatient" />
        <id column="ENCOUNTER_ID" jdbcType="VARCHAR" property="encounterId" />
        <id column="ORG_CODE" jdbcType="VARCHAR" property="orgCode" />
        <id column="ORG_NAME" jdbcType="VARCHAR" property="orgName" />
        <id column="ENCOUNTER_TYPE_CODE" jdbcType="VARCHAR" property="encounterTypeCode" />
        <id column="ENCOUNTER_TYPE_NAME" jdbcType="VARCHAR" property="encounterTypeName" />
        <id column="VISIT_ID" jdbcType="VARCHAR" property="visitId" />
        <id column="VISIT_NO" jdbcType="VARCHAR" property="visitNo" />
        <id column="PATIENT_NAME" jdbcType="VARCHAR" property="patientName" />
        <id column="GENDER_CODE" jdbcType="VARCHAR" property="genderCode" />
        <id column="GENDER_NAME" jdbcType="VARCHAR" property="genderName" />
        <id column="DATE_OF_BIRTH" jdbcType="VARCHAR" property="dateOfBirth" />
        <result column="age_day" jdbcType="VARCHAR" property="ageDay" />
        <result column="age_hour" jdbcType="VARCHAR" property="ageHour" />
        <result column="age_month" jdbcType="VARCHAR" property="ageMonth" />
        <result column="age_year" jdbcType="VARCHAR" property="ageYear" />
        <result column="VISIT_DATE_TIME" jdbcType="VARCHAR" property="visitDateTime" />
        <result column="DEPT_ID" jdbcType="VARCHAR" property="deptId" />
        <result column="DEPT_NAME" jdbcType="VARCHAR" property="deptName" />
        <result column="WARD_ID" jdbcType="VARCHAR" property="wardId" />
        <result column="WARD_NAME" jdbcType="VARCHAR" property="wardName" />
        <result column="BED_NO" jdbcType="VARCHAR" property="bedNo" />
        <result column="EXAM_APPLY_ID" jdbcType="VARCHAR" property="examApplyId" />
        <result column="EXAM_APPLY_NO" jdbcType="VARCHAR" property="examApplyNo" />
        <result column="PLACER_ORDER_NO" jdbcType="VARCHAR" property="placerOrderNo" />
        <result column="APPLY_DATE_TIME" jdbcType="VARCHAR" property="applyDateTime" />
        <result column="APPLY_DEPT_ID" jdbcType="VARCHAR" property="applyDeptId" />
        <result column="APPLY_DEPT_NAME" jdbcType="VARCHAR" property="applyDeptName" />
        <result column="APPLY_DOCTOR_ID" jdbcType="VARCHAR" property="applyDoctorId" />
        <result column="APPLY_DOCTOR_NAME" jdbcType="VARCHAR" property="applyDoctorName" />
        <result column="DISEASE_DESC" jdbcType="VARCHAR" property="diseaseDesc" />
        <result column="PRESENT_HISTORY_DESC" jdbcType="VARCHAR" property="presentHistoryDesc" />
        <result column="DIAG_DATE_TIME" jdbcType="VARCHAR" property="diagDateTime" />
        <result column="DIAG_CODE" jdbcType="VARCHAR" property="diagCode" />
        <result column="DIAG_NAME" jdbcType="VARCHAR" property="diagName" />
        <result column="DIAG_DESC" jdbcType="VARCHAR" property="diagDesc" />
        <result column="APPLY_PURPOSE_DESC" jdbcType="VARCHAR" property="applyPurposeDezsc" />
        <result column="EXAM_CATEGORY_CODE" jdbcType="VARCHAR" property="examCategoryCode" />
        <result column="EXAM_CATEGORY_NAME" jdbcType="VARCHAR" property="examCategoryName" />
        <result column="EXAM_CLASS_CODE" jdbcType="VARCHAR" property="examClassCode" />
        <result column="EXAM_CLASS_NAME" jdbcType="VARCHAR" property="examClassName" />
        <result column="UNIVERSAL_SERVICE_CODE" jdbcType="VARCHAR" property="universalServiceCode" />
        <result column="UNIVERSAL_SERVICE_NAME" jdbcType="VARCHAR" property="universalServiceName" />
        <result column="EXAM_PART_CODE" jdbcType="VARCHAR" property="examPartCode" />
        <result column="EXAM_PART_NAME" jdbcType="VARCHAR" property="examPartName" />
        <result column="APPLY_CMMT" jdbcType="VARCHAR" property="applyCmmt" />
        <result column="SCHEDULE_START_DATE_TIME" jdbcType="VARCHAR" property="scheduleStartDateTime" />
        <result column="SCHEDULE_END_DATE_TIME" jdbcType="VARCHAR" property="scheduleEndDateTime" />
        <result column="REGISTRANT_DATE_TIME" jdbcType="VARCHAR" property="registrantDateTime" />
        <result column="REGISTRANT_OPERA_ID" jdbcType="VARCHAR" property="registrantOperaId" />
        <result column="REGISTRANT_OPERA_NAME" jdbcType="VARCHAR" property="registrantOperaName" />
        <result column="CANCEL_FLAG" jdbcType="VARCHAR" property="cancelFlag" />
        <result column="CANCEL_DATE_TIME" jdbcType="VARCHAR" property="cancelDateTime" />
        <result column="CANCEL_REASON_DESC" jdbcType="VARCHAR" property="cancelReasonDesc" />
        <result column="CANCEL_OPERA_ID" jdbcType="VARCHAR" property="cancelOperaId" />
        <result column="CANCEL_OPERA_NAME" jdbcType="VARCHAR" property="cancelOperaName" />
        <result column="EXEC_ORG_CODE" jdbcType="VARCHAR" property="execOrgCode" />
        <result column="EXEC_ORG_NAME" jdbcType="VARCHAR" property="execOrgName" />
        <result column="EXEC_SYSTEM_CODE" jdbcType="VARCHAR" property="execSystemCode" />
        <result column="EXEC_SYSTEM_NAME" jdbcType="VARCHAR" property="execSystemName" />
        <result column="EXEC_DEPT_ID" jdbcType="VARCHAR" property="execDeptId" />
        <result column="EXEC_DEPT_NAME" jdbcType="VARCHAR" property="execDeptName" />
        <result column="EMER_FLAG" jdbcType="VARCHAR" property="emerFlag" />
        <result column="GREEN_CHANNEL_FLAG" jdbcType="VARCHAR" property="greenChannelFlag" />
        <result column="FEE_AMOUNT" jdbcType="VARCHAR" property="feeAmount" />
        <result column="APPLY_STATUS_CODE" jdbcType="VARCHAR" property="applyStatusCode" />
        <result column="APPLY_STATUS_NAME" jdbcType="VARCHAR" property="applyStatusName" />
        <result column="GESTATION_WEEK" jdbcType="VARCHAR" property="gestationWeek" />
        <result column="GESTATION_DAY" jdbcType="VARCHAR" property="gestationDay" />
        <result column="LAST_MENSTRUAL_PERIOD" jdbcType="VARCHAR" property="lastMenstrualPeriod" />
        <result column="EXEC_DATE_TIME" jdbcType="VARCHAR" property="execDateTime" />
        <result column="EXEC_OPERA_ID" jdbcType="VARCHAR" property="execOperaId" />
        <result column="EXEC_OPERA_NAME" jdbcType="VARCHAR" property="execOperaName" />
        <result column="CHARGE_QUANTITY" jdbcType="VARCHAR" property="chargeQuantity" />
        
    </resultMap>
	 <resultMap id="LisBaseResultMap" type="com.zebone.nhis.ma.pub.platform.pskq.model.LabApply">
	  	<id column="empi_id" jdbcType="VARCHAR" property="empiId" />
	    <result column="pk_patient" jdbcType="VARCHAR" property="pkPatient" />
        <result column="encounter_id" jdbcType="VARCHAR" property="encounterId" />
        <result column="org_code" jdbcType="VARCHAR" property="orgCode" />
        <result column="org_name" jdbcType="VARCHAR" property="orgName" />
        <result column="encounter_type_code" jdbcType="VARCHAR" property="encounterTypeCode" />
        <result column="encounter_type_name" jdbcType="VARCHAR" property="encounterTypeName" />
        <result column="visit_id" jdbcType="VARCHAR" property="visitId" />
        <result column="visit_no" jdbcType="VARCHAR" property="visitNo" />
        <result column="patient_name" jdbcType="VARCHAR" property="patientName" />
        <result column="gender_code" jdbcType="VARCHAR" property="genderCode" />
        <result column="gender_name" jdbcType="VARCHAR" property="genderName" />
        <result column="date_of_birth" jdbcType="VARCHAR" property="dateOfBirth" />
        <result column="age_year" jdbcType="VARCHAR" property="ageYear" />
        <result column="visit_date_time" jdbcType="VARCHAR" property="visitDateTime" />
        <result column="dept_id" jdbcType="VARCHAR" property="deptId" />
        <result column="dept_name" jdbcType="VARCHAR" property="deptName" />
	    <result column="ward_id" jdbcType="VARCHAR" property="wardId" />
        <result column="ward_name" jdbcType="VARCHAR" property="wardName" />
        <result column="bed_no" jdbcType="VARCHAR" property="bedNo" />
        <result column="lab_apply_id" jdbcType="VARCHAR" property="labApplyId" />
        <result column="lab_apply_no" jdbcType="VARCHAR" property="labApplyNo" />
        <result column="placer_order_no" jdbcType="VARCHAR" property="placerOrderNo" />
        <result column="apply_date_time" jdbcType="VARCHAR" property="applyDateTime" />
        <result column="apply_dept_id" jdbcType="VARCHAR" property="applyDeptId" />
        <result column="apply_dept_name" jdbcType="VARCHAR" property="applyDeptName" />
        <result column="apply_doctor_id" jdbcType="VARCHAR" property="applyDoctorId" />
		<result column="apply_doctor_name" jdbcType="VARCHAR" property="applyDoctorName" />
         <result column="DIAG_DATE_TIME" jdbcType="VARCHAR" property="diagDateTime" />
         <result column="DIAG_CODE" jdbcType="VARCHAR" property="diagCode" />
         <result column="DIAG_NAME" jdbcType="VARCHAR" property="diagName" />
        <result column="diag_desc" jdbcType="VARCHAR" property="diagDesc" />
        <result column="apply_cmmt" jdbcType="VARCHAR" property="applyCmmt" />
        <result column="lab_category_code" jdbcType="VARCHAR" property="labCategoryCode" />
        <result column="lab_category_name" jdbcType="VARCHAR" property="labCategoryName" />
        <result column="universal_service_code" jdbcType="VARCHAR" property="universalServiceCode" />
        <result column="universal_service_name" jdbcType="VARCHAR" property="universalServiceName" />
	    <result column="specimen_type_code" jdbcType="VARCHAR" property="specimenTypeCode" />
        <result column="specimen_type_name" jdbcType="VARCHAR" property="specimenTypeName" />
        <result column="specimen_no" jdbcType="VARCHAR" property="specimenNo" />
        <result column="container_type_code" jdbcType="VARCHAR" property="containerTypeCode" />
        <result column="container_type_name" jdbcType="VARCHAR" property="containerTypeName" />
        <result column="collect_date_time" jdbcType="VARCHAR" property="collectDateTime" />
        <result column="collect_dept_id" jdbcType="VARCHAR" property="collectDeptId" />
        <result column="collect_dept_name" jdbcType="VARCHAR" property="collectDeptName" />
        <result column="collect_opera_id" jdbcType="VARCHAR" property="collectOperaId" />
        <result column="collect_opera_name" jdbcType="VARCHAR" property="collectOperaName" />
	    <result column="delivery_date_time" jdbcType="VARCHAR" property="deliveryDateTime" />
        <result column="delivery_opera_id" jdbcType="VARCHAR" property="deliveryOperaId" />
        <result column="delivery_opera_name" jdbcType="VARCHAR" property="deliveryOperaName" />
        <result column="receive_date_time" jdbcType="VARCHAR" property="receiveDateTime" />
        <result column="CANCEL_FLAG" jdbcType="VARCHAR" property="cancelFlag" />
        <result column="cancel_opera_id" jdbcType="VARCHAR" property="cancelOperaId" />
        <result column="cancel_pera_name" jdbcType="VARCHAR" property="cancelOperaName" />
        <result column="exec_org_code" jdbcType="VARCHAR" property="execOrgCode" />
        <result column="exec_org_name" jdbcType="VARCHAR" property="execOrgName" />
		<result column="exec_dept_id" jdbcType="VARCHAR" property="execDeptId" />
        <result column="exec_dept_name" jdbcType="VARCHAR" property="execDeptName" />
        <result column="emer_flag" jdbcType="VARCHAR" property="emerFlag" />
        <result column="FEE_AMOUNT" jdbcType="VARCHAR" property="feeAmount" />
        <result column="apply_status_code" jdbcType="VARCHAR" property="applyStatusCode" />
        <result column="apply_status_name" jdbcType="VARCHAR" property="applyStatusName" />
        <result column="lab_type_code" jdbcType="VARCHAR" property="labTypeCode" />
	    <result column="lab_type_name" jdbcType="VARCHAR" property="labTypeName" />
 	 </resultMap>
	 
	 
	 

	<select id="getEncounterIpAdtById" parameterType="java.util.Map" resultMap="BaseResultEncounterMap">
	 	SELECT
            DISTINCT pi.code_pi PK_PATIENT
            ,pi.CODE_IP INPATIENT_NO
            ,pv.CODE_PV ENCOUNTER_ID
            ,bo.code_org ORG_CODE
            ,bo.name_org ORG_NAME
            ,pv.EU_PVTYPE ENCOUNTER_TYPE_CODE
            ,case when pv.EU_PVTYPE='1' then '门诊' else '住院' end ENCOUNTER_TYPE_NAME
            ,pv.CODE_PV  VISIT_ID
            ,ip.IP_TIMES VISIT_NO
            ,pi.name_pi PATIENT_NAME
            ,pi.dt_sex GENDER_CODE
            ,bd.name GENDER_NAME
            ,pi.birth_date DATE_OF_BIRTH
            ,pv.age_pv AGE_YEAR
            ,'' AGE_MONTH
            ,'' AGE_DAY
            ,'' AGE_HOUR
            ,pi.DT_MARRY MARITAL_STATUS_CODE
            ,bdm.name MARITAL_STATUS_NAME
            ,pv.DT_PVSOURCE PATIENT_RESOURCE_CODE
            ,bdp.name PATIENT_RESOURCE_NAME
            ,bdHp.CODE PATIENT_TYPE_CODE
            ,bdHp.name PATIENT_TYPE_NAME
            ,pv.FLAG_IN IN_HOSPITAL_FLAG
            ,ip.DT_INTYPE ADMISSION_MODE
            ,'' ADMISSION_WAY_CODE
            ,'' ADMISSION_WAY_NAME
            ,'' ADMISSION_STATUS_CODE
            ,'' ADMISSION_STATUS_NAME
            ,ip.CREATE_TIME ADMISSION_DATE_TIME
            ,bod1.code_dept  ADMISSION_DEPT_ID
            ,bod1.name_dept ADMISSION_DEPT_NAME
            ,bod2.code_dept  ADMISSION_WARD_ID
            ,bod2.name_dept ADMISSION_WARD_NAME
            ,bod2.code_dept  VISIT_WARD_ID
            ,bod2.name_dept VISIT_WARD_NAME
            ,pv.BED_NO
            ,'' DIVISION_DIRECTOR_ID
            ,'' DIVISION_DIRECTOR_NAME
            ,'' CHIEF_DOCTOR_ID
            ,'' CHIEF_DOCTOR_NAME
            ,boe3.code_emp ATTEND_DOCTOR_ID
            ,boe3.name_emp ATTEND_DOCTOR_NAME
            ,'' RESIDENT_DOCTOR_ID
            ,'' RESIDENT_DOCTOR_NAME
            ,boe.code_emp RESPONSIBLE_DOCTOR_ID
            ,boe.name_emp RESPONSIBLE_DOCTOR_NAME
            ,boe1.code_emp RESPONSIBLE_NURSE_ID
            ,boe1.name_emp RESPONSIBLE_NURSE_NAME
            ,ip.CODE_DIAG ADMISSION_DIAG_CODE
            ,ip.NAME_DIAG ADMISSION_DIAG_NAME
            ,'' ADMISSION_DIAG_DESC
            ,(select CODE_ICD from pv_DIAG where dt_diagtype='0109' and rownum=1 and pk_pv=pv.PK_PV) DISCHARGE_DIAG_CODE
            ,(select NAME_DIAG from pv_DIAG where dt_diagtype='0109' and rownum=1 and pk_pv=pv.PK_PV) DISCHARGE_DIAG_NAME
            ,(select DATE_DIAG from pv_DIAG where dt_diagtype='0109' and rownum=1 and pk_pv=pv.PK_PV) DISCHARGE_DIAG_DATE_TIME
            ,(select DESC_DIAG from pv_DIAG where dt_diagtype='0109' and rownum=1 and pk_pv=pv.PK_PV) DISCHARGE_DIAG_DESC
            ,pv.DATE_END DISCHARGE_DATE_TIME
            ,bod3.code_dept  DISCHARGE_DEPT_ID
            ,bod3.name_dept DISCHARGE_DEPT_NAME
            ,bod4.code_dept  DISCHARGE_WARD_ID
            ,bod4.name_dept DISCHARGE_WARD_NAME
            ,'' DISCHARGE_METHOD_CODE
            ,'' DISCHARGE_METHOD_NAME
            ,'' DISCHARGE_MODE
		FROM
			PV_ENCOUNTER pv
			left join PI_MASTER pi on pi.PK_PI=pv.PK_PI
			left join PV_IP ip on ip.PK_PVIP=pv.pk_pv
			left join bd_hp bdHp on bdHp.PK_HP = pv.pk_insu
			left join BD_OU_ORG bo on bo.pk_Org=pv.pk_org
			left join BD_DEFDOC bd on bd.code=pi.dt_sex and bd.CODE_DEFDOCLIST = '000000'
			left join BD_DEFDOC bdm on bdm.code=pi.DT_MARRY and bdm.CODE_DEFDOCLIST = '000006'
			left join BD_DEFDOC bdp on bdp.code=pv.DT_PVSOURCE and bdp.CODE_DEFDOCLIST = '000126'
			left join BD_OU_DEPT bod1 on bod1.pk_dept=pv.pk_dept and bod1.DEL_FLAG='0'
			left join BD_OU_DEPT bod2 on bod2.pk_dept=pv.PK_DEPT_NS and bod2.DEL_FLAG='0'
			left join BD_OU_DEPT bod3 on bod3.pk_dept=ip.PK_DEPT_DIS and bod3.DEL_FLAG='0'
			left join BD_OU_DEPT bod4 on bod4.pk_dept=ip.PK_DEPT_NS_DIS and bod4.DEL_FLAG='0'
			left join BD_OU_EMPLOYEE boe on boe.pk_emp=pv.PK_EMP_PHY and boe.DEL_FLAG='0'
			left join BD_OU_EMPLOYEE boe1 on boe1.pk_emp=pv.PK_EMP_NS and boe1.DEL_FLAG='0'
			left join BD_OU_EMPLOYEE boe3 on boe3.pk_emp=pv.pk_emp_tre and boe.DEL_FLAG='0'


		WHERE
			pv.PK_PV=#{pkPv,jdbcType=VARCHAR}
   </select>
	<resultMap id="BaseResultEncounterMap" type="com.zebone.nhis.ma.pub.platform.pskq.model.EncounterInpatient">
        <id column="EMPI_ID" jdbcType="VARCHAR" property="empiId" />
        <result column="PK_PATIENT" jdbcType="VARCHAR" property="pkPatient" />
        <result column="ENCOUNTER_ID" jdbcType="VARCHAR" property="encounterId" />
        <result column="ORG_CODE" jdbcType="VARCHAR" property="orgCode" />
        <result column="ORG_NAME" jdbcType="VARCHAR" property="orgName" />
        <result column="ENCOUNTER_TYPE_CODE" jdbcType="VARCHAR" property="encounterTypeCode" />
        <result column="ENCOUNTER_TYPE_NAME" jdbcType="VARCHAR" property="encounterTypeName" />
        <result column="VISIT_ID" jdbcType="VARCHAR" property="visitId" />
        <result column="VISIT_NO" jdbcType="VARCHAR" property="visitNo" />
        <result column="PATIENT_NAME" jdbcType="VARCHAR" property="patientName" />
        <result column="GENDER_CODE" jdbcType="VARCHAR" property="genderCode" />
        <result column="GENDER_NAME" jdbcType="VARCHAR" property="genderName" />
        <result column="DATE_OF_BIRTH" jdbcType="VARCHAR" property="dateOfBirth" />
        <result column="age_day" jdbcType="VARCHAR" property="ageDay" />
        <result column="age_hour" jdbcType="VARCHAR" property="ageHour" />
        <result column="age_month" jdbcType="VARCHAR" property="ageMonth" />
        <result column="age_year" jdbcType="VARCHAR" property="ageYear" />
        <result column="MARITAL_STATUS_CODE" jdbcType="VARCHAR" property="maritalStatusCode" />
        <result column="MARITAL_STATUS_NAME" jdbcType="VARCHAR" property="maritalStatusName" />
        <result column="PATIENT_RESOURCE_CODE" jdbcType="VARCHAR" property="patientResourceCode" />
        <result column="PATIENT_RESOURCE_NAME" jdbcType="VARCHAR" property="patientResourceName" />
        <result column="PATIENT_TYPE_CODE" jdbcType="VARCHAR" property="patientTypeCode" />
        <result column="PATIENT_TYPE_NAME" jdbcType="VARCHAR" property="patientTypeName" />
        <result column="IN_HOSPITAL_FLAG" jdbcType="VARCHAR" property="inHospitalFlag" />
        <result column="ADMISSION_MODE" jdbcType="VARCHAR" property="admissionMode" />
        <result column="ADMISSION_WAY_CODE" jdbcType="VARCHAR" property="admissionWayCode" />
        <result column="ADMISSION_WAY_NAME" jdbcType="VARCHAR" property="admissionWayName" />
        <result column="ADMISSION_STATUS_CODE" jdbcType="VARCHAR" property="admissionStatusCode" />
        <result column="ADMISSION_STATUS_NAME" jdbcType="VARCHAR" property="admissionStatusName" />
        <result column="ADMISSION_DATE_TIME" jdbcType="VARCHAR" property="admissionDateTime" />
        <result column="ADMISSION_DEPT_ID" jdbcType="VARCHAR" property="admissionDeptId" />
        <result column="ADMISSION_DEPT_NAME" jdbcType="VARCHAR" property="admissionDeptName" />
        <result column="ADMISSION_WARD_ID" jdbcType="VARCHAR" property="admissionWardId" />
        <result column="ADMISSION_WARD_NAME" jdbcType="VARCHAR" property="admissionWardName" />
        <result column="VISIT_WARD_ID" jdbcType="VARCHAR" property="visitWardId" />
        <result column="VISIT_WARD_NAME" jdbcType="VARCHAR" property="visitWardName" />
        <result column="BED_NO" jdbcType="VARCHAR" property="bedNo" />
        <result column="DIVISION_DIRECTOR_ID" jdbcType="VARCHAR" property="divisionDirectorId" />
        <result column="DIVISION_DIRECTOR_NAME" jdbcType="VARCHAR" property="divisionDirectorName" />
        <result column="CHIEF_DOCTOR_ID" jdbcType="VARCHAR" property="chiefDoctorId" />
        <result column="CHIEF_DOCTOR_NAME" jdbcType="VARCHAR" property="chiefDoctorName" />
        <result column="ATTEND_DOCTOR_ID" jdbcType="VARCHAR" property="attendDoctorId" />
        <result column="ATTEND_DOCTOR_NAME" jdbcType="VARCHAR" property="attendDoctorName" />
        <result column="RESIDENT_DOCTOR_ID" jdbcType="VARCHAR" property="residentDoctorId" />
        <result column="RESIDENT_DOCTOR_NAME" jdbcType="VARCHAR" property="residentDoctorName" />
        <result column="RESPONSIBLE_DOCTOR_ID" jdbcType="VARCHAR" property="responsibleDoctorId" />
        <result column="RESPONSIBLE_DOCTOR_NAME" jdbcType="VARCHAR" property="responsibleDoctorName" />
        <result column="RESPONSIBLE_NURSE_ID" jdbcType="VARCHAR" property="responsibleNurseId" />
        <result column="RESPONSIBLE_NURSE_NAME" jdbcType="VARCHAR" property="responsibleNurseName" />
        <result column="ADMISSION_DIAG_CODE" jdbcType="VARCHAR" property="admissionDiagCode" />
        <result column="ADMISSION_DIAG_NAME" jdbcType="VARCHAR" property="admissionDiagName" />
        <result column="ADMISSION_DIAG_DESC" jdbcType="VARCHAR" property="admissionDiagDesc" />
        <result column="DISCHARGE_DIAG_DATE_TIME" jdbcType="VARCHAR" property="dischargeDiagDateTime" />
        <result column="DISCHARGE_DIAG_CODE" jdbcType="VARCHAR" property="dischargeDiagCode" />
        <result column="DISCHARGE_DIAG_NAME" jdbcType="VARCHAR" property="dischargeDiagName" />
        <result column="DISCHARGE_DIAG_DESC" jdbcType="VARCHAR" property="dischargeDiagDesc" />
        <result column="DISCHARGE_DATE_TIME" jdbcType="VARCHAR" property="dischargeDateTime" />
        <result column="DISCHARGE_DEPT_ID" jdbcType="VARCHAR" property="dischargeDeptId" />
        <result column="DISCHARGE_DEPT_NAME" jdbcType="VARCHAR" property="dischargeDeptName" />
        <result column="DISCHARGE_WARD_ID" jdbcType="VARCHAR" property="dischargeWardId" />
        <result column="DISCHARGE_WARD_NAME" jdbcType="VARCHAR" property="dischargeWardName" />
        <result column="DISCHARGE_METHOD_CODE" jdbcType="VARCHAR" property="dischargeMethodCode" />
        <result column="DISCHARGE_METHOD_NAME" jdbcType="VARCHAR" property="dischargeMethodName" />
        <result column="DISCHARGE_MODE" jdbcType="VARCHAR" property="dischargeMode" />
        <result column="REINPAT_31D_FLAG" jdbcType="VARCHAR" property="reinpat31dFlag" />
        <result column="CP_TYPE_CODE" jdbcType="VARCHAR" property="cpTypeCode" />
        <result column="CP_CODE" jdbcType="VARCHAR" property="cpCode" />
        <result column="CP_NAME" jdbcType="VARCHAR" property="cpName" />
        <result column="DRG_CODE" jdbcType="VARCHAR" property="drgCode" />
        <result column="DRG_NAME" jdbcType="VARCHAR" property="drgName" />
        <result column="INPATIENT_NO" jdbcType="VARCHAR" property="inpatientNo" />
    </resultMap>


    <resultMap id="BaseResultEncounterChangeMap" type="com.zebone.nhis.ma.pub.platform.pskq.model.AdtChangeInfo">
        <id column="EMPI_ID" jdbcType="VARCHAR" property="empiId" />
        <result column="PK_PATIENT" jdbcType="VARCHAR" property="pkPatient" />
        <result column="ENCOUNTER_ID" jdbcType="VARCHAR" property="encounterId" />
        <result column="ENCOUNTER_TYPE_CODE" jdbcType="VARCHAR" property="encounterTypeCode" />
        <result column="ENCOUNTER_TYPE_NAME" jdbcType="VARCHAR" property="encounterTypeName" />
        <result column="VISIT_ID" jdbcType="VARCHAR" property="visitId" />
        <result column="VISIT_NO" jdbcType="VARCHAR" property="visitNo" />
        <result column="PATIENT_NAME" jdbcType="VARCHAR" property="patientName" />
        <result column="GENDER_CODE" jdbcType="VARCHAR" property="genderCode" />
        <result column="GENDER_NAME" jdbcType="VARCHAR" property="genderName" />
        <result column="DATE_OF_BIRTH" jdbcType="VARCHAR" property="dateOfBirth" />
        <result column="AGE_YEAR" jdbcType="VARCHAR" property="ageYear" />
        <result column="VISIT_DATE_TIME" jdbcType="VARCHAR" property="visitDateTime" />


        <result column="DEPT_ID" jdbcType="VARCHAR" property="deptId" />
        <result column="DEPT_NAME" jdbcType="VARCHAR" property="deptName" />
        <result column="WARD_ID" jdbcType="VARCHAR" property="wardId" />
        <result column="WARD_NAME" jdbcType="VARCHAR" property="wardName" />
        <result column="BED_NO" jdbcType="VARCHAR" property="bedNo" />
        <result column="ADT_CHANGE_INFO_NO" jdbcType="VARCHAR" property="adtChangeInfoNo" />


        <result column="TRUN_OUT_DEPT_ID" jdbcType="VARCHAR" property="trunOutDeptId" />
        <result column="TRUN_OUT_DEPT_NAME" jdbcType="VARCHAR" property="trunOutDeptName" />
        <result column="TRUN_OUT_WARD_ID" jdbcType="VARCHAR" property="trunOutWardId" />
        <result column="TRUN_OUT_WARD_NAME" jdbcType="VARCHAR" property="trunOutWardName" />

        <result column="TRUN_IN_DEPT_ID" jdbcType="VARCHAR" property="trunInDeptId" />
        <result column="TRUN_IN_DEPT_NAME" jdbcType="VARCHAR" property="trunInDeptName" />
        <result column="TRUN_IN_WARD_ID" jdbcType="VARCHAR" property="trunInWardId" />
        <result column="TRUN_IN_WARD_NAME" jdbcType="VARCHAR" property="trunInWardName" />
        <result column="TRUN_IN_BED_NO" jdbcType="VARCHAR" property="trunInBedNo" />


    </resultMap>



    <select id="getEncounterIpAdtChangeDeptById"  parameterType="java.util.Map" resultMap="BaseResultEncounterChangeMap">

        select
        distinct pi.mpi  EMPI_ID
        ,pi.code_pi PK_PATIENT
        ,pv.CODE_PV ENCOUNTER_ID
        ,pv.EU_PVTYPE ENCOUNTER_TYPE_CODE
        ,(case when pv.EU_PVTYPE='1' then '门诊' when pv.EU_PVTYPE='2' then '急诊' else '住院' end) as ENCOUNTER_TYPE_NAME
        ,pv.CODE_PV VISIT_ID
        ,ip.ip_times VISIT_NO
        ,pi.name_pi PATIENT_NAME
        ,bd.code GENDER_CODE
        ,bd.name GENDER_NAME
        ,pi.BIRTH_DATE as DATE_OF_BIRTH
        ,pv.age_pv AGE_YEAR
        ,adtStart.PK_ADT
        ,adtStart.DATE_BEGIN
        ,adtStart.DATE_END
        ,pv.date_begin VISIT_DATE_TIME
        ,adtEnd.CODE_DEPT DEPT_ID
        ,adtEnd.NAME_DEPT   DEPT_NAME
        ,adtEnd.codeNsDept WARD_ID
        ,adtEnd.nameNsDept WARD_NAME
        ,pv.bed_no BED_NO
        ,adtEnd.PK_ADT_SOURCE ADT_CHANGE_INFO_NO
        ,bdSDept.CODE_DEPT TRUN_OUT_DEPT_ID
        ,bdSDept.NAME_DEPT TRUN_OUT_DEPT_NAME
        ,bdSNsDept.CODE_DEPT TRUN_OUT_WARD_ID
        ,bdSNsDept.NAME_DEPT TRUN_OUT_WARD_NAME

        ,adtEnd.CODE_DEPT TRUN_IN_DEPT_ID
        ,adtEnd.NAME_DEPT TRUN_IN_DEPT_NAME
        ,adtEnd.codeNsDept TRUN_IN_WARD_ID
        ,adtEnd.nameNsDept TRUN_IN_WARD_NAME
        ,pv.bed_no TRUN_IN_BED_NO
        ,adtEnd.DATE_BEGIN
        from PV_ADT adtStart
        left join BD_OU_DEPT bdSDept on bdSDept.PK_DEPT = adtStart.PK_DEPT
        left join BD_OU_DEPT bdSNsDept on bdSNsDept.PK_DEPT = adtStart.pk_dept_ns
        left join
        (
        select adtE.PK_ADT
        ,adtE.PK_ADT_SOURCE
        ,bdDept.CODE_DEPT
        ,bdDept.NAME_DEPT
        ,adtE.PK_DEPT
        ,bdNsDept.CODE_DEPT codeNsDept
        ,bdNsDept.NAME_DEPT nameNsDept
        ,adtE.DATE_BEGIN
        ,adtE.DATE_END
        from PV_ADT adtE
        left join BD_OU_DEPT bdDept on bdDept.PK_DEPT = adtE.PK_DEPT
        left join BD_OU_DEPT bdNsDept on bdNsDept.PK_DEPT = adtE.pk_dept_ns
        where adtE.PK_PV = #{pkPv} and adtE.del_flag = '0'
        ) adtEnd on adtEnd.PK_ADT_SOURCE = adtStart.PK_ADT
        left join PV_ENCOUNTER pv on pv.PK_PV = adtStart.PK_PV
        left join PI_MASTER pi on pi.PK_PI = pv.PK_PI
        left join PV_IP ip on ip.PK_PV = pv.PK_PV
        left join BD_DEFDOC bd on bd.code= pi.dt_sex and bd.CODE_DEFDOCLIST = '000000'
        where adtEnd.PK_ADT_SOURCE is not null and pi.DEL_FLAG = '0' and pv.DEL_FLAG = '0'
        <if test=" pkDeptNew  !=  null ">
            and    adtEnd.PK_DEPT = #{pkDeptNew}
        </if>
        <if test=" dateCh  !=  null ">
            and adtEnd.DATE_BEGIN = to_date(#{dateCh},'yyyy-MM-dd HH24:mi:ss')

        </if>

    </select>


    <select id="getEncounterIpAdtChangeBedById"  parameterType="java.util.Map" resultType="com.zebone.nhis.ma.pub.platform.pskq.model.AdtChangeInfo">

      select
          distinct pi.mpi  EMPI_ID
            ,pi.code_pi PK_PATIENT
            ,pv.CODE_PV ENCOUNTER_ID
            ,pv.EU_PVTYPE ENCOUNTER_TYPE_CODE
            ,(case when pv.EU_PVTYPE='1' then '门诊' when pv.EU_PVTYPE='2' then '急诊' else '住院' end) as ENCOUNTER_TYPE_NAME
            ,pv.CODE_PV VISIT_ID
            ,ip.ip_times VISIT_NO
            ,pi.name_pi PATIENT_NAME
            ,bd.code GENDER_CODE
            ,bd.name GENDER_NAME
            ,pi.BIRTH_DATE as DATE_OF_BIRTH
            ,pv.age_pv AGE_YEAR
            ,pv.DATE_BEGIN VISIT_DATE_TIME
            ,bdSDept.CODE_DEPT DEPT_ID
            ,bdSDept.NAME_DEPT DEPT_NAME
            ,bdSNsDept.CODE_DEPT WARD_ID
            ,bdSNsDept.NAME_DEPT WARD_NAME
            ,pv.BED_NO BED_NO

            ,bdSDept.CODE_DEPT TRUN_OUT_DEPT_ID
            ,bdSDept.NAME_DEPT TRUN_OUT_DEPT_NAME
            ,bdSNsDept.CODE_DEPT TRUN_OUT_WARD_ID
            ,bdSNsDept.NAME_DEPT TRUN_OUT_WARD_NAME

            ,bdSDept.CODE_DEPT TRUN_IN_DEPT_ID
            ,bdSDept.NAME_DEPT TRUN_IN_DEPT_NAME
            ,bdSNsDept.CODE_DEPT TRUN_IN_WARD_ID
            ,bdSNsDept.NAME_DEPT TRUN_IN_WARD_NAME
            ,pv.BED_NO BED_NO
            ,'2000' SOURCE_SYSTEM_CODE

        from PV_ENCOUNTER pv
               left join BD_OU_DEPT bdSDept on bdSDept.PK_DEPT = pv.PK_DEPT
               left join BD_OU_DEPT bdSNsDept on bdSNsDept.PK_DEPT = pv.pk_dept_ns
               left join PI_MASTER pi on pi.PK_PI = pv.PK_PI
               left join PV_IP ip on ip.PK_PV = pv.PK_PV
               left join BD_DEFDOC bd on bd.code= pi.dt_sex and bd.CODE_DEFDOCLIST = '000000'
        where pv.PK_PV  = #{pkPv}

    </select>





    <resultMap id="BaseResultCostDetailMap" type="com.zebone.nhis.ma.pub.platform.pskq.model.CostDetailInpat">   
        <id column="EMPI_ID" jdbcType="VARCHAR" property="empiId" />
        <result column="PK_PATIENT" jdbcType="VARCHAR" property="pkPatient" />
        <result column="ENCOUNTER_ID" jdbcType="VARCHAR" property="encounterId" />
        <result column="ORG_CODE" jdbcType="VARCHAR" property="orgCode" />
        <result column="ORG_NAME" jdbcType="VARCHAR" property="orgName" />
        <result column="ENCOUNTER_TYPE_CODE" jdbcType="VARCHAR" property="encounterTypeCode" />
        <result column="ENCOUNTER_TYPE_NAME" jdbcType="VARCHAR" property="encounterTypeName" />
        <result column="VISIT_ID" jdbcType="VARCHAR" property="visitId" />
        <result column="VISIT_NO" jdbcType="VARCHAR" property="visitNo" />
        <result column="PATIENT_NAME" jdbcType="VARCHAR" property="patientName" />
        <result column="GENDER_CODE" jdbcType="VARCHAR" property="genderCode" />
        <result column="GENDER_NAME" jdbcType="VARCHAR" property="genderName" />
        <result column="DATE_OF_BIRTH" jdbcType="VARCHAR" property="dateOfBirth" />
        <result column="AGE_YEAR" jdbcType="VARCHAR" property="ageYear" />
        <result column="AGE_MONTH" jdbcType="VARCHAR" property="ageMonth" />
        <result column="AGE_DAY" jdbcType="VARCHAR" property="ageDay" />
        <result column="AGE_HOUR" jdbcType="VARCHAR" property="ageHour" />
        <result column="VISIT_DATE_TIME" jdbcType="VARCHAR" property="visitDateTime" />
        <result column="DEPT_ID" jdbcType="VARCHAR" property="deptId" />
        <result column="DEPT_NAME" jdbcType="VARCHAR" property="deptName" />
        <result column="WARD_ID" jdbcType="VARCHAR" property="wardId" />
        <result column="WARD_NAME" jdbcType="VARCHAR" property="wardName" />
        <result column="BED_NO" jdbcType="VARCHAR" property="bedNo" />
        <result column="COST_DETAIL_ID" jdbcType="VARCHAR" property="costDetailId" />
        <result column="SETTLEMENT_DETAIL_ID" jdbcType="VARCHAR" property="settlementDetailId" />
        <result column="PATIENT_TYPE_CODE" jdbcType="VARCHAR" property="patientTypeCode" />
        <result column="PATIENT_TYPE_NAME" jdbcType="VARCHAR" property="patientTypeName" />
        <result column="ACCOUNT_TYPE_CODE" jdbcType="VARCHAR" property="accountTypeCode" />
        <result column="ACCOUNT_TYPE_NAME" jdbcType="VARCHAR" property="accountTypeName" />
        <result column="CHARGE_ITEM_CODE" jdbcType="VARCHAR" property="chargeItemCode" />
        <result column="CHARGE_ITEM_NAME" jdbcType="VARCHAR" property="chargeItemName" />
        <result column="CHARGE_ITEM_PRICE" jdbcType="VARCHAR" property="chargeItemPrice" />
        <result column="CHARGE_ITEM_ORIG_PRICE" jdbcType="VARCHAR" property="chargeItemOrigPrice" />
        <result column="CHARGE_QUANTITY" jdbcType="VARCHAR" property="chargeQuantity" />
        <result column="HERBAL_QUANTITY" jdbcType="VARCHAR" property="herbalQuantity" />
        <result column="CHARGE_TOTAL" jdbcType="VARCHAR" property="chargeTotal" />
        <result column="ORIG_CHARGE_TOTAL" jdbcType="VARCHAR" property="origChargeTotal" />
        <result column="ENTER_DATE_TIME" jdbcType="VARCHAR" property="inputDateTime" />
        <result column="ENTER_DOCTOR_ID" jdbcType="VARCHAR" property="enterDoctorId" />
        <result column="ENTER_DOCTOR_NAME" jdbcType="VARCHAR" property="enterDoctorName" />
        <result column="APPLY_DEPT_ID" jdbcType="VARCHAR" property="applyDeptId" />
        <result column="APPLY_DEPT_NAME" jdbcType="VARCHAR" property="applyDeptName" />
        <result column="ACCOUNT_DEPT_ID" jdbcType="VARCHAR" property="accountDeptId" />
        <result column="ACCOUNT_DEPT_NAME" jdbcType="VARCHAR" property="accountDeptName" />
        <result column="APPLY_WARD_ID" jdbcType="VARCHAR" property="applyWardId" />
        <result column="APPLY_WARD_NAME" jdbcType="VARCHAR" property="applyWardName" />
        <result column="EXEC_DEPT_ID" jdbcType="VARCHAR" property="execDeptId" />
        <result column="EXEC_DEPT_NAME" jdbcType="VARCHAR" property="execDeptName" />
        <result column="EXEC_WARD_ID" jdbcType="VARCHAR" property="execWardId" />
        <result column="EXEC_WARD_NAME" jdbcType="VARCHAR" property="execWardName" />
        <result column="EXEC_DATE_TIME" jdbcType="VARCHAR" property="execDateTime" />
        <result column="EXEC_OPERA_ID" jdbcType="VARCHAR" property="execOperaId" />
        <result column="EXEC_OPERA_NAME" jdbcType="VARCHAR" property="execOperaName" />
        <result column="EXEC_WIN_NO" jdbcType="VARCHAR" property="execWinNo" />
        <result column="EXEC_EQUIPMENT_NO" jdbcType="VARCHAR" property="execEquipmentNo" />
        <result column="STORAGE_CODE" jdbcType="VARCHAR" property="storageCode" />
        <result column="STORAGE_NAME" jdbcType="VARCHAR" property="storageName" />
        <result column="CHARGE_STATUS" jdbcType="VARCHAR" property="chargeStatus" />
        <result column="CHARGE_ITEM_CLASS_CODE" jdbcType="VARCHAR" property="chargeItemClassCode" />
        <result column="CHARGE_ITEM_CLASS_NAME" jdbcType="VARCHAR" property="chargeItemClassName" />
        <result column="ITEM_MI_TYPE_CODE" jdbcType="VARCHAR" property="itemMiTypeCode" />
        <result column="ITEM_MI_TYPE_NAME" jdbcType="VARCHAR" property="itemMiTypeName" />
        <result column="RCPT_CLASS_CODE" jdbcType="VARCHAR" property="rcptClassCode" />
        <result column="RCPT_CLASS_NAME" jdbcType="VARCHAR" property="rcptClassName" />
        <result column="AUDIT_CLASS_CODE" jdbcType="VARCHAR" property="auditClassCode" />
        <result column="AUDIT_CLASS_NAME" jdbcType="VARCHAR" property="auditClassName" />
        <result column="ACCOUNT_CLASS_CODE" jdbcType="VARCHAR" property="accountClassCode" />
        <result column="ACCOUNT_CLASS_NAME" jdbcType="VARCHAR" property="accountClassName" />
        <result column="MR_CLASS_CODE" jdbcType="VARCHAR" property="mrClassCode" />
        <result column="MR_CLASS_NAME" jdbcType="VARCHAR" property="mrClassName" />
        <result column="HQ_MAT_FLAG" jdbcType="VARCHAR" property="hqMatFlag" />
        <result column="ASSIST_DRUG_FLAG" jdbcType="VARCHAR" property="assistDrugFlag" />
        <result column="SPECIAL_DRUG_FLAG" jdbcType="VARCHAR" property="specialDrugFlag" />
        <result column="CHARGE_DATE_TIME" jdbcType="VARCHAR" property="chargeDateTime" />
        <result column="CHARGE_OPERA_ID" jdbcType="VARCHAR" property="chargeOperaId" />
        <result column="CHARGE_OPERA_NAME" jdbcType="VARCHAR" property="chargeOperaName" />
        <result column="SETTLEMENT_NO" jdbcType="VARCHAR" property="settlementNo" />
        <result column="SETTLEMENT_TIMES" jdbcType="VARCHAR" property="settlementTimes" />
        <result column="SETTLEMENT_DATE_TIME" jdbcType="VARCHAR" property="settlementDateTime" />
        <result column="SETTLEMENT_OPERA_ID" jdbcType="VARCHAR" property="settlementOperaId" />
        <result column="SETTLEMENT_OPERA_NAME" jdbcType="VARCHAR" property="settlementOperaName" />
        <result column="MI_LIMIT_FEE" jdbcType="VARCHAR" property="miLimitFee" />
        <result column="IN_MI_FEE" jdbcType="VARCHAR" property="inMiFee" />
        <result column="OUT_MI_FEE" jdbcType="VARCHAR" property="outMiFee" />
        <result column="SELF_PAYMENT_FEE" jdbcType="VARCHAR" property="selfPaymentFee" />
        <result column="MI_STATUS" jdbcType="VARCHAR" property="miStatus" />
        <result column="MI_CLASS_CODE" jdbcType="VARCHAR" property="miClassCode" />
        <result column="MI_CLASS_NAME" jdbcType="VARCHAR" property="miClassName" />
        <result column="PREFERENTIAL_FEE" jdbcType="VARCHAR" property="preferentialFee" />
        <result column="PREFERENTIAL_RATE" jdbcType="VARCHAR" property="preferentialRate" />
        <result column="SUB_SYSTEM_CODE" jdbcType="VARCHAR" property="subSystemCode" />
        <result column="INPUT_SOURCE_CODE" jdbcType="VARCHAR" property="inputSourceCode" />
        <result column="ORDER_ID" jdbcType="VARCHAR" property="orderId" />
        <result column="SOURCE_SYSTEM_CODE" jdbcType="VARCHAR" property="sourceSystemCode" />
    </resultMap>
    <select id="queryIpCostDetailInfo" parameterType="java.util.Map" resultMap="BaseResultCostDetailMap">
	 	select  pi.mpi empi_id,pi.code_pi pk_patient,pv.CODE_PV encounter_id,oe.CODE_ORG org_code,oe.NAME_ORG org_name,
			pv.eu_pvtype encounter_type_code,
			case pv.eu_pvtype when '1' then '门诊' when '2' then '急诊' when '3' then '住院' when '4' then '体检' when '5' then '家庭病床'  else '其他' end encounter_type_name ,
			pv.code_pv visit_id, pi.cnt_ip  visit_no,pi.NAME_PI patient_name,def.code gender_code,def.name gender_name,
			pi.birth_date date_of_birth,pv.age_pv age_year,pv.date_begin  visit_date_time,
			de.code_dept dept_id,de.name_dept dept_name,
			dept.code_dept ward_id,dept.name_dept ward_name,
			pv.bed_no bed_no,boe.code_emp ENTER_DOCTOR_ID,boe.name_emp ENTER_DOCTOR_NAME,ord.DATE_ENTER ENTER_DATE_TIME,
			dept1.code_dept APPLY_DEPT_ID,dept1.name_dept APPLY_DEPT_NAME,dept1.code_dept ACCOUNT_DEPT_ID,dept1.name_dept ACCOUNT_DEPT_NAME,
			dept2.code_dept APPLY_WARD_ID,dept2.name_dept APPLY_WARD_NAME,dept3.code_dept EXEC_DEPT_ID,dept3.name_dept EXEC_DEPT_NAME,
			'' EXEC_WARD_ID,'' EXEC_WARD_NAME,ord.DATE_LAST_EX EXEC_DATE_TIME,
			boe1.code_emp EXEC_OPERA_ID,boe1.name_emp EXEC_OPERA_NAME,
			bt.PK_CGIP COST_DETAIL_ID,bi.code CHARGE_ITEM_CODE,bi.name CHARGE_ITEM_NAME,bt.PRICE CHARGE_ITEM_PRICE,
			bt.PRICE_ORG CHARGE_ITEM_ORIG_PRICE,bt.QUAN CHARGE_QUANTITY,bt.AMOUNT_PI CHARGE_TOTAL,bt.AMOUNT ORIG_CHARGE_TOTAL,
			def.code CHARGE_ITEM_CLASS_CODE,def.name CHARGE_ITEM_CLASS_NAME,ba.code AUDIT_CLASS_CODE,ba.name AUDIT_CLASS_NAME,
			ba.code ACCOUNT_CLASS_CODE,ba.name ACCOUNT_CLASS_NAME,def2.CODE MR_CLASS_CODE,def2.name MR_CLASS_NAME,
			bt.DATE_CG CHARGE_DATE_TIME,boe2.code_emp CHARGE_OPERA_ID,boe2.name_emp CHARGE_OPERA_NAME,
			bt.amount_pi SELF_PAYMENT_FEE,ord.ordsn ORDER_ID
			from CN_ORDER ord 
			left join BL_IP_DT bt on bt.PK_CNORD=ord.PK_CNORD
			inner join pv_encounter pv on ord.pk_pv = pv.pk_pv 
			inner join pi_master pi on pi.pk_pi = pv.pk_pi 
			left join bd_ou_org oe on ord.pk_org=oe.pk_org
			left join bd_defdoc def on pi.dt_sex = def.CODE and def.code_defdoclist='000000'
			left join bd_ou_dept de on pv.pk_dept=de.pk_dept
			left join bd_ou_dept dept on pv.pk_dept_ns=dept.pk_dept
			left join bd_ou_dept dept1 on ord.pk_dept=dept1.pk_dept
			left join bd_ou_dept dept2 on ord.PK_DEPT_NS=dept2.pk_dept
			left join bd_ou_dept dept3 on ord.PK_DEPT_EXEC=dept3.pk_dept
			left join BD_OU_EMPLOYEE boe on boe.pk_emp=ord.PK_EMP_ORD and boe.DEL_FLAG='0'
			left join BD_OU_EMPLOYEE boe1 on boe1.pk_emp=ord.PK_EMP_EX and boe1.DEL_FLAG='0'
			left join BD_OU_EMPLOYEE boe2 on boe2.pk_emp=bt.PK_EMP_CG and boe2.DEL_FLAG='0'
			left join BD_ITEM  bi on bi.pk_item=bt.PK_ITEM and  bi.DEL_FLAG='0'
			left join bd_defdoc def1 on bi.DT_ITEMTYPE = def.CODE and def1.code_defdoclist='030005'
			left join bd_defdoc def2 on bi.DT_CHCATE = def2.CODE and def2.code_defdoclist='030800'
			left join BD_AUDIT ba on ba.pk_audit=bi.PK_AUDIT
			where ord.PK_CNORD=#{pkCnord,jdbcType=VARCHAR}
			<if test=" 'OK' ==Control ">
           		and bt.CODE_CG=(select MAX(CODE_CG) from BL_IP_DT where PK_CNORD=#{pkCnord,jdbcType=VARCHAR} and PK_CGIP_BACK is null )	
            </if>
            <if test=" 'CR' ==Control ">
           		and bt.CODE_CG=(select MAX(CODE_CG) from BL_IP_DT where PK_CNORD=#{pkCnord,jdbcType=VARCHAR} and PK_CGIP_BACK is not null )	
            </if>
   </select>


    <select id="queryLisApplyInfoById" parameterType = "java.util.List" resultMap="LisBaseResultMap">
         select
		pi.mpi empi_id,
        pi.code_pi pk_patient,
        pv.CODE_PV encounter_id,
        oe.CODE_ORG org_code,
        oe.NAME_ORG org_name,
        pv.eu_pvtype encounter_type_code,
        case pv.eu_pvtype when '1' then '门诊' when '2' then '急诊' when '3' then '住院' when '4' then '体检' when '5' then '家庭病床'  else '其他' end encounter_type_name ,
        pv.code_pv visit_id,
       (case pv.eu_pvtype when '4' then  pvIp.ip_times  else pvOp.op_times end ) VISIT_NO,
        pi.NAME_PI patient_name,
        def.code gender_code,
        def.name gender_name,
        pi.birth_date date_of_birth,
        pv.age_pv age_year,
        pv.date_begin  visit_date_time,
        de.code_dept dept_id,
        de.name_dept dept_name,
        dept.code_dept ward_id,
        dept.name_dept ward_name,
        pv.bed_no bed_no,
		ord.code_apply  lab_apply_id,  <!--  检验申请ID -->
        ord.code_apply  lab_apply_no,    <!--  检验申请单号 -->
        ord.ORDSN placer_order_no,
        (case when ord.create_time is null then ord.DATE_ENTER else ord.create_time end) apply_date_time,   <!--申请时间及消息生成时间 -->
        deptOrd.code_dept apply_dept_id,
        deptOrd.name_dept apply_dept_name,
        emp.code_emp apply_doctor_id,
        emp.name_emp apply_doctor_name,

        diag.CREATE_TIME  DIAG_DATE_TIME,
        diag.code_icd DIAG_CODE,
        diag.name_diag DIAG_NAME,
        diag.desc_diag DIAG_DESC,
        labapp.note apply_cmmt,
		ordtype.code lab_category_code,  <!-- 检验分类代码   -->
		ordtype.name lab_category_name,  <!-- 检验分类名称 -->
		ord.code_ord  universal_service_code,
		ord.name_ord  universal_service_name,
		samptype.code  specimen_type_code,
		samptype.name  specimen_type_name,
		labapp.samp_no specimen_no,
		tube.code container_type_code,
		tube.name container_type_name,
		labapp.date_col  collect_date_time,
		deptcol.code_dept collect_dept_id,
		deptcol.name_dept collect_dept_name,
		empCol.code_emp collect_opera_id,
		empCol.name_emp collect_opera_name,
		labapp.date_col delivery_date_time,  		<!-- 暂定采集同为送检 -->
		empCol.code_emp delivery_opera_id,
		empCol.name_emp delivery_opera_name,
		labapp.date_acpt receive_date_time,
       (case ord.eu_status_ord when '9' then '1' else '0' end ) as  CANCEL_FLAG,
        empErase.code_emp cancel_opera_id,
        empErase.name_emp cancelOperaName,
	    org.CODE_ORG exec_org_code,
        org.NAME_ORG exec_org_name,
		deptExec.code_dept exec_dept_id,
        deptExec.name_dept exec_dept_name,
        ord.flag_emer emer_flag,
        cg.amount FEE_AMOUNT,
		ord.eu_status_ord apply_status_code,
        case ord.eu_status_ord when '0' then '开立' when '1' then '签署' when '2' then '核对' when '3' then '执行' when '4' then '停止'  when '9' then '作废' end apply_status_name,
		ordtype.code lab_type_code, <!--   检验类型代码   -->
		ordtype.name lab_type_name,  <!--  检验类型名称 -->
        nvl(cg.quan,'0')  CHARGE_QUANTITY
        from cn_order ord
        INNER  JOIN PI_MASTER pi on pi.pk_pi = ord.pk_pi
        INNER JOIN  PV_ENCOUNTER pv on pv.pk_pv = ord.pk_pv
        inner join cn_lab_apply labapp on ord.pk_cnord = labapp.pk_cnord
        left join pv_op pvOp on pvOp.PK_PV = pv.PK_PV
        left join PV_IP pvIp on pvIp.PK_PV = pv.PK_PV
        left join bd_defdoc def on pi.dt_sex = def.CODE and def.code_defdoclist='000000'
        left join
        (
        select sum(dt.price_org) price,sum(dt.quan) quan, sum(dt.amount) amount, dt.pk_cnord,dt.flag_acc,max(dt.flag_settle) as flag_settle from bl_op_dt dt
        where dt.pk_cnord in
        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
           #{id}
        </foreach>
        group by dt.pk_cnord,dt.flag_acc
        ) cg on ord.pk_cnord=cg.pk_cnord
        left join bd_ou_org oe on ord.pk_org=oe.pk_org
		left join bd_ou_org org on ord.pk_org_exec=org.pk_org
        left join bd_ou_dept de on pv.pk_dept=de.pk_dept
        left join bd_ou_dept dept on pv.pk_dept_ns=dept.pk_dept
        left join pv_diag diag on diag.pk_pv=pv.pk_pv and diag.flag_maj='1'
        left join bd_ou_dept deptOrd on ord.pk_dept=deptOrd.pk_dept
        left join bd_ou_dept deptExec on ord.pk_dept_exec=deptExec.pk_dept
		left join bd_ou_dept deptcol on  labapp.pk_dept_col = deptcol.pk_dept 
        left join BD_OU_EMPLOYEE emp on emp.pk_emp = ord.pk_emp_ord
        left join BD_OU_EMPLOYEE empErase on empErase.pk_emp = ord.pk_emp_erase
		left join BD_OU_EMPLOYEE empCol on empCol.pk_emp =  labapp.pk_emp_col
		left join bd_ordtype ordtype on ordtype.code = ord.code_ordtype
		left join bd_defdoc samptype on samptype.code=labapp.dt_samptype and samptype.code_defdoclist ='030200'
    left join bd_defdoc tube on tube.code=labapp.dt_tubetype and tube.code_defdoclist = '030203'
    
        where ord.CODE_ORDTYPE like '03%'
            and ord.pk_cnord in
       <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
           #{id}
       </foreach>
    </select>


    <select id="queryPacsApplyInfoById"  parameterType = "java.util.List"  resultType="com.zebone.nhis.ma.pub.platform.pskq.model.ExamApply" >

        select
        pi.mpi EMPI_ID,
        pi.code_pi PK_PATIENT,
        pv.CODE_PV ENCOUNTER_ID,
        pv.eu_pvtype ENCOUNTER_TYPE_CODE,
        (case pv.eu_pvtype when '1' then '门诊' when '2' then '急诊' when '3' then '住院' when '4' then '体检' when '5' then '家庭病床'  else '其他' end) as  ENCOUNTER_TYPE_NAME ,
        pv.code_pv VISIT_ID,
        (case pv.eu_pvtype when '4' then  pvIp.ip_times  else pvOp.op_times end ) VISIT_NO,
        pi.NAME_PI PATIENT_NAME,
        def.code GENDER_CODE,
        def.name GENDER_NAME,
        pi.birth_date DATE_OF_BIRTH,
        pv.age_pv AGE_YEAR,
        pv.date_begin  VISIT_DATE_TIME,
        de.code_dept DEPT_ID,
        de.name_dept DEPT_NAME,
        dept.code_dept WARD_ID,
        dept.name_dept WARD_NAME,
        pv.bed_no BED_NO,
        ord.code_apply  EXAM_APPLY_ID,
        ord.code_apply  EXAM_APPLY_NO,
        ord.ORDSN PLACER_ORDER_NO,
        (case when ord.create_time is null then ord.DATE_ENTER else ord.create_time end) APPLY_DATE_TIME,
        deptOrd.code_dept APPLY_DEPT_ID,
        deptOrd.name_dept APPLY_DEPT_NAME,
        emp.code_emp APPLY_DOCTOR_ID,
        emp.name_emp APPLY_DOCTOR_NAME,
        diag.CREATE_TIME  DIAG_DATE_TIME,
        diag.code_icd DIAG_CODE,
        diag.name_diag DIAG_NAME,
        diag.desc_diag DIAG_DESC,

        ordtype.code EXAM_CATEGORY_CODE,
        ordtype.name EXAM_CATEGORY_NAME,
        tisType.code EXAM_CLASS_CODE,
        tisType.name EXAM_CLASS_NAME,
        ord.code_ord  UNIVERSAL_SERVICE_CODE,
        ord.name_ord  UNIVERSAL_SERVICE_NAME,
        bodyType.CODE EXAM_PART_CODE,
        bodyType.NAME EXAM_PART_NAME,
        ord.note_ord APPLY_CMMT,
        risapp.date_appo SCHEDULE_START_DATE_TIME,
        risapp.create_time REGISTRANT_DATE_TIME,
        emp.code_emp REGISTRANT_OPERA_ID,
        emp.name_emp REGISTRANT_OPERA_NAME,
        (case ord.eu_status_ord when '9' then '1' else '0' end ) as  CANCEL_FLAG,
        deptExec.CODE_DEPT EXEC_DEPT_ID,
        deptExec.NAME_DEPT EXEC_DEPT_NAME,
        ord.flag_emer EMER_FLAG,
        cg.amount FEE_AMOUNT,
        ord.eu_status_ord APPLY_STATUS_CODE,
        (case ord.eu_status_ord when '0' then '开立' when '1' then '签署' when '2' then '核对' when '3' then '执行' when '4' then '停止'  when '9' then '作废' end ) as APPLY_STATUS_NAME,
        ord.DATE_PLAN_EX EXEC_DATE_TIME,
        ord.pk_emp_ex  EXEC_OPERA_ID,
        ord.name_emp_ex EXEC_OPERA_NAME,
        nvl(cg.quan,'0')  CHARGE_QUANTITY
        from cn_order ord
        INNER  JOIN PI_MASTER pi on pi.pk_pi = ord.pk_pi
        INNER JOIN  PV_ENCOUNTER pv on pv.pk_pv = ord.pk_pv
        inner join cn_ris_apply risapp on ord.pk_cnord = risapp.pk_cnord
        left join
        (
        select sum(dt.price_org) price,sum(dt.quan) quan, sum(dt.amount) amount, dt.pk_cnord,dt.flag_acc,max(dt.flag_settle) as flag_settle from bl_op_dt dt
        where dt.pk_cnord in
        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
        group by dt.pk_cnord,dt.flag_acc
        ) cg on ord.pk_cnord=cg.pk_cnord
        left join pv_op pvOp on pvOp.PK_PV = pv.PK_PV
        left join PV_IP pvIp on pvIp.PK_PV = pv.PK_PV
        left join pv_diag diag on diag.pk_pv=pv.pk_pv and diag.flag_maj='1'
        left join bd_defdoc def on pi.dt_sex = def.CODE and def.code_defdoclist='000000'
        left join bd_ord_ris ordRis on ordRis.PK_ORDRIS = risapp.PK_ORDRIS
        left join bd_ou_dept de on pv.pk_dept=de.pk_dept
        left join bd_ou_dept dept on pv.pk_dept_ns=dept.pk_dept
        left join bd_ou_dept deptOrd on ord.pk_dept=deptOrd.pk_dept
        left join bd_ou_dept deptExec on ord.pk_dept_exec=deptExec.pk_dept
        left join BD_OU_EMPLOYEE emp on emp.pk_emp = ord.pk_emp_ord
        left join bd_ordtype ordtype on ordtype.code = ord.code_ordtype
        left join bd_defdoc bodyType on  bodyType.code =ordRis.dt_body and bodyType.CODE_DEFDOCLIST = '030101'
        left join bd_defdoc tisType on  tisType.code =risapp.dt_ristype and tisType.CODE_DEFDOCLIST = '030100'
        where ord.CODE_ORDTYPE like '02%'

        and ord.pk_cnord in
        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>

    </select>

   <select id="queryOpCnorderProject" parameterType = "java.util.List" resultType="com.zebone.nhis.ma.pub.platform.pskq.model.OrderOutpat">
    select
     pi.mpi empi_id,
            pi.code_pi pk_patient,
            pv.CODE_PV encounter_id,
            oe.CODE_ORG org_code,
            oe.NAME_ORG org_name,
            pv.eu_pvtype encounter_type_code,
            case pv.eu_pvtype when '1' then '门诊' when '2' then '急诊' when '3' then '住院' when '4' then '体检' when '5' then '家庭病床'  else '其他' end encounter_type_name,
            pv.code_pv visit_id,
            (case pv.eu_pvtype when '4' then  pvIp.ip_times  else pvOp.op_times end ) VISIT_NO,
            pi.NAME_PI patient_name,
            def.code gender_code,
            def.name gender_name,
            pi.birth_date date_of_birth,
            pv.age_pv age_year,
    '' AGE_MONTH,
    '' AGE_DAY,
    '' AGE_HOUR,
            pv.date_begin  visit_date_time,
            de.code_dept dept_id,
            de.name_dept dept_name,
    diag.code_icd DIAG_CODE,
    diag.name_diag DIAG_NAME,
    diag.desc_diag DIAG_DESC,
    ord.ordsn ORDER_ID,
    ord.ordsn PLACER_ORDER_NO,
    concat(ord.code_apply,ord.groupno) ORDER_GROUP_NO,
    ord.groupno ORDER_ITEM_SEQ_NO,
    case ord.ordsn_parent when null then '0' else '1' end PARENT_FLAG,
    substr(ordtype.code, 1, 2) ORDER_CATEGORY_CODE,
    ordtype.name ORDER_CATEGORY_NAME,
    bdord.code ORDER_ITEM_CODE,
    bdord.name ORDER_ITEM_NAME,
    ord.desc_ord ORDER_DESC,
    ord.note_ord ORDER_ENTRUST,    
    pres.pres_no PRES_NO,
    row_number() over(partition by  pres.pres_no order by pres.ts)  PRES_GROUP_NO,
    prestype.code PRES_TYPE_CODE,
    prestype.name PRES_TYPE_NAME,
    '' PRES_SUSTAINED_DAYS,
     nvl(to_char(cg.amount,'FM99999999990.00'),'0') PRES_DRUG_AMOUNT,
    ord.dosage DOSE,
    unitdos.code DOSE_UNIT_CODE,
    unitdos.name DOSE_UNIT_NAME,
    '' DRUG_FORM_CODE,
    '' DRUG_FORM_NAME,
    ord.spec DRUG_SPEC,
    '0' DRUG_TOTAL_DOSE,
       '0'  HERBAL_QUANTITY,
    '' CHM_USAGE,
    ord.dosage USE_QUANTITY,
    unitdos.code USE_UNIT_CODE,
    unitdos.name USE_UNIT_NAME,
    nvl(cg.quan,'0') CHARGE_QUANTITY,
    '' STORAGE_CODE,
    '' STORAGE_NAME,
    '' DRUG_FREQ_CODE,
    '' DRUG_FREQ_NAME,
    supply.code USAGE_CODE,
    supply.name USAGE_NAME,
    ord.quan EXEC_TIMES,
    ord.days EXEC_DAYS,
    ord.drip_speed DROP_SPEED,
    to_char(ord.date_enter,'yyyy-MM-dd hh24:mm:ss') ENTER_DATE_TIME,
    dept.code_dept APPLY_DEPT_ID,
    dept.name_dept APPLY_DEPT_NAME,
    emp.code_emp ORDER_DOCTOR_ID,
    emp.name_emp ORDER_DOCTOR_NAME,
    '' PRICE_DATE_TIME,
    '' PRICE_OPERA_ID,
    '' PRICE_OPERA_NAME,
    '' CHECK_DATE_TIME,
    '' CHECK_OPERA_ID,
    '' CHECK_OPERA_NAME,
    '' FILL_DATE_TIME,
    '' FILL_OPERA_ID,
    '' FILL_OPERA_NAME,
    '' DISPENSE_DATE_TIME,
    '' DISPENSE_OPERA_ID,
    '' DISPENSE_OPERA_NAME,
    ord.flag_erase CANCEL_FLAG,
    to_char(ord.date_erase_chk,'yyyy-MM-dd hh24:mm:ss') CANCEL_DATE_TIME,
    empErase.code_emp CANCEL_REASON_DESC,
    empErase.name_emp CANCEL_OPERA_NAME,
    '' EXEC_DATE_TIME,
    deptExec.code_dept EXEC_DEPT_ID,
    deptExec.name_dept EXEC_DEPT_NAME,
    ord.flag_emer EMER_FLAG,
    '0' SURG_FLAG,
    ord.eu_st SKIN_TEST_FLAG,
    ord.flag_fit INDICATION_FLAG,
    ord.eu_status_ord ORDER_STATUS_CODE,
    case ord.eu_status_ord when '0' then '开立' when '1' then '签署' when '2' then '核对' when '3' then '执行' when '4' then '停止'  else '作废' end ORDER_STATUS_NAME,
    ord.spec ORDER_ITEM_SPEC,
    pi.insur_no as MED_INSURANCE_NO,
    case when hp.code ='01' then '0' else '1' end IS_INSURANCE 
            from cn_order ord
            INNER  JOIN PI_MASTER pi on pi.pk_pi = ord.pk_pi
            INNER JOIN  PV_ENCOUNTER pv on pv.pk_pv = ord.pk_pv
       left join pv_op pvOp on pvOp.PK_PV = pv.PK_PV
       left join PV_IP pvIp on pvIp.PK_PV = pv.PK_PV
                left join
                (
                select sum(dt.price_org) price, sum(dt.quan) quan, sum(dt.amount) amount, dt.pk_cnord,dt.flag_acc,max(dt.flag_settle) as flag_settle from bl_op_dt dt where dt.pk_cnord in
		        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
            		 #{id}
         		</foreach>
		        group by dt.pk_cnord,dt.flag_acc
		        ) cg on ord.pk_cnord=cg.pk_cnord
            left join bd_defdoc def on pi.dt_sex = def.CODE and def.code_defdoclist='000000'
            left join bd_ou_org oe on ord.pk_org=oe.pk_org
            left join pv_diag diag on diag.pk_pv=pv.pk_pv and diag.flag_maj='1'
            left join bd_ord bdord on bdord.pk_ord=ord.pk_ord
            left join bd_ordtype ordtype on ordtype.code=ord.code_ordtype
            left join cn_prescription pres on pres.pk_pres=ord.pk_pres
            left join bd_defdoc prestype on prestype.code=pres.dt_prestype and prestype.code_defdoclist = '060101'
            left join bd_ou_dept de on pv.pk_dept=de.pk_dept
            left join bd_ou_dept dept on ord.pk_dept=dept.pk_dept
            left join BD_OU_EMPLOYEE emp on emp.pk_emp = ord.pk_emp_ord
            left join BD_OU_EMPLOYEE empErase on empErase.pk_emp = ord.pk_emp_erase
            left join bd_ou_dept deptExec on ord.pk_dept_exec=deptExec.pk_dept
            left join BD_SUPPLY supply on supply.code=ord.code_supply
            left join bd_term_freq freq on freq.code=ord.code_freq
            left join bd_unit unit on unit.pk_unit=ord.pk_unit
            left join bd_unit unitdos on unitdos.pk_unit=ord.pk_unit_dos
            left join bd_hp hp on hp.pk_hp=pv.pk_insu and hp.del_flag='0'   
    where ord.flag_durg='0' and ord.PK_CNORD in
         <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
             #{id}
         </foreach>
   </select>



       <select id="queryOpCnorderDrugs" parameterType = "java.util.List" resultType="com.zebone.nhis.ma.pub.platform.pskq.model.OrderOutpat">
        select
        pi.mpi empi_id,
        pi.code_pi pk_patient,
        pv.CODE_PV encounter_id,
        oe.CODE_ORG org_code,
        oe.NAME_ORG org_name,
        pv.eu_pvtype encounter_type_code,
        case pv.eu_pvtype when '1' then '门诊' when '2' then '急诊' when '3' then '住院' when '4' then '体检' when '5' then '家庭病床'  else '其他' end encounter_type_name,
        pv.code_pv visit_id,
        (case pv.eu_pvtype when '4' then  pvIp.ip_times  else pvOp.op_times end ) VISIT_NO,
        pi.NAME_PI patient_name,
        def.code gender_code,
        def.name gender_name,
        pi.birth_date date_of_birth,
        pv.age_pv age_year,
        '' AGE_MONTH,
        '' AGE_DAY,
        '' AGE_HOUR,
        pv.date_begin  visit_date_time,
        de.code_dept dept_id,
        de.name_dept dept_name,
        diag.code_icd DIAG_CODE,
        diag.name_diag DIAG_NAME,
        diag.desc_diag DIAG_DESC,
        ord.ordsn ORDER_ID,
        ord.ordsn PLACER_ORDER_NO,
        concat(ord.code_apply,ord.groupno) ORDER_GROUP_NO,
        ord.groupno ORDER_ITEM_SEQ_NO,
        case ord.ordsn_parent when null then '0' else '1' end PARENT_FLAG,
        substr(ordtype.code, 1, 2) ORDER_CATEGORY_CODE,
        ordtype.name ORDER_CATEGORY_NAME,
        bdPd.code ORDER_ITEM_CODE,
        bdPd.name ORDER_ITEM_NAME,
        ord.desc_ord ORDER_DESC,
        ord.note_ord ORDER_ENTRUST,
        pres.pres_no PRES_NO,
        row_number() over(partition by  pres.pres_no order by pres.ts) PRES_GROUP_NO,
        prestype.code PRES_TYPE_CODE,
        prestype.name PRES_TYPE_NAME,
        '' PRES_SUSTAINED_DAYS,
        nvl(to_char(cg.amount,'FM99999999990.00'),'0') PRES_DRUG_AMOUNT,
        ord.dosage DOSE,
        unitdos.code DOSE_UNIT_CODE,
        unitdos.name DOSE_UNIT_NAME,
        dosage.code DRUG_FORM_CODE,
        dosage.name DRUG_FORM_NAME,
        bdPd.spec DRUG_SPEC,
        nvl(bdPd.pack_size,'0') DRUG_TOTAL_DOSE,
        '0' HERBAL_QUANTITY,
        '' CHM_USAGE,
        ord.dosage USE_QUANTITY,
        unitdos.code USE_UNIT_CODE,
        unitdos.name USE_UNIT_NAME,
        nvl(cg.quan,'0')  CHARGE_QUANTITY,
        (case  when ord.code_ordtype like '01%'  then deptExec.code_dept else  '' end) STORAGE_CODE ,
        (case  when ord.code_ordtype like '01%'  then deptExec.name_dept else  '' end) STORAGE_NAME,
        deptExec.name_dept,
        (case  when freq.code like '01%'  then deptExec.code_dept else  '' end)   DRUG_FREQ_CODE,
        (case  when freq.name  like '01%'  then deptExec.code_dept else  '' end) DRUG_FREQ_NAME,

        supply.code USAGE_CODE,
        supply.name USAGE_NAME,
        ord.quan EXEC_TIMES,
        ord.days EXEC_DAYS,
        ord.drip_speed DROP_SPEED,
        to_char(ord.date_enter,'yyyy-MM-dd hh24:mm:ss') ENTER_DATE_TIME,
        dept.code_dept APPLY_DEPT_ID,
        dept.name_dept APPLY_DEPT_NAME,
        emp.code_emp ORDER_DOCTOR_ID,
        emp.name_emp ORDER_DOCTOR_NAME,
        '' PRICE_DATE_TIME,
        '' PRICE_OPERA_ID,
        '' PRICE_OPERA_NAME,
        '' CHECK_DATE_TIME,
        '' CHECK_OPERA_ID,
        '' CHECK_OPERA_NAME,
        '' FILL_DATE_TIME,
        '' FILL_OPERA_ID,
        '' FILL_OPERA_NAME,
        '' DISPENSE_DATE_TIME,
        '' DISPENSE_OPERA_ID,
        '' DISPENSE_OPERA_NAME,
        ord.flag_erase CANCEL_FLAG,
        to_char(ord.date_erase_chk,'yyyy-MM-dd hh24:mm:ss') CANCEL_DATE_TIME,
        empErase.code_emp CANCEL_REASON_DESC,
        empErase.name_emp CANCEL_OPERA_NAME,
        '' EXEC_DATE_TIME,
        deptExec.code_dept EXEC_DEPT_ID,
        deptExec.name_dept EXEC_DEPT_NAME,
        ord.flag_emer EMER_FLAG,
        '0' SURG_FLAG,
        ord.eu_st SKIN_TEST_FLAG,
        ord.flag_fit INDICATION_FLAG,
        ord.eu_status_ord ORDER_STATUS_CODE,
        case ord.eu_status_ord when '0' then '开立' when '1' then '签署' when '2' then '核对' when '3' then '执行' when '4' then '停止'  else '作废' end ORDER_STATUS_NAME,
        ord.spec ORDER_ITEM_SPEC,
        pi.insur_no as MED_INSURANCE_NO,
        case when hp.code ='01' then '0' else '1' end IS_INSURANCE
        from cn_order ord
        INNER  JOIN PI_MASTER pi on pi.pk_pi = ord.pk_pi
        INNER JOIN  PV_ENCOUNTER pv on pv.pk_pv = ord.pk_pv
        left join pv_op pvOp on pvOp.PK_PV = pv.PK_PV
        left join PV_IP pvIp on pvIp.PK_PV = pv.PK_PV
        left join (select sum(dt.price_org) price,  sum(dt.quan) quan,  sum(dt.amount) amount,
        dt.pk_cnord,  dt.flag_acc, max(dt.flag_settle) as flag_settle  from bl_op_dt dt  where dt.pk_cnord in
        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
        group by dt.pk_cnord,dt.flag_acc) cg on ord.pk_cnord=cg.pk_cnord
        left join bd_defdoc def on pi.dt_sex = def.CODE and def.code_defdoclist='000000'
        left join bd_ou_org oe on ord.pk_org=oe.pk_org
        left join pv_diag diag on diag.pk_pv=pv.pk_pv and diag.flag_maj='1'
        left join bd_pd bdPd on bdPd.pk_pd=ord.pk_ord
        left join bd_ordtype ordtype on ordtype.code=ord.code_ordtype
        left join cn_prescription pres on pres.pk_pres=ord.pk_pres
        left join bd_defdoc prestype on prestype.code=pres.dt_prestype and prestype.code_defdoclist = '060101'
        left join bd_unit unit on unit.pk_unit=ord.pk_unit
        left join bd_unit unitdos on unitdos.pk_unit=ord.pk_unit_dos
        left join bd_ou_dept de on pv.pk_dept=de.pk_dept
        left join bd_ou_dept dept on ord.pk_dept=dept.pk_dept
        left join BD_OU_EMPLOYEE emp on emp.pk_emp = ord.pk_emp_ord
        left join BD_OU_EMPLOYEE empErase on empErase.pk_emp = ord.pk_emp_erase
        left join bd_ou_dept deptExec on ord.pk_dept_exec=deptExec.pk_dept
        left join bd_defdoc dosage on dosage.code=bdPd.dt_dosage and dosage.code_defdoclist = '030400'
        left join BD_SUPPLY supply on supply.code=ord.code_supply
        left join bd_term_freq freq on freq.code=ord.code_freq
        left join bd_hp hp on hp.pk_hp=pv.pk_insu and hp.del_flag='0'
        where ord.flag_durg='1' and ord.code_ordtype !='0103' and ord.PK_CNORD in
        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

          <!--<select id="queryOpCnorder" parameterType = "java.util.List" resultType="com.zebone.nhis.ma.pub.platform.pskq.model.OrderOutpat">-->
          <!--select-->
               <!--pi.mpi empi_id,-->
                      <!--pi.code_pi pk_patient,-->
                      <!--pv.CODE_PV encounter_id,-->
                      <!--oe.CODE_ORG org_code,-->
                      <!--oe.NAME_ORG org_name,-->
                      <!--pv.eu_pvtype encounter_type_code,-->
                      <!--case pv.eu_pvtype when '1' then '门诊' when '2' then '急诊' when '3' then '住院' when '4' then '体检' when '5' then '家庭病床'  else '其他' end encounter_type_name,-->
                      <!--pv.code_pv visit_id,-->
                      <!--(case pv.eu_pvtype when '4' then  pvIp.ip_times  else pvOp.op_times end ) VISIT_NO,-->
                      <!--pi.NAME_PI patient_name,-->
                      <!--def.code gender_code,-->
                      <!--def.name gender_name,-->
                      <!--pi.birth_date date_of_birth,-->
                      <!--pv.age_pv age_year,-->
              <!--'' AGE_MONTH,-->
              <!--'' AGE_DAY,-->
              <!--'' AGE_HOUR,-->
                      <!--pv.date_begin  visit_date_time,-->
                      <!--de.code_dept dept_id,-->
                      <!--de.name_dept dept_name,-->
              <!--diag.code_icd DIAG_CODE,-->
              <!--diag.name_diag DIAG_NAME,-->
              <!--diag.desc_diag DIAG_DESC,-->
              <!--ord.ordsn ORDER_ID,-->
              <!--ord.ordsn PLACER_ORDER_NO,-->
              <!--concat(ord.code_apply,ord.groupno) ORDER_GROUP_NO,-->
              <!--ord.groupno ORDER_ITEM_SEQ_NO,-->
              <!--case ord.ordsn_parent when null then '0' else '1' end PARENT_FLAG,-->
              <!--ordtype.code ORDER_CATEGORY_CODE,-->
              <!--ordtype.name ORDER_CATEGORY_NAME,-->
              <!--bdord.code ORDER_ITEM_CODE,-->
              <!--bdord.name ORDER_ITEM_NAME,-->
              <!--ord.desc_ord ORDER_DESC,-->
              <!--ord.note_ord ORDER_ENTRUST,-->
              <!--pres.pres_no PRES_NO,-->
              <!--row_number() over(partition by  pres.pres_no order by pres.ts)  PRES_GROUP_NO,-->
              <!--prestype.code PRES_TYPE_CODE,-->
              <!--prestype.name PRES_TYPE_NAME,-->
              <!--'' PRES_SUSTAINED_DAYS,-->
               <!--nvl(to_char(cg.amount,'FM99999999990.00'),'0') PRES_DRUG_AMOUNT,-->
              <!--'' DOSE,-->
              <!--unit.code DOSE_UNIT_CODE,-->
              <!--unit.name DOSE_UNIT_NAME,-->
              <!--'' DRUG_FORM_CODE,-->
              <!--'' DRUG_FORM_NAME,-->
              <!--'' DRUG_SPEC,-->
              <!--'' DRUG_TOTAL_DOSE,-->
              <!--'0' HERBAL_QUANTITY,-->
              <!--'' CHM_USAGE,-->
              <!--ord.quan USE_QUANTITY,-->
              <!--unit.code USE_UNIT_CODE,-->
              <!--unit.name USE_UNIT_NAME,-->
              <!--nvl(cg.quan,'0') CHARGE_QUANTITY,-->
              <!--deptExec.code_dept STORAGE_CODE,-->
              <!--deptExec.name_dept STORAGE_NAME,-->
              <!--freq.code DRUG_FREQ_CODE,-->
              <!--freq.name DRUG_FREQ_NAME,-->
              <!--supply.code USAGE_CODE,-->
              <!--supply.name USAGE_NAME,-->
              <!--ord.quan EXEC_TIMES,-->
              <!--ord.days EXEC_DAYS,-->
              <!--ord.drip_speed DROP_SPEED,-->
              <!--to_char(ord.date_enter,'yyyy-MM-dd hh24:mm:ss') ENTER_DATE_TIME,-->
              <!--dept.code_dept APPLY_DEPT_ID,-->
              <!--dept.name_dept APPLY_DEPT_NAME,-->
              <!--emp.code_emp ORDER_DOCTOR_ID,-->
              <!--emp.name_emp ORDER_DOCTOR_NAME,-->
              <!--'' PRICE_DATE_TIME,-->
              <!--'' PRICE_OPERA_ID,-->
              <!--'' PRICE_OPERA_NAME,-->
              <!--'' CHECK_DATE_TIME,-->
              <!--'' CHECK_OPERA_ID,-->
              <!--'' CHECK_OPERA_NAME,-->
              <!--'' FILL_DATE_TIME,-->
              <!--'' FILL_OPERA_ID,-->
              <!--'' FILL_OPERA_NAME,-->
              <!--'' DISPENSE_DATE_TIME,-->
              <!--'' DISPENSE_OPERA_ID,-->
              <!--'' DISPENSE_OPERA_NAME,-->
              <!--ord.flag_erase CANCEL_FLAG,-->
              <!--to_char(ord.date_erase_chk,'yyyy-MM-dd hh24:mm:ss') CANCEL_DATE_TIME,-->
              <!--empErase.code_emp CANCEL_REASON_DESC,-->
              <!--empErase.name_emp CANCEL_OPERA_NAME,-->
              <!--'' EXEC_DATE_TIME,-->
              <!--deptExec.code_dept EXEC_DEPT_ID,-->
              <!--deptExec.name_dept EXEC_DEPT_NAME,-->
              <!--ord.flag_emer EMER_FLAG,-->
              <!--'0' SURG_FLAG,-->
              <!--ord.eu_st SKIN_TEST_FLAG,-->
              <!--ord.flag_fit INDICATION_FLAG,-->
              <!--ord.eu_status_ord ORDER_STATUS_CODE,-->
              <!--case ord.eu_status_ord when '0' then '开立' when '1' then '签署' when '2' then '核对' when '3' then '执行' when '4' then '停止'  else '作废' end ORDER_STATUS_NAME,-->
              <!--ord.spec ORDER_ITEM_SPEC-->
                      <!--from cn_order ord-->
                      <!--INNER  JOIN PI_MASTER pi on pi.pk_pi = ord.pk_pi-->
                      <!--INNER JOIN  PV_ENCOUNTER pv on pv.pk_pv = ord.pk_pv-->
                      <!--left join pv_op pvOp on pvOp.PK_PV = pv.PK_PV-->
                      <!--left join PV_IP pvIp on pvIp.PK_PV = pv.PK_PV-->
                      <!--left join (select sum(dt.price_org) price,-->
                       <!--sum(dt.quan) quan,-->
			           <!--sum(dt.amount) amount,-->
			           <!--dt.pk_cnord,-->
			           <!--dt.flag_acc,-->
			           <!--max(dt.flag_settle) as flag_settle-->
			           <!--from bl_op_dt dt-->
			           <!--where dt.pk_cnord = #{pkCnord} -->
			         <!--group by dt.pk_cnord,dt.flag_acc) cg on ord.pk_cnord=cg.pk_cnord-->
                      <!--left join bd_defdoc def on pi.dt_sex = def.CODE and def.code_defdoclist='000000'-->
                      <!--left join bd_ou_org oe on ord.pk_org=oe.pk_org-->
                      <!--left join pv_diag diag on diag.pk_pv=pv.pk_pv and diag.flag_maj='1'-->
                      <!--left join bd_ord bdord on bdord.pk_ord=ord.pk_ord-->
                      <!--left join bd_ordtype ordtype on ordtype.code=ord.code_ordtype-->
                      <!--left join cn_prescription pres on pres.pk_pres=ord.pk_pres-->
                      <!--left join bd_defdoc prestype on prestype.code=pres.dt_prestype and prestype.code_defdoclist = '060101'-->
                      <!--left join bd_ou_dept de on pv.pk_dept=de.pk_dept-->
                      <!--left join bd_ou_dept dept on ord.pk_dept=dept.pk_dept-->
                      <!--left join BD_OU_EMPLOYEE emp on emp.pk_emp = ord.pk_emp_ord-->
                      <!--left join BD_OU_EMPLOYEE empErase on empErase.pk_emp = ord.pk_emp_erase-->
                      <!--left join bd_ou_dept deptExec on ord.pk_dept_exec=deptExec.pk_dept-->
                      <!--left join BD_SUPPLY supply on supply.code=ord.code_supply-->
                      <!--left join bd_term_freq freq on freq.code=ord.code_freq-->
                      <!--left join bd_unit unit on unit.pk_unit=ord.pk_unit-->
              <!--where ord.flag_durg='0'  and ord.PK_CNORD =#{pkCnord}-->
              <!--union-->
              <!--select-->
                     <!--pi.mpi empi_id,-->
                            <!--pi.code_pi pk_patient,-->
                            <!--pv.CODE_PV encounter_id,-->
                            <!--oe.CODE_ORG org_code,-->
                            <!--oe.NAME_ORG org_name,-->
                            <!--pv.eu_pvtype encounter_type_code,-->
                            <!--case pv.eu_pvtype when '1' then '门诊' when '2' then '急诊' when '3' then '住院' when '4' then '体检' when '5' then '家庭病床'  else '其他' end encounter_type_name,-->
                            <!--pv.code_pv visit_id,-->
                            <!--(case pv.eu_pvtype when '4' then  pvIp.ip_times  else pvOp.op_times end ) VISIT_NO,-->
                            <!--pi.NAME_PI patient_name,-->
                            <!--def.code gender_code,-->
                            <!--def.name gender_name,-->
                            <!--pi.birth_date date_of_birth,-->
                            <!--pv.age_pv age_year,-->
                    <!--'' AGE_MONTH,-->
                    <!--'' AGE_DAY,-->
                    <!--'' AGE_HOUR,-->
                            <!--pv.date_begin  visit_date_time,-->
                            <!--de.code_dept dept_id,-->
                            <!--de.name_dept dept_name,-->
                    <!--diag.code_icd DIAG_CODE,-->
                    <!--diag.name_diag DIAG_NAME,-->
                    <!--diag.desc_diag DIAG_DESC,-->
                    <!--ord.ordsn ORDER_ID,-->
                    <!--ord.ordsn PLACER_ORDER_NO,-->
                    <!--concat(ord.code_apply,ord.groupno) ORDER_GROUP_NO,-->
                    <!--ord.groupno ORDER_ITEM_SEQ_NO,-->
                    <!--case ord.ordsn_parent when null then '0' else '1' end PARENT_FLAG,-->
                    <!--ordtype.code ORDER_CATEGORY_CODE,-->
                    <!--ordtype.name ORDER_CATEGORY_NAME,-->
                    <!--bdPd.code ORDER_ITEM_CODE,-->
                    <!--bdPd.name ORDER_ITEM_NAME,-->
                    <!--ord.desc_ord ORDER_DESC,-->
                    <!--ord.note_ord ORDER_ENTRUST,-->
                    <!--pres.pres_no PRES_NO,-->
                    <!--row_number() over(partition by  pres.pres_no order by pres.ts)  PRES_GROUP_NO,-->
                    <!--prestype.code PRES_TYPE_CODE,-->
                    <!--prestype.name PRES_TYPE_NAME,-->
                    <!--'' PRES_SUSTAINED_DAYS,-->
                     <!--nvl(to_char(cg.amount,'FM99999999990.00'),'0') PRES_DRUG_AMOUNT,-->
                    <!--ordHerb.quan DOSE,-->
                    <!--unit.code DOSE_UNIT_CODE,-->
                    <!--unit.name DOSE_UNIT_NAME,-->
                    <!--dosage.code DRUG_FORM_CODE,-->
                    <!--dosage.name DRUG_FORM_NAME,-->
                    <!--bdPd.spec DRUG_SPEC,-->
                    <!--bdPd.pack_size DRUG_TOTAL_DOSE,-->
                    <!--'0' HERBAL_QUANTITY,-->
                    <!--'' CHM_USAGE,-->
                    <!--ord.quan USE_QUANTITY,-->
                    <!--unit.code USE_UNIT_CODE,-->
                    <!--unit.name USE_UNIT_NAME,-->
                    <!--nvl(cg.quan,'0') CHARGE_QUANTITY,-->
                    <!--deptExec.code_dept STORAGE_CODE,-->
                    <!--deptExec.name_dept STORAGE_NAME,-->
                    <!--freq.code DRUG_FREQ_CODE,-->
                    <!--freq.name DRUG_FREQ_NAME,-->
                    <!--supply.code USAGE_CODE,-->
                    <!--supply.name USAGE_NAME,-->
                    <!--ord.quan EXEC_TIMES,-->
                    <!--ord.days EXEC_DAYS,-->
                    <!--ord.drip_speed DROP_SPEED,-->
                    <!--to_char(ord.date_enter,'yyyy-MM-dd hh24:mm:ss') ENTER_DATE_TIME,-->
                    <!--dept.code_dept APPLY_DEPT_ID,-->
                    <!--dept.name_dept APPLY_DEPT_NAME,-->
                    <!--emp.code_emp ORDER_DOCTOR_ID,-->
                    <!--emp.name_emp ORDER_DOCTOR_NAME,-->
                    <!--'' PRICE_DATE_TIME,-->
                    <!--'' PRICE_OPERA_ID,-->
                    <!--'' PRICE_OPERA_NAME,-->
                    <!--'' CHECK_DATE_TIME,-->
                    <!--'' CHECK_OPERA_ID,-->
                    <!--'' CHECK_OPERA_NAME,-->
                    <!--'' FILL_DATE_TIME,-->
                    <!--'' FILL_OPERA_ID,-->
                    <!--'' FILL_OPERA_NAME,-->
                    <!--'' DISPENSE_DATE_TIME,-->
                    <!--'' DISPENSE_OPERA_ID,-->
                    <!--'' DISPENSE_OPERA_NAME,-->
                    <!--ord.flag_erase CANCEL_FLAG,-->
                    <!--to_char(ord.date_erase_chk,'yyyy-MM-dd hh24:mm:ss') CANCEL_DATE_TIME,-->
                    <!--empErase.code_emp CANCEL_REASON_DESC,-->
                    <!--empErase.name_emp CANCEL_OPERA_NAME,-->
                    <!--'' EXEC_DATE_TIME,-->
                    <!--deptExec.code_dept EXEC_DEPT_ID,-->
                    <!--deptExec.name_dept EXEC_DEPT_NAME,-->
                    <!--ord.flag_emer EMER_FLAG,-->
                    <!--'0' SURG_FLAG,-->
                    <!--ord.eu_st SKIN_TEST_FLAG,-->
                    <!--ord.flag_fit INDICATION_FLAG,-->
                    <!--ord.eu_status_ord ORDER_STATUS_CODE,-->
                    <!--case ord.eu_status_ord when '0' then '开立' when '1' then '签署' when '2' then '核对' when '3' then '执行' when '4' then '停止'  else '作废' end ORDER_STATUS_NAME,-->
                    <!--ord.spec ORDER_ITEM_SPEC-->
                            <!--from cn_order ord-->
                            <!--INNER  JOIN PI_MASTER pi on pi.pk_pi = ord.pk_pi-->
                            <!--INNER JOIN  PV_ENCOUNTER pv on pv.pk_pv = ord.pk_pv-->
                            <!--left join pv_op pvOp on pvOp.PK_PV = pv.PK_PV-->
                            <!--left join PV_IP pvIp on pvIp.PK_PV = pv.PK_PV-->
                            <!--left join (select sum(dt.price_org) price,-->
                             <!--sum(dt.quan) quan,-->
					           <!--sum(dt.amount) amount,-->
					           <!--dt.pk_cnord,-->
					           <!--dt.flag_acc,-->
					           <!--max(dt.flag_settle) as flag_settle-->
					           <!--from bl_op_dt dt-->
					           <!--where dt.pk_cnord =#{pkCnord}-->
					         <!--group by dt.pk_cnord,dt.flag_acc) cg on ord.pk_cnord=cg.pk_cnord-->
                            <!--left join bd_defdoc def on pi.dt_sex = def.CODE and def.code_defdoclist='000000'-->
                            <!--left join bd_ou_org oe on ord.pk_org=oe.pk_org-->
                            <!--left join pv_diag diag on diag.pk_pv=pv.pk_pv and diag.flag_maj='1'-->
                            <!--left join cn_ord_herb ordHerb on ordHerb.pk_cnord=ord.pk_cnord-->
                            <!--left join bd_pd bdPd on bdPd.pk_pd=ordHerb.pk_pd-->
                            <!--left join bd_ordtype ordtype on ordtype.code=ord.code_ordtype-->
                            <!--left join cn_prescription pres on pres.pk_pres=ord.pk_pres-->
                            <!--left join bd_defdoc prestype on prestype.code=pres.dt_prestype and prestype.code_defdoclist = '060101'-->
                            <!--left join bd_unit unit on unit.pk_unit=ordHerb.pk_unit-->
                            <!--left join bd_ou_dept de on pv.pk_dept=de.pk_dept-->
                            <!--left join bd_ou_dept dept on ord.pk_dept=dept.pk_dept-->
                            <!--left join BD_OU_EMPLOYEE emp on emp.pk_emp = ord.pk_emp_ord-->
                            <!--left join BD_OU_EMPLOYEE empErase on empErase.pk_emp = ord.pk_emp_erase-->
                            <!--left join bd_ou_dept deptExec on ord.pk_dept_exec=deptExec.pk_dept-->
                            <!--left join bd_defdoc dosage on dosage.code=bdPd.dt_dosage and dosage.code_defdoclist = '030400'-->
                            <!--left join BD_SUPPLY supply on supply.code=ord.code_supply-->
                            <!--left join bd_term_freq freq on freq.code=ord.code_freq-->
                    <!--where ord.flag_durg='1' and ord.code_ordtype='0103' and ord.PK_CNORD =#{pkCnord}-->
                    <!--union-->
                    <!--select-->
                               <!--pi.mpi empi_id,-->
                                      <!--pi.code_pi pk_patient,-->
                                      <!--pv.CODE_PV encounter_id,-->
                                      <!--oe.CODE_ORG org_code,-->
                                      <!--oe.NAME_ORG org_name,-->
                                      <!--pv.eu_pvtype encounter_type_code,-->
                                      <!--case pv.eu_pvtype when '1' then '门诊' when '2' then '急诊' when '3' then '住院' when '4' then '体检' when '5' then '家庭病床'  else '其他' end encounter_type_name,-->
                                      <!--pv.code_pv visit_id,-->
                                      <!--(case pv.eu_pvtype when '4' then  pvIp.ip_times  else pvOp.op_times end ) VISIT_NO,-->
                                      <!--pi.NAME_PI patient_name,-->
                                      <!--def.code gender_code,-->
                                      <!--def.name gender_name,-->
                                      <!--pi.birth_date date_of_birth,-->
                                      <!--pv.age_pv age_year,-->
                              <!--'' AGE_MONTH,-->
                              <!--'' AGE_DAY,-->
                              <!--'' AGE_HOUR,-->
                                      <!--pv.date_begin  visit_date_time,-->
                                      <!--de.code_dept dept_id,-->
                                      <!--de.name_dept dept_name,-->
                              <!--diag.code_icd DIAG_CODE,-->
                              <!--diag.name_diag DIAG_NAME,-->
                              <!--diag.desc_diag DIAG_DESC,-->
                              <!--ord.ordsn ORDER_ID,-->
                              <!--ord.ordsn PLACER_ORDER_NO,-->
                              <!--concat(ord.code_apply,ord.groupno) ORDER_GROUP_NO,-->
                              <!--ord.groupno ORDER_ITEM_SEQ_NO,-->
                              <!--case ord.ordsn_parent when null then '0' else '1' end PARENT_FLAG,-->
                              <!--ordtype.code ORDER_CATEGORY_CODE,-->
                              <!--ordtype.name ORDER_CATEGORY_NAME,-->
                              <!--bdPd.code ORDER_ITEM_CODE,-->
                              <!--bdPd.name ORDER_ITEM_NAME,-->
                              <!--ord.desc_ord ORDER_DESC,-->
                              <!--ord.note_ord ORDER_ENTRUST,-->
                              <!--pres.pres_no PRES_NO,-->
                              <!--row_number() over(partition by  pres.pres_no order by pres.ts)  PRES_GROUP_NO,-->
                              <!--prestype.code PRES_TYPE_CODE,-->
                              <!--prestype.name PRES_TYPE_NAME,-->
                              <!--'' PRES_SUSTAINED_DAYS,-->
                               <!--nvl(to_char(cg.amount,'FM99999999990.00'),'0') PRES_DRUG_AMOUNT,-->
                              <!--ord.quan DOSE,-->
                              <!--unit.code DOSE_UNIT_CODE,-->
                              <!--unit.name DOSE_UNIT_NAME,-->
                              <!--dosage.code DRUG_FORM_CODE,-->
                              <!--dosage.name DRUG_FORM_NAME,-->
                              <!--bdPd.spec DRUG_SPEC,-->
                              <!--bdPd.pack_size DRUG_TOTAL_DOSE,-->
                              <!--'0' HERBAL_QUANTITY,-->
                              <!--'' CHM_USAGE,-->
                              <!--ord.quan USE_QUANTITY,-->
                              <!--unit.code USE_UNIT_CODE,-->
                              <!--unit.name USE_UNIT_NAME,-->
                              <!--nvl(cg.quan,'0') CHARGE_QUANTITY,-->
                              <!--deptExec.code_dept STORAGE_CODE,-->
                              <!--deptExec.name_dept STORAGE_NAME,-->
                              <!--freq.code DRUG_FREQ_CODE,-->
                              <!--freq.name DRUG_FREQ_NAME,-->
                              <!--supply.code USAGE_CODE,-->
                              <!--supply.name USAGE_NAME,-->
                              <!--ord.quan EXEC_TIMES,-->
                              <!--ord.days EXEC_DAYS,-->
                              <!--ord.drip_speed DROP_SPEED,-->
                              <!--to_char(ord.date_enter,'yyyy-MM-dd hh24:mm:ss') ENTER_DATE_TIME,-->
                              <!--dept.code_dept APPLY_DEPT_ID,-->
                              <!--dept.name_dept APPLY_DEPT_NAME,-->
                              <!--emp.code_emp ORDER_DOCTOR_ID,-->
                              <!--emp.name_emp ORDER_DOCTOR_NAME,-->
                              <!--'' PRICE_DATE_TIME,-->
                              <!--'' PRICE_OPERA_ID,-->
                              <!--'' PRICE_OPERA_NAME,-->
                              <!--'' CHECK_DATE_TIME,-->
                              <!--'' CHECK_OPERA_ID,-->
                              <!--'' CHECK_OPERA_NAME,-->
                              <!--'' FILL_DATE_TIME,-->
                              <!--'' FILL_OPERA_ID,-->
                              <!--'' FILL_OPERA_NAME,-->
                              <!--'' DISPENSE_DATE_TIME,-->
                              <!--'' DISPENSE_OPERA_ID,-->
                              <!--'' DISPENSE_OPERA_NAME,-->
                              <!--ord.flag_erase CANCEL_FLAG,-->
                              <!--to_char(ord.date_erase_chk,'yyyy-MM-dd hh24:mm:ss') CANCEL_DATE_TIME,-->
                              <!--empErase.code_emp CANCEL_REASON_DESC,-->
                              <!--empErase.name_emp CANCEL_OPERA_NAME,-->
                              <!--'' EXEC_DATE_TIME,-->
                              <!--deptExec.code_dept EXEC_DEPT_ID,-->
                              <!--deptExec.name_dept EXEC_DEPT_NAME,-->
                              <!--ord.flag_emer EMER_FLAG,-->
                              <!--'0' SURG_FLAG,-->
                              <!--ord.eu_st SKIN_TEST_FLAG,-->
                              <!--ord.flag_fit INDICATION_FLAG,-->
                              <!--ord.eu_status_ord ORDER_STATUS_CODE,-->
                              <!--case ord.eu_status_ord when '0' then '开立' when '1' then '签署' when '2' then '核对' when '3' then '执行' when '4' then '停止'  else '作废' end ORDER_STATUS_NAME,-->
                              <!--ord.spec ORDER_ITEM_SPEC-->
                                      <!--from cn_order ord-->
                                      <!--INNER  JOIN PI_MASTER pi on pi.pk_pi = ord.pk_pi-->
                                      <!--INNER JOIN  PV_ENCOUNTER pv on pv.pk_pv = ord.pk_pv-->
                                      <!--left join pv_op pvOp on pvOp.PK_PV = pv.PK_PV-->
                                      <!--left join PV_IP pvIp on pvIp.PK_PV = pv.PK_PV-->
                                      <!--left join-->
                                      <!--(-->
                                      <!--select sum(dt.price_org) price, sum(dt.quan) quan, sum(dt.amount) amount, dt.pk_cnord,  dt.flag_acc, max(dt.flag_settle) as flag_settle from bl_op_dt dt  where dt.pk_cnord =#{pkCnord}  group by dt.pk_cnord,dt.flag_acc-->
							          <!--) cg on ord.pk_cnord=cg.pk_cnord-->
                                      <!--left join bd_defdoc def on pi.dt_sex = def.CODE and def.code_defdoclist='000000'-->
                                      <!--left join bd_ou_org oe on ord.pk_org=oe.pk_org-->
                                      <!--left join pv_diag diag on diag.pk_pv=pv.pk_pv and diag.flag_maj='1'-->
                                      <!--left join bd_pd bdPd on bdPd.pk_pd=ord.pk_ord-->
                                      <!--left join bd_ordtype ordtype on ordtype.code=ord.code_ordtype-->
                                      <!--left join cn_prescription pres on pres.pk_pres=ord.pk_pres-->
                                      <!--left join bd_defdoc prestype on prestype.code=pres.dt_prestype and prestype.code_defdoclist = '060101'-->
                                      <!--left join bd_unit unit on unit.pk_unit=ord.pk_unit-->
                                      <!--left join bd_ou_dept de on pv.pk_dept=de.pk_dept-->
                                      <!--left join bd_ou_dept dept on ord.pk_dept=dept.pk_dept-->
                                      <!--left join BD_OU_EMPLOYEE emp on emp.pk_emp = ord.pk_emp_ord-->
                                      <!--left join BD_OU_EMPLOYEE empErase on empErase.pk_emp = ord.pk_emp_erase-->
                                      <!--left join bd_ou_dept deptExec on ord.pk_dept_exec=deptExec.pk_dept-->
                                      <!--left join bd_defdoc dosage on dosage.code=bdPd.dt_dosage and dosage.code_defdoclist = '030400'-->
                                      <!--left join BD_SUPPLY supply on supply.code=ord.code_supply-->
                                      <!--left join bd_term_freq freq on freq.code=ord.code_freq-->
                              <!--where ord.flag_durg='1' and ord.code_ordtype !='0103' and ord.PK_CNORD =#{pkCnord}-->
          <!--</select>-->



<select id="queryIpCnorderProject" parameterType = "java.util.List" resultType="com.zebone.nhis.ma.pub.platform.pskq.model.OrderExecRecord">
    select
     pi.mpi empi_id,
            pi.code_pi pk_patient,
            pv.CODE_PV encounter_id,
            oe.CODE_ORG org_code,
            oe.NAME_ORG org_name,
            pv.eu_pvtype encounter_type_code,
            case pv.eu_pvtype when '1' then '门诊' when '2' then '急诊' when '3' then '住院' when '4' then '体检' when '5' then '家庭病床'  else '其他' end encounter_type_name,
            pv.code_pv visit_id,
            (case pv.eu_pvtype when '4' then  pvIp.ip_times  else pvOp.op_times end ) VISIT_NO,
            pi.NAME_PI patient_name,
            def.code gender_code,
            def.name gender_name,
            pi.birth_date date_of_birth,
            pv.age_pv age_year,
		    '' AGE_MONTH,
		    '' AGE_DAY,
		    '' AGE_HOUR,
            pv.date_begin  visit_date_time,
            de.code_dept dept_id,
            de.name_dept dept_name,
            deptwa.code_dept ward_id,
        	deptwa.name_dept ward_name,
        	pv.BED_NO,
		    diag.code_icd DIAG_CODE,
		    diag.name_diag DIAG_NAME,
		    diag.desc_diag DIAG_DESC,
		    ord.PK_CNORD ORDER_ID,
		    ord.ordsn PLACER_ORDER_NO,
		    ord.ordsn_parent ORDER_GROUP_NO,
		    ord.ordsn_parent ORDER_ITEM_SEQ_NO,
		    case ord.ordsn_parent when null then '0' else '1' end PARENT_FLAG,
		    substr(ordtype.code, 1, 2) ORDER_CATEGORY_CODE,
		    ordtype.name ORDER_CATEGORY_NAME,
		    case ord.EU_ALWAYS when '0' then '1'  else '0' end order_type_code,
		    case ord.EU_ALWAYS when '0' then '长期医嘱'  else '临时医嘱' end order_type_name,
		    
		    bdord.code ORDER_ITEM_CODE,
		    bdord.name ORDER_ITEM_NAME,
		    ord.desc_ord ORDER_DESC,
		    ord.note_ord ORDER_ENTRUST,    
		    pres.pres_no PRES_NO,
		    row_number() over(partition by  pres.pres_no order by pres.ts)  PRES_GROUP_NO,
		    prestype.code PRES_TYPE_CODE,
		    prestype.name PRES_TYPE_NAME,
		    '' PRES_SUSTAINED_DAYS,
		    ord.dosage DOSE,
		    unitdos.code DOSE_UNIT_CODE,
		    unitdos.name DOSE_UNIT_NAME,
		    '' DRUG_FORM_CODE,
		    '' DRUG_FORM_NAME,
		    ord.spec DRUG_SPEC,
		    '0' DRUG_TOTAL_DOSE,
		       '0'  HERBAL_QUANTITY,
		    '' CHM_USAGE,
		    ord.dosage USE_QUANTITY,
		    unitdos.code USE_UNIT_CODE,
		    unitdos.name USE_UNIT_NAME,
		    '' STORAGE_CODE,
		    '' STORAGE_NAME,
		    '' DRUG_FREQ_CODE,
		    '' DRUG_FREQ_NAME,
		    supply.code USAGE_CODE,
		    supply.name USAGE_NAME,
		    ord.quan EXEC_TIMES,
		    ord.days EXEC_DAYS,
		    ord.drip_speed DROP_SPEED,
		    to_char(ord.date_enter,'yyyy-MM-dd hh24:mm:ss') ENTER_DATE_TIME,
		    to_char(ord.DATE_START,'yyyy-MM-dd hh24:mm:ss') order_start_date_time,
		    to_char(ord.DATE_STOP,'yyyy-MM-dd hh24:mm:ss') order_end_date_time,
		    to_char(ord.DATE_CHK,'yyyy-MM-dd hh24:mm:ss') CONFIRM_DATE_TIME,
		    empchk.code_emp confirm_nurse_id,
		    empchk.name_emp confirm_nurse_name,
		    to_char(ord.DATE_STOP,'yyyy-MM-dd hh24:mm:ss') STOP_DATE_TIME,
		    empstop.code_emp STOP_OPERA_ID,
		    empstop.name_emp STOP_OPERA_NAME,
		    

		    deptexec.code_dept EXEC_DEPT_ID,
            deptexec.name_dept EXEC_DEPT_NAME,
            empex.code_emp EXEC_OPERA_ID,
		    empex.name_emp EXEC_OPERA_NAME,
		    ord.INFANT_NO INFANT_FLAG,
		    ord.FLAG_SELF SELF_OWNED_FLAG,
		    ord.FLAG_MEDOUT DISCHARGE_FLAG,
		    
		    
		    dept.code_dept APPLY_DEPT_ID,
		    dept.name_dept APPLY_DEPT_NAME,
		    emp.code_emp ORDER_DOCTOR_ID,
		    emp.name_emp ORDER_DOCTOR_NAME,
		    '' PRICE_DATE_TIME,
		    '' PRICE_OPERA_ID,
		    '' PRICE_OPERA_NAME,
		    '' CHECK_DATE_TIME,
		    '' CHECK_OPERA_ID,
		    '' CHECK_OPERA_NAME,
		    '' FILL_DATE_TIME,
		    '' FILL_OPERA_ID,
		    '' FILL_OPERA_NAME,
		    '' DISPENSE_DATE_TIME,
		    '' DISPENSE_OPERA_ID,
		    '' DISPENSE_OPERA_NAME,
		    ord.flag_erase CANCEL_FLAG,
		    to_char(ord.date_erase_chk,'yyyy-MM-dd hh24:mm:ss') CANCEL_DATE_TIME,
		    empErase.code_emp CANCEL_REASON_DESC,
		    empErase.name_emp CANCEL_OPERA_NAME,
		    '' EXEC_DATE_TIME,
		    ord.flag_emer EMER_FLAG,
		    '0' SURG_FLAG,
		    ord.eu_st SKIN_TEST_FLAG,
		    ord.flag_fit INDICATION_FLAG,
		    ord.eu_status_ord ORDER_STATUS_CODE,
		    case ord.eu_status_ord when '0' then '开立' when '1' then '签署' when '2' then '核对' when '3' then '执行' when '4' then '停止'  else '作废' end ORDER_STATUS_NAME,
		    ord.spec ORDER_ITEM_SPEC,
		    pi.insur_no as MED_INSURANCE_NO,
		    case when hp.code ='01' then '0' else '1' end IS_INSURANCE 
          from cn_order ord
            INNER  JOIN PI_MASTER pi on pi.pk_pi = ord.pk_pi
            INNER JOIN  PV_ENCOUNTER pv on pv.pk_pv = ord.pk_pv
       left join pv_op pvOp on pvOp.PK_PV = pv.PK_PV
       left join PV_IP pvIp on pvIp.PK_PV = pv.PK_PV
            left join bd_defdoc def on pi.dt_sex = def.CODE and def.code_defdoclist='000000'
            left join bd_ou_org oe on ord.pk_org=oe.pk_org
            left join pv_diag diag on diag.pk_pv=pv.pk_pv and diag.flag_maj='1'
            left join bd_ord bdord on bdord.pk_ord=ord.pk_ord
            left join bd_ordtype ordtype on ordtype.code=ord.code_ordtype
            left join cn_prescription pres on pres.pk_pres=ord.pk_pres
            left join bd_defdoc prestype on prestype.code=pres.dt_prestype and prestype.code_defdoclist = '060101'
            left join bd_defdoc ordtypeco on ordtypeco.code=ord.CODE_ORDTYPE and ordtypeco.code_defdoclist = '120100'
            left join bd_ou_dept de on pv.pk_dept=de.pk_dept
            left join bd_ou_dept dept on ord.pk_dept=dept.pk_dept
            left join bd_ou_dept deptwa on pv.pk_dept_ns=deptwa.pk_dept
            left join bd_ou_dept deptexec on ord.PK_DEPT_EXEC=deptexec.pk_dept
            
            left join BD_OU_EMPLOYEE emp on emp.pk_emp = ord.pk_emp_ord
            left join BD_OU_EMPLOYEE empErase on empErase.pk_emp = ord.pk_emp_erase
            left join BD_OU_EMPLOYEE empchk on empchk.pk_emp = ord.PK_EMP_CHK
            left join BD_OU_EMPLOYEE empstop on empstop.pk_emp = ord.PK_EMP_STOP
            left join BD_OU_EMPLOYEE empex on empex.pk_emp = ord.PK_EMP_EX
            left join BD_SUPPLY supply on supply.code=ord.code_supply
            left join bd_term_freq freq on freq.code=ord.code_freq
            left join bd_unit unit on unit.pk_unit=ord.pk_unit
            left join bd_unit unitdos on unitdos.pk_unit=ord.pk_unit_dos
            left join bd_hp hp on hp.pk_hp=pv.pk_insu and hp.del_flag='0'   
    	where ord.flag_durg='0' and ord.PK_CNORD in
         <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
             #{id}
         </foreach>
   </select>
   <select id="queryIpCnorderDrugs" parameterType = "java.util.List" resultType="com.zebone.nhis.ma.pub.platform.pskq.model.OrderExecRecord">
        select
        pi.mpi empi_id,
        pi.code_pi pk_patient,
        pv.CODE_PV encounter_id,
        oe.CODE_ORG org_code,
        oe.NAME_ORG org_name,
        pv.eu_pvtype encounter_type_code,
        case pv.eu_pvtype when '1' then '门诊' when '2' then '急诊' when '3' then '住院' when '4' then '体检' when '5' then '家庭病床'  else '其他' end encounter_type_name,
        pv.code_pv visit_id,
        (case pv.eu_pvtype when '4' then  pvIp.ip_times  else pvOp.op_times end ) VISIT_NO,
        pi.NAME_PI patient_name,
        def.code gender_code,
        def.name gender_name,
        pi.birth_date date_of_birth,
        pv.age_pv age_year,
        '' AGE_MONTH,
        '' AGE_DAY,
        '' AGE_HOUR,
        pv.date_begin  visit_date_time,
        de.code_dept dept_id,
        de.name_dept dept_name,
        deptwa.code_dept ward_id,
        deptwa.name_dept ward_name,
        pv.BED_NO,
        diag.code_icd DIAG_CODE,
        diag.name_diag DIAG_NAME,
        diag.desc_diag DIAG_DESC,
        ord.PK_CNORD ORDER_ID,
        ord.ordsn PLACER_ORDER_NO,
        ord.ordsn_parent ORDSN_PARENT,
        ord.ordsn_parent ORDER_GROUP_NO,
        case ord.ordsn_parent when null then '0' else '1' end PARENT_FLAG,
        substr(ordtype.code, 1, 2) ORDER_CATEGORY_CODE,
        ordtype.name ORDER_CATEGORY_NAME,
        
        case ord.EU_ALWAYS when '0' then '1'  else '0' end order_type_code,
		case ord.EU_ALWAYS when '0' then '长期医嘱'  else '临时医嘱' end order_type_name,
        bdPd.code ORDER_ITEM_CODE,
        bdPd.name ORDER_ITEM_NAME,
        ord.desc_ord ORDER_DESC,
        ord.note_ord ORDER_ENTRUST,
        pres.pres_no PRES_NO,
        row_number() over(partition by  pres.pres_no order by pres.ts) PRES_GROUP_NO,
        prestype.code PRES_TYPE_CODE,
        prestype.name PRES_TYPE_NAME,
        '' PRES_SUSTAINED_DAYS,
        ord.dosage DOSE,
        unitdos.code DOSE_UNIT_CODE,
        unitdos.name DOSE_UNIT_NAME,
        dosage.code DRUG_FORM_CODE,
        dosage.name DRUG_FORM_NAME,
        bdPd.spec DRUG_SPEC,
        nvl(bdPd.pack_size,'0') DRUG_TOTAL_DOSE,
        '0' HERBAL_QUANTITY,
        '' CHM_USAGE,
        ord.dosage USE_QUANTITY,
        unitdos.code USE_UNIT_CODE,
        unitdos.name USE_UNIT_NAME,
        (case  when ord.code_ordtype like '01%'  then deptExec.code_dept else  '' end) STORAGE_CODE ,
        (case  when ord.code_ordtype like '01%'  then deptExec.name_dept else  '' end) STORAGE_NAME,
        deptExec.name_dept,
        (case  when freq.code like '01%'  then deptExec.code_dept else  '' end)   DRUG_FREQ_CODE,
        (case  when freq.name  like '01%'  then deptExec.code_dept else  '' end) DRUG_FREQ_NAME,

        supply.code USAGE_CODE,
        supply.name USAGE_NAME,
        ord.quan EXEC_TIMES,
        ord.days EXEC_DAYS,
        ord.drip_speed DROP_SPEED,
        to_char(ord.date_enter,'yyyy-MM-dd hh24:mm:ss') ENTER_DATE_TIME,
        
        to_char(ord.DATE_START,'yyyy-MM-dd hh24:mm:ss') order_start_date_time,
	    to_char(ord.DATE_STOP,'yyyy-MM-dd hh24:mm:ss') order_end_date_time,
	    to_char(ord.DATE_CHK,'yyyy-MM-dd hh24:mm:ss') CONFIRM_DATE_TIME,
	    empchk.code_emp confirm_nurse_id,
	    empchk.name_emp confirm_nurse_name,
        to_char(ord.DATE_STOP,'yyyy-MM-dd hh24:mm:ss') STOP_DATE_TIME,
	    empstop.code_emp STOP_OPERA_ID,
	    empstop.name_emp STOP_OPERA_NAME,

		deptexec.code_dept EXEC_DEPT_ID,
        deptexec.name_dept EXEC_DEPT_NAME,
        empex.code_emp EXEC_OPERA_ID,
		empex.name_emp EXEC_OPERA_NAME,
        ord.INFANT_NO INFANT_FLAG,
		ord.FLAG_SELF SELF_OWNED_FLAG,
		ord.FLAG_MEDOUT DISCHARGE_FLAG,
        
        dept.code_dept APPLY_DEPT_ID,
        dept.name_dept APPLY_DEPT_NAME,
        emp.code_emp ORDER_DOCTOR_ID,
        emp.name_emp ORDER_DOCTOR_NAME,
        '' PRICE_DATE_TIME,
        '' PRICE_OPERA_ID,
        '' PRICE_OPERA_NAME,
        '' CHECK_DATE_TIME,
        '' CHECK_OPERA_ID,
        '' CHECK_OPERA_NAME,
        '' FILL_DATE_TIME,
        '' FILL_OPERA_ID,
        '' FILL_OPERA_NAME,
        '' DISPENSE_DATE_TIME,
        '' DISPENSE_OPERA_ID,
        '' DISPENSE_OPERA_NAME,
        ord.flag_erase CANCEL_FLAG,
        to_char(ord.date_erase_chk,'yyyy-MM-dd hh24:mm:ss') CANCEL_DATE_TIME,
        empErase.code_emp CANCEL_REASON_DESC,
        empErase.name_emp CANCEL_OPERA_NAME,
        '' EXEC_DATE_TIME,
        ord.flag_emer EMER_FLAG,
        '0' SURG_FLAG,
        ord.eu_st SKIN_TEST_FLAG,
        ord.flag_fit INDICATION_FLAG,
        ord.eu_status_ord ORDER_STATUS_CODE,
        case ord.eu_status_ord when '0' then '开立' when '1' then '签署' when '2' then '核对' when '3' then '执行' when '4' then '停止'  else '作废' end ORDER_STATUS_NAME,
        ord.spec ORDER_ITEM_SPEC,
        pi.insur_no as MED_INSURANCE_NO,
        case when hp.code ='01' then '0' else '1' end IS_INSURANCE
        from cn_order ord
        INNER  JOIN PI_MASTER pi on pi.pk_pi = ord.pk_pi
        INNER JOIN  PV_ENCOUNTER pv on pv.pk_pv = ord.pk_pv
        left join pv_op pvOp on pvOp.PK_PV = pv.PK_PV
        left join PV_IP pvIp on pvIp.PK_PV = pv.PK_PV
        left join bd_defdoc def on pi.dt_sex = def.CODE and def.code_defdoclist='000000'
        left join bd_ou_org oe on ord.pk_org=oe.pk_org
        left join pv_diag diag on diag.pk_pv=pv.pk_pv and diag.flag_maj='1'
        left join bd_pd bdPd on bdPd.pk_pd=ord.pk_ord
        left join bd_ordtype ordtype on ordtype.code=ord.code_ordtype
        left join cn_prescription pres on pres.pk_pres=ord.pk_pres
        left join bd_defdoc prestype on prestype.code=pres.dt_prestype and prestype.code_defdoclist = '060101'
        left join bd_defdoc ordtypeco on ordtypeco.code=ord.CODE_ORDTYPE and ordtypeco.code_defdoclist = '120100'
        left join bd_unit unit on unit.pk_unit=ord.pk_unit
        left join bd_unit unitdos on unitdos.pk_unit=ord.pk_unit_dos
        left join bd_ou_dept de on pv.pk_dept=de.pk_dept
        left join bd_ou_dept dept on ord.pk_dept=dept.pk_dept
        left join bd_ou_dept deptwa on pv.pk_dept_ns=deptwa.pk_dept
        left join BD_OU_EMPLOYEE emp on emp.pk_emp = ord.pk_emp_ord
        left join BD_OU_EMPLOYEE empErase on empErase.pk_emp = ord.pk_emp_erase
        left join BD_OU_EMPLOYEE empchk on empchk.pk_emp = ord.PK_EMP_CHK
        left join BD_OU_EMPLOYEE empstop on empstop.pk_emp = ord.PK_EMP_STOP
        left join BD_OU_EMPLOYEE empex on empex.pk_emp = ord.PK_EMP_EX
        left join bd_ou_dept deptExec on ord.pk_dept_exec=deptExec.pk_dept
        left join bd_defdoc dosage on dosage.code=bdPd.dt_dosage and dosage.code_defdoclist = '030400'
        left join BD_SUPPLY supply on supply.code=ord.code_supply
        left join bd_term_freq freq on freq.code=ord.code_freq
        left join bd_hp hp on hp.pk_hp=pv.pk_insu and hp.del_flag='0'
        where ord.flag_durg='1' and ord.code_ordtype !='0103' and ord.PK_CNORD in
        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>
</mapper>
