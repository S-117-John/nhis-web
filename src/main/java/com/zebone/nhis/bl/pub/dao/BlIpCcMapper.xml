<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zebone.nhis.bl.pub.dao.BlIpCcMapper">
	<select id="qryStAmtInfo" parameterType="java.util.HashMap"
		resultType="com.zebone.nhis.common.module.bl.BlCc">
		select sum(st.amount_st) amt_settle ,sum(st.amount_prep) amt_prep_rt,
		sum(st.amount_insu) amt_insu
		from bl_settle st where st.eu_pvtype = 3 and st.flag_cc = 0
		<if test="pkOrg != null and pkOrg != ''">
			and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
	</select>

	<select id="qryAmtInsu" parameterType="java.util.HashMap"
		resultType="com.zebone.nhis.bl.pub.vo.AmtInsuVo">
		select sum(st.amount_insu) amt_insu,
		da.val_attr
		from bl_settle st
		inner join bd_hp hp on st.pk_insurance=hp.pk_hp
		inner join bd_dictattr da on hp.pk_hp=da.pk_dict
		inner join bd_dictattr_temp dat on da.pk_dictattrtemp=dat.pk_dictattrtemp
		where dat.code_attr='0301'
		<if test="pkEmp != null and pkEmp != ''">
			and st.eu_pvtype = 3 and st.flag_cc = 0
			and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
			and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
			and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
		<if test="pkCc!=null and pkCc!=''">
			and st.pk_cc=#{pkCc,jdbcType=VARCHAR}
		</if>
		group by da.val_attr

	</select>

	<select id="qryStInv" parameterType="java.util.HashMap"
		resultType="com.zebone.nhis.bl.pub.vo.InvInfo">
		select inv.pk_empinvoice,
		inv.pk_invcate,
		max(inv.code_inv) endcode,
		min(inv.code_inv) begincode,
		count(1) cnt
		from bl_st_inv stinv
		inner join bl_invoice inv on stinv.pk_invoice = inv.pk_invoice
		inner join bl_settle st on st.pk_settle = stinv.pk_settle
		where st.eu_pvtype = 3 and inv.flag_cc = 0
		<if test="pkOrg != null and pkOrg != ''">
			and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and inv.pk_emp_inv = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and inv.date_inv &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
		group by inv.pk_empinvoice,
		inv.pk_invcate
	</select>

	<select id="qryStInvOracle" parameterType="java.util.HashMap"
		resultType="com.zebone.nhis.bl.pub.vo.InvInfo">
		select
		tmp.pk_empinvoice,
		tmp.pk_invcate,
		max(tmp.code_inv) endcode,
		min(tmp.code_inv) begincode,
		count(1) cnt
		from (
		SELECT
		inv.pk_empinvoice,
		inv.pk_invcate,
		inv.code_inv,
		substr(inv.code_inv, nvl(length(bei.inv_prefix) + 1, 1)) cc
		FROM bl_st_inv stinv
		INNER JOIN bl_invoice inv ON stinv.pk_invoice = inv.pk_invoice
		INNER JOIN bl_settle st ON st.pk_settle = stinv.pk_settle
		INNER JOIN bl_emp_invoice bei ON inv.pk_empinvoice = bei.pk_empinv
		WHERE st.eu_pvtype = 3 AND inv.flag_cc = 0
		<if test="pkOrg != null and pkOrg != ''">
			and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and inv.pk_emp_inv = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and inv.date_inv &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
		order by inv.code_inv asc
		) tmp
		group by
		to_number(tmp.cc-rownum),tmp.pk_empinvoice, tmp.pk_invcate
		order by
		begincode asc
	</select>

	<select id="qryStInvSqlServer" parameterType="java.util.HashMap"
		resultType="com.zebone.nhis.bl.pub.vo.InvInfo">
		select
		tmp.pk_empinvoice,
		tmp.pk_invcate,
		max(tmp.code_inv) endcode,
		min(tmp.code_inv) begincode,
		count(1) cnt
		from (
		SELECT
		inv.pk_empinvoice,
		inv.pk_invcate,
		inv.code_inv,
		substring(inv.code_inv,isnull(len(bei.inv_prefix)+1,1),len(inv.code_inv))
		cc,
		row_number() over (order by inv.code_inv) as rownum
		FROM bl_st_inv stinv
		INNER JOIN bl_invoice inv ON stinv.pk_invoice = inv.pk_invoice
		INNER JOIN bl_settle st ON st.pk_settle = stinv.pk_settle
		INNER JOIN bl_emp_invoice bei ON inv.pk_empinvoice = bei.pk_empinv
		WHERE st.eu_pvtype = 3 AND inv.flag_cc = 0
		<if test="pkOrg != null and pkOrg != ''">
			and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and inv.pk_emp_inv = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and inv.date_inv &lt;=
			convert(DATETIME2,left('${dateEnd}',8)+cast(' ' as nvarchar)+substring('${dateEnd}',9,2)+cast(':' as nvarchar)+substring('${dateEnd}',11,2)+cast(':' as nvarchar)+substring('${dateEnd}',13,2),120)
		</if>
		) tmp
		group by convert(numeric,tmp.cc-rownum),tmp.pk_empinvoice,
		tmp.pk_invcate
		order by begincode asc
	</select>


	<select id="qryStInv_Invalid" parameterType="java.util.HashMap"
		resultType="com.zebone.nhis.bl.pub.vo.InvalidStInv">
		select inv.pk_invcate,
		inv.pk_empinvoice,
		inv.code_inv
		from bl_invoice inv
		inner join bd_invcate cate on inv.pk_invcate=cate.pk_invcate
		where
		cate.eu_type = '1' and inv.flag_cancel = 1 and inv.flag_cc_cancel = 0 and code_inv is not null 
		<if test="pkOrg != null and pkOrg != ''">
			and inv.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and inv.pk_emp_cancel = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and inv.date_cancel &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
		order by inv.code_inv asc
	</select>
	<select id="qryDepoInfo" parameterType="java.util.HashMap"
		resultType="com.zebone.nhis.common.module.bl.BlCcPay">
		select sum(depo.amount) amt,
		count(1) cnt_trade,
		depo.dt_paymode,
		case
		when depo.eu_dptype='4' and depo.eu_direct='1' then '-1'
		when depo.eu_dptype='4' and depo.eu_direct='-1' then '1'
		else depo.eu_direct
		end eu_direct,
		depo.eu_dptype eu_paytype
		from bl_deposit depo
		where depo.eu_pvtype = 3 and depo.flag_cc = 0 and depo.amount!=0  
		<if test="pkOrg != null and pkOrg != ''">
			and depo.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and depo.pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and depo.date_pay &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
		group by depo.dt_paymode,
		depo.eu_direct,
		depo.eu_dptype
	</select>


	<select id="qryDepoInvOracle" parameterType="java.util.HashMap"
		resultType="com.zebone.nhis.bl.pub.vo.DepositInv">
		select min(tmp.rept_no) begincoe,
		max(tmp.rept_no) endcoe,
		tmp.pk_empinvoice pk_Empinvoice_Prep,
		to_number(tmp.cc-rownum)
		from(
		select depo.rept_no,
		depo.PK_EMPINVOICE,
		substr(depo.rept_no,nvl(length(bei.inv_prefix)+1,1)) cc
		from bl_deposit depo
		inner join bl_emp_invoice bei on depo.pk_empinvoice=bei.pk_empinv
		where depo.eu_dptype = 9 and 
		depo.eu_direct = '1' and
		depo.flag_cc = 0 and
		depo.amount!=0
		<if test="pkOrg != null and pkOrg != ''">
			and depo.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and depo.pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}  
		</if>
		<if test="dateEnd != null and dateEnd != ''">
        and  depo.date_pay &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},'yyyymmddhh24miss') 
		</if>
		order by depo.rept_no
		) tmp
		group by
		to_number(tmp.cc-rownum),tmp.pk_empinvoice
		order by begincoe asc
	</select>
	<select id="qryDepoInvSqlServer" parameterType="java.util.HashMap"
		resultType="com.zebone.nhis.bl.pub.vo.DepositInv">
		select min(tmp.rept_no) begincoe,
		max(tmp.rept_no) endcoe,
		tmp.pk_empinvoice pk_Empinvoice_Prep,
		convert(numeric,tmp.cc-rownum)
		from(
		select depo.rept_no,
		depo.PK_EMPINVOICE,
		substring(depo.rept_no,isnull(len(bei.inv_prefix)+1,1),len(depo.rept_no))
		cc,
		row_number() over (order by depo.rept_no) as rownum
		from bl_deposit depo
		inner join bl_emp_invoice bei on depo.pk_empinvoice=bei.pk_empinv
		where
		depo.eu_dptype = 9 and
		depo.eu_direct = '1' and
		depo.flag_cc = 0 and
		depo.amount!=0
		<if test="pkOrg != null and pkOrg != ''">
			and depo.pk_org = #{pkOrg,jdbcType=CHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and  depo.pk_emp_pay = #{pkEmp,jdbcType=CHAR} 
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and  depo.date_pay &lt;=
			convert(DATETIME2,left('${dateEnd}',8)+cast(' ' as nvarchar)+substring('${dateEnd}',9,2)+cast(':' as nvarchar)+substring('${dateEnd}',11,2)+cast(':' as nvarchar)+substring('${dateEnd}',13,2),120)
		</if>
		) tmp
		group by convert(numeric,tmp.cc-rownum),tmp.pk_empinvoice
		order by
		begincoe asc
	</select>
	<select id="qryDepoInv_Rtn" parameterType="java.util.HashMap"
		resultType="com.zebone.nhis.bl.pub.vo.DepoRtnInfo">
		select depo.rept_no,
		depo.pk_empinvoice
		from bl_deposit depo
		where depo.eu_dptype = 9 and
		depo.flag_cc = 0 and
		depo.eu_direct = -1
		<if test="pkOrg != null and pkOrg != ''">
			and depo.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and depo.pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and depo.date_pay &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
		order by depo.rept_no asc
	</select>
	<select id="qryPrepPay" parameterType="java.util.HashMap"
		resultType="com.zebone.nhis.common.module.bl.BlCc">
		select sum(depo.amount) amt_prep,
		sum(case when eu_direct=1 then 1 else 0 end) cnt_depo
		from bl_deposit depo 
		where depo.eu_dptype = 9 and depo.flag_cc = 0 
		<if test="pkOrg != null and pkOrg != ''">
			and depo.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and depo.pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and depo.date_pay &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},'yyyymmddhh24miss')
		</if>
	</select>



	<update id="updBlSettle" parameterType="java.util.Map">
		update bl_settle set flag_cc = 1,
		<if test="pkCc != null  and  pkCc != ''">
			pk_cc = #{pkCc,jdbcType=VARCHAR}
		</if>
		where eu_pvtype = 3 and flag_cc = 0 and date_st &lt;
		#{dateSt,jdbcType=DATE}
		<if test="pkEmp != null  and  pkEmp != ''">
			and pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="pkOrg != null  and  pkOrg != ''">
			and pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
	</update>



	<update id="updBlDeposit" parameterType="java.util.Map">

		update bl_deposit set flag_cc = 1,
		<if test="pkCc != null  and  pkCc != ''">
			pk_cc = #{pkCc,jdbcType=VARCHAR}
		</if>
		where flag_cc = 0 and eu_pvtype = 3 and date_pay
		&lt;#{dateSt,jdbcType=DATE}
		<if test="pkEmp != null  and  pkEmp != ''">
			and pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="pkOrg != null  and  pkOrg != ''">
			and pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
	</update>

	<!-- <update id="updInv" parameterType="java.util.Map" > /**/update bl_invoice 
		inv set inv.flag_cc = 1, inv.pk_cc = #{pkCc,jdbcType=VARCHAR} where exists 
		(select 1 from bl_settle st inner join bl_st_inv si on st.pk_settle=si.pk_settle 
		where inv.pk_invoice=si.pk_invoice and st.pk_org = #{pkOrg,jdbcType=VARCHAR} 
		and st.eu_pvtype = 3) and inv.pk_emp_inv = #{pkEmp,jdbcType=VARCHAR} and 
		inv.flag_cc = 0 and inv.date_inv &lt;=sysdate </update> <update id="updInvCanc" 
		parameterType="java.util.Map" > update bl_invoice inv set inv.flag_cc_cancel 
		= 1, <if test="pkCc != null and pkCc != ''"> inv.pk_cc_cancel = #{pkCc,jdbcType=VARCHAR} 
		</if> where exists (select 1 from bl_settle st inner join bl_st_inv si on 
		st.pk_settle=si.pk_settle where inv.pk_invoice=si.pk_invoice <if test="pkOrg 
		!= null and pkOrg != ''"> and st.pk_org = #{pkOrg,jdbcType=VARCHAR} </if> 
		and st.eu_pvtype = 3) and inv.date_cancel &lt;=sysdate and inv.flag_cc_cancel 
		= 0 <if test="pkEmp != null and pkEmp != ''"> and inv.pk_emp_cancel = #{pkEmp,jdbcType=VARCHAR} 
		</if> </update> -->
	<!-- 根据操作员获取上一次结账信息 -->
	<select id="getLastCcByPkEmp" parameterType="java.lang.String"
		resultType="com.zebone.nhis.common.module.bl.BlCc">
		select t.*
		from(
		select *
		from bl_cc
		where del_flag = '0' and EU_CCTYPE='8'and pk_emp_opera = #{pkEmp,jdbcType=VARCHAR}
		order by date_end desc ) t
		where rownum = 1
	</select>
	<!-- 根据操作员获取上一次结账信息（sqlserver） -->
	<select id="getLastBlCcByPkEmpForSql" parameterType="java.lang.String"
		resultType="com.zebone.nhis.common.module.bl.BlCc">
		select top 1 *
		from bl_cc
		where del_flag = '0'and  EU_CCTYPE='8' and pk_emp_opera = #{pkEmp,jdbcType=VARCHAR}
		order by date_end desc
	</select>

	<!-- 根据操作员获取时间最早的结算记录（sqlserver） -->
	<select id="getLastBlSettleByPkEmpForSql" parameterType="java.lang.String"
		resultType="com.zebone.nhis.common.module.bl.BlSettle">
		select top 1 *
		from bl_settle
		where del_flag = '0' and pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
		order by date_st
	</select>
	<!-- 根据操作员获取时间最早的结算记录 -->
	<select id="getLastStByPkEmp" parameterType="java.lang.String"
		resultType="com.zebone.nhis.common.module.bl.BlSettle">
		select t.*
		from(
		select *
		from bl_settle
		where del_flag = '0' and pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
		order by date_st) t
		where rownum = 1
	</select>

	<select id="cancelData" parameterType="java.lang.String"
		resultType="java.util.Map">
		select count(1) cnt from bl_cc cc where cc.eu_cctype = 8 and
		cc.date_cc &gt; (select blcc.date_cc from bl_cc blcc
		where blcc.pk_cc = #{pkCc,jdbcType=VARCHAR} and
		blcc.pk_emp_opera=cc.pk_emp_opera and blcc.eu_cctype = 8)
	</select>
	<select id="getBlCcDepoDetail" parameterType="java.lang.String"
		resultType="com.zebone.nhis.bl.pub.vo.BlCcDepoDetail">
		select * from (
		select st.pk_settle,
		pi.code_ip,
		pi.name_pi,
		st.code_st,
		st.amount_st,
		inv.amount_inv,
		st.date_st,
		inv.code_inv,
		st.flag_canc,
		st.pk_settle_canc,
		case when inv.pk_cc=inv.pk_cc_cancel then '1' else '0' end flag,
		st.eu_stresult
		from bl_settle st
		inner join pi_master pi on st.pk_pi=pi.pk_pi
		inner join bl_st_inv stinv on st.pk_settle=stinv.pk_settle
		inner join bl_invoice inv on stinv.pk_invoice=inv.pk_invoice
		where inv.pk_cc=#{pkCc,jdbcType=VARCHAR}
		union
		select st.pk_settle,
		pi.code_ip,
		pi.name_pi,
		st.code_st,
		st.amount_st,
		inv.amount_inv,
		st.date_st,
		inv.code_inv,
		st.flag_canc,
		st.pk_settle_canc,
		inv.flag_cancel flag,
		st.eu_stresult
		from bl_settle st
		inner join pi_master pi on st.pk_pi=pi.pk_pi
		inner join bl_st_inv stinv on st.pk_settle=stinv.pk_settle
		inner join bl_invoice inv on stinv.pk_invoice=inv.pk_invoice
		where inv.pk_cc_cancel=#{pkCc,jdbcType=VARCHAR}
		) stInfo
		order by stInfo.DATE_ST,flag asc
	</select>
	<select id="getBlCcStDetail" parameterType="java.lang.String"
		resultType="com.zebone.nhis.bl.pub.vo.BlCcStDetail">
		select
		depo.pk_depo,pi.code_pi,pi.name_pi,depo.amount,pi.code_ip,
		paymode.name
		paymode,depo.rept_no,depo.date_pay,depo.eu_direct,depo.pk_depo_back,depo.note,depo.eu_dptype
		from bl_deposit depo
		inner join pi_master pi on depo.pk_pi=pi.pk_pi
		inner join bd_defdoc paymode on depo.dt_paymode=paymode.code and
		paymode.code_defdoclist='110100'
		where depo.eu_dptype in (3,9) and depo.pk_cc = #{pkCc,jdbcType=VARCHAR}
		order by depo.date_pay asc
	</select>
	<select id="getBlCcStGetDetail" parameterType="java.lang.String"
		resultType="com.zebone.nhis.bl.pub.vo.BlCcStGetDetail">
		select hp.name hp,payer.name payer,dt.amount
		from bl_settle st
		inner join bl_settle_detail dt on st.pk_settle=dt.pk_settle
		left outer join bd_hp hp on dt.pk_insurance = hp.pk_hp
		left outer join bd_payer payer on dt.pk_payer=payer.pk_payer
		where dt.amount &gt;0 and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
	</select>



	<select id="getBlCcDepoDetail_Unclose" parameterType="java.util.Map"
		resultType="com.zebone.nhis.bl.pub.vo.BlCcDepoDetail">
		select st.pk_settle,
		pi.code_ip,
		pi.name_pi,
		st.code_st,
		st.amount_st,
		inv.amount_inv,
		st.date_st,
		inv.code_inv,
		st.flag_canc,
		st.pk_settle_canc,
		case when inv.date_cancel &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
		'yyyymmddhh24miss') then '1' else '0' end flag,
		st.eu_stresult
		from bl_settle st
		inner join pi_master pi on st.pk_pi=pi.pk_pi
		inner join bl_st_inv stinv on st.pk_settle=stinv.pk_settle
		inner join bl_invoice inv on stinv.pk_invoice=inv.pk_invoice
		where st.eu_pvtype = 3 and st.flag_cc = 0
		<if test="pkEmp != null  and  pkEmp != ''">
			and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="pkOrg != null  and  pkOrg != ''">
			and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null  and  dateEnd != ''">
			and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
		order by st.date_st,flag asc

	</select>
	<select id="getBlCcStDetail_Unclose" parameterType="java.util.Map"
		resultType="com.zebone.nhis.bl.pub.vo.BlCcStDetail">
		select depo.pk_depo,pi.code_pi,pi.name_pi,pi.code_ip,depo.amount,
		paymode.name paymode,depo.rept_no,depo.date_pay,
		depo.eu_direct,depo.pk_depo_back,depo.eu_dptype
		from bl_deposit depo inner join pi_master pi on depo.pk_pi=pi.pk_pi
		inner join bd_defdoc paymode on depo.dt_paymode=paymode.code and
		paymode.code_defdoclist='110100'
		where depo.eu_dptype in (3,9) and depo.flag_cc = 0 

		<if test="pkEmp != null  and  pkEmp != ''">
			and depo.pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="pkOrg != null  and  pkOrg != ''">
			and depo.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null  and  dateEnd != ''">
			and depo.date_pay &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
		order by depo.date_pay asc
	</select>
	<select id="getBlCcStGetDetail_Unclose" parameterType="java.util.Map"
		resultType="com.zebone.nhis.bl.pub.vo.BlCcStGetDetail">
		select hp.name hp,payer.name payer,dt.amount
		from bl_settle st
		inner join bl_settle_detail dt on st.pk_settle=dt.pk_settle
		left outer join bd_hp hp on dt.pk_insurance = hp.pk_hp
		left outer join bd_payer payer on dt.pk_payer=payer.pk_payer
		where st.eu_pvtype = 3 and st.flag_cc = 0
		<if test="pkEmp != null  and  pkEmp != ''">
			and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="pkOrg != null  and  pkOrg != ''">
			and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null  and  dateEnd != ''">
			and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
	</select>

	<update id="updSumCc" parameterType="java.util.Map">
		update bl_cc set flag_leader = 1,
		pk_emp_leader = #{pkEmp,jdbcType=VARCHAR},
		name_emp_leader = #{nameEmp,jdbcType=VARCHAR},
		date_leader = #{dateCc,jdbcType=TIMESTAMP},
		eu_status = 1
		where pk_org = #{pkOrg,jdbcType=VARCHAR}
		and eu_cctype = 8 and flag_leader = 0 and
		date_end &lt;= to_date(#{dateLeader,jdbcType=VARCHAR}, 'yyyymmddhh24miss')
	</update>

	<select id="cancelSumData" parameterType="java.util.Map"
		resultType="java.util.Map">
		select count(1) cnt from bl_cc cc
		where cc.pk_org = #{pkOrg,jdbcType=VARCHAR}
		and cc.eu_cctype = 8 and cc.flag_leader = 1
		and cc.pk_emp_leader = #{pkEmp,jdbcType=VARCHAR}
		and cc.date_leader &gt; to_date(#{dateLeader,jdbcType=VARCHAR},
		'yyyymmddhh24miss')
	</select>

	<update id="updCancelSumCc" parameterType="java.util.Map">
		update bl_cc set flag_leader = 0,pk_emp_leader = null,
		name_emp_leader = null, date_leader = null,eu_status = 0
		where pk_org = #{pkOrg,jdbcType=VARCHAR}
		and pk_emp_leader = #{pkEmp,jdbcType=VARCHAR}
		and date_leader = to_date(#{dateLeader,jdbcType=VARCHAR},
		'yyyymmddhh24miss')
		and eu_cctype = 8 and flag_leader = 1

	</update>
	<select id="QrySumDepo" parameterType="java.util.Map"
		resultType="com.zebone.nhis.bl.pub.vo.BlSumDepoVo">

		select cc.pk_emp_opera,cc.name_emp_opera,sum(cc.amt_settle) amt_settle,
		sum(cc.amt_prep) amt_prep,sum(cc.amt_prep_rt)
		amt_prep_rt,sum(cc.amt_insu) amt_insu,sum(pay.amt_pay) amt_pay
		from bl_cc cc
		Inner Join (Select pk_cc,
                     sum(amt+amt_back) amt_pay
              From bl_cc_pay
              Where dt_paymode='1'
              Group By pk_cc ) pay On cc.pk_cc=pay.pk_cc
		where cc.eu_cctype = 8 and
		cc.flag_leader = 1
		and cc.pk_org = #{pkOrg,jdbcType=VARCHAR}
		and cc.pk_emp_leader = #{pkEmp,jdbcType=VARCHAR}
		and cc.date_leader = to_date(#{dateLeader,jdbcType=VARCHAR},
		'yyyymmddhh24miss')
		group by cc.pk_emp_opera,
		cc.name_emp_opera
	</select>
	<select id="QrySumPay" parameterType="java.util.Map"
		resultType="com.zebone.nhis.bl.pub.vo.BlSumPayVo">

		select sum(pay.amt) amt,sum(pay.amt_back)
		amt_back,pay.dt_paymode,pay.eu_paytype,paymode.name paymode
		from bl_cc_pay pay
		inner join bl_cc cc on pay.pk_cc=cc.pk_cc
		inner join bd_defdoc paymode on pay.dt_paymode=paymode.code and
		paymode.code_defdoclist='110100'
		where cc.eu_cctype = 8 and
		cc.flag_leader = 1
		and cc.pk_org = #{pkOrg,jdbcType=VARCHAR}
		and cc.pk_emp_leader = #{pkEmp,jdbcType=VARCHAR}
		and cc.date_leader = to_date(#{dateLeader,jdbcType=VARCHAR},
		'yyyymmddhh24miss')
		group by pay.dt_paymode,
		paymode.name,
		pay.eu_paytype

	</select>

	<select id="QrySumRecords" parameterType="java.util.Map"
		resultType="com.zebone.nhis.bl.pub.vo.BlSumRecords">

		select cc.date_leader, min(cc.date_begin) date_begin,max(cc.date_end)
		date_end, cc.eu_status
		from bl_cc cc
		where cc.eu_cctype = 8 and cc.flag_leader = 1
		and cc.pk_org = #{pkOrg,jdbcType=VARCHAR}
		and cc.pk_emp_leader = #{pkEmp,jdbcType=VARCHAR}
		and cc.date_leader &gt;= to_date(#{dateBegin,jdbcType=VARCHAR},
		'yyyymmddhh24miss')
		and cc.date_leader &lt; to_date(#{dateEnd,jdbcType=VARCHAR},
		'yyyymmddhh24miss')
		group by cc.date_leader,cc.eu_status

	</select>


	<select id="QryUnSumDepo" parameterType="java.util.Map"
		resultType="com.zebone.nhis.bl.pub.vo.BlSumDepoVo">
		select cc.pk_emp_opera,cc.name_emp_opera,sum(cc.amt_settle) amt_settle,
		sum(cc.amt_prep) amt_prep,sum(cc.amt_prep_rt)
		amt_prep_rt,sum(cc.amt_insu) amt_insu,sum(cc.amt_ar)
		amt_ar,sum(cc.amt_repair) amt_repair
		,sum(cc.amt_sor) amt_sor,sum(cc.amt_ca) amt_ca,sum(pay.amt_pay) amt_pay
		from bl_cc cc
		Inner Join (Select pk_cc,
                     sum(amt+amt_back) amt_pay
              From bl_cc_pay
              Where dt_paymode='1'  
              Group By pk_cc ) pay On cc.pk_cc=pay.pk_cc
		where cc.eu_cctype = 8 and
		(cc.flag_leader = '0' or cc.flag_leader is null)
		and cc.pk_org = #{pkOrg,jdbcType=VARCHAR}
		and cc.date_cc &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
		'yyyymmddhh24miss')
		group by cc.pk_emp_opera,
		cc.name_emp_opera
	</select>
	<select id="QryUnSumPay" parameterType="java.util.Map"
		resultType="com.zebone.nhis.bl.pub.vo.BlSumPayVo">

		select sum(pay.amt) amt,sum(pay.amt_back)
		amt_back,pay.dt_paymode,pay.eu_paytype,paymode.name paymode
		from bl_cc_pay pay
		inner join bl_cc cc on pay.pk_cc=cc.pk_cc
		inner join bd_defdoc paymode on pay.dt_paymode=paymode.code and
		paymode.code_defdoclist='110100'
		where cc.eu_cctype = 8 and
		(cc.flag_leader = '0' or cc.flag_leader is null)
		and cc.pk_org = #{pkOrg,jdbcType=VARCHAR}
		and cc.date_cc &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
		'yyyymmddhh24miss')
		group by pay.dt_paymode,
		paymode.name,
		pay.eu_paytype

	</select>
	<select id="QryUnSumInfo" parameterType="java.util.Map"
		resultType="com.zebone.nhis.bl.pub.vo.BlSumRecords">
		select min(date_begin)
		from bl_cc cc
		where cc.eu_cctype = 8 and
		(cc.flag_leader = '0' or cc.flag_leader is null)
		and cc.pk_org = '~ '
		and cc.date_cc &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
		'yyyymmddhh24miss')
	</select>

	<select id="QrySumInfo" parameterType="java.util.Map"
		resultType="com.zebone.nhis.bl.pub.vo.BlSumRecords">
		select min(cc.date_begin) date_begin,max(cc.date_end) date_end
		from bl_cc cc
		where cc.eu_cctype = 8 and cc.flag_leader = 1
		and cc.pk_org = #{pkOrg,jdbcType=VARCHAR}
		and cc.pk_emp_leader = #{pkEmp,jdbcType=VARCHAR}
		and cc.date_leader = to_date(#{dateLeader,jdbcType=VARCHAR},
		'yyyymmddhh24miss')

	</select>

	<select id="getEuStatus" parameterType="java.util.Map"
		resultType="com.zebone.nhis.common.module.bl.BlCc">
		select cc.date_cc,
		cc.date_begin,
		cc.date_end,
		cc.eu_status,
		cc.pk_cc
		from bl_cc cc
		where cc.eu_cctype = 8 and cc.pk_org =
		#{pkOrg,jdbcType=VARCHAR}
		and cc.pk_cc = #{pkCc,jdbcType=VARCHAR}

	</select>

	<!-- 根据操作员获取时间最早的预交金记录（sqlserver） -->
	<select id="getLastPreByPkEmpForSql" parameterType="java.lang.String"
		resultType="com.zebone.nhis.common.module.bl.BlDeposit">
		select top 1 *
		from BL_DEPOSIT
		where DEL_FLAG = '0' and PK_EMP_PAY = #{pkEmp,jdbcType=VARCHAR}
		order by date_pay
	</select>
	<!-- 根据操作员获取时间最早的预交金记录 -->
	<select id="getLastPreByPkEmp" parameterType="java.lang.String"
		resultType="com.zebone.nhis.common.module.bl.BlDeposit">
		select t.*
		from(
		select *
		from BL_DEPOSIT
		where DEL_FLAG = '0' and PK_EMP_PAY = #{pkEmp,jdbcType=VARCHAR}
		order by date_pay) t
		where rownum = 1
	</select>
	<select id="qryStAmtAr" resultType="java.lang.Double">
		select sum(AMT_AR) amt_ar from BL_SETTLE_AR star
		left join BL_SETTLE st on st.PK_SETTLE = star.PK_SETTLE
		where not
		exists(select canst.PK_SETTLE_CANC from BL_SETTLE canst where
		canst.PK_SETTLE_CANC = st.PK_SETTLE)
		<if test="pkOrg != null and pkOrg != ''">
			and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
		<if test="pkCc!=null and pkCc!= ''">
			and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
		</if>
	</select>

	<select id="qrySettleAmtAr" resultType="java.lang.Double">
		select sum(st.amt_ar) amt_ar
		from bl_settle_ar st
		where st.flag_cc = 0
		<if test="pkOrg != null and pkOrg != ''">
			and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and st.pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and st.date_pay &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
	</select>

	<select id="qrySettleAmtArFee" resultType="java.lang.Double">
		select sum(depo.amount) amt_arfee
		from bl_deposit depo
		inner join bl_settle st on st.pk_settle = depo.pk_settle and st.flag_canc =
		'0'
		where depo.eu_dptype = 3 and depo.flag_cc = 0 
		<if test="pkOrg != null and pkOrg != ''">
			and depo.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and depo.pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and depo.date_pay &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
	</select>

	<select id="qrySettleAmtSor" resultType="java.lang.Double">
		select sum(amt_sor) as amt_sor from (
		select sum(st.amount_pi-st.amount_prep) amt_sor
		from bl_settle st
		where
		st.flag_cc='0' and st.eu_prest='1'
		<if test="pkEmp != null and pkEmp != ''">
			and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
		<if test="pkOrg != null and pkOrg != ''">
			and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		union
		select sum(st.amount_pi-st.amount_prep) amt_sor
		from bl_settle st
		where st.flag_cc='0' and st.eu_prest='9'
		<if test="pkEmp != null and pkEmp != ''">
			and st.pk_emp_st=#{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and st.date_st &lt;=to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
		) st
	</select>

	<select id="qrySettleAmtCa" resultType="java.lang.Double">
		select sum(dp.amount) amt_ca
		from bl_deposit dp
		inner join bl_settle st on dp.pk_settle=st.pk_settle
		where dp.eu_dptype='0' and
		dp.flag_cc='0' and
		st.eu_prest>'0'
		<if test="pkOrg != null and pkOrg != ''">
			and dp.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmp != null and pkEmp != ''">
			and dp.pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}
		</if>
		<if test="dateEnd != null and dateEnd != ''">
			and dp.date_pay &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
	</select>
	<select id="qryReceiptsData" parameterType="java.lang.String"
		resultType="com.zebone.nhis.common.module.bl.BlDeposit">
		select * from bl_deposit depo
		where depo.eu_dptype = 9 and depo.flag_cc_rept ='0' and depo.rept_no is not null
		<if test="pkOrg != null and pkOrg != ''">
			and depo.pk_org = #{pkOrg,jdbcType=VARCHAR}
		</if>
		<if test="pkEmpRept != null and pkEmpRept != ''">
			and depo.pk_emp_rept = #{pkEmpRept,jdbcType=VARCHAR}
		</if>
		<if test="dateRept != null and dateRept != ''">
			and depo.date_rept &lt;= to_date(#{dateRept,jdbcType=VARCHAR},
			'yyyymmddhh24miss')
		</if>
	</select>
	
	<select id="qryAmtStPrep" resultType="DynaBean">
		select sum(stc.amt_st_prep) amt_st_prep from (
		select
		  sum(CASE WHEN amount_pi - amount_prep &lt;= 0 THEN amount_pi ELSE amount_prep END) amt_st_prep
		from BL_SETTLE where amount_st &gt;= 0
		<if test="pkCc != null and pkCc != ''">
			and pk_cc = #{pkCc,jdbcType=VARCHAR}
		</if>
		<if test="pkCc == null or pkCc == ''">
			and flag_cc = '0'
			<if test="pkOrg != null and pkOrg != ''">
				and pk_org = #{pkOrg,jdbcType=VARCHAR}
			</if>
			<if test="pkEmp != null and pkEmp != ''">
				and pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
			</if>
			<if test="dateEnd != null and dateEnd != ''">
				and date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
				'yyyymmddhh24miss')
			</if>
		</if>
		union all
				SELECT sum(CASE WHEN amount_pi - amount_prep &lt;= amount_prep THEN  amount_prep ELSE amount_pi END) amt_st_prep
		FROM BL_SETTLE where  amount_st &lt; 0
		<if test="pkCc != null and pkCc != ''">
			and pk_cc = #{pkCc,jdbcType=VARCHAR}
		</if>
		<if test="pkCc == null or pkCc == ''">
			and flag_cc = '0'
			<if test="pkOrg != null and pkOrg != ''">
				and pk_org = #{pkOrg,jdbcType=VARCHAR}
			</if>
			<if test="pkEmp != null and pkEmp != ''">
				and pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
			</if>
			<if test="dateEnd != null and dateEnd != ''">
				and date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
				'yyyymmddhh24miss')
			</if>
		</if>
		) stc
	</select>
	
	<select id="qryPayListSd" resultType="com.zebone.nhis.bl.pub.vo.PayInfoSd">
		select payinfo.pay_type,payinfo.name_pay pay_Name,sum(payinfo.amount) debit_Amt,sum(0) credit_Amt from (
			select depo.DT_PAYMODE pay_type,doc.ba_code,doc.name name_pay,depo.amount
					from bl_deposit depo
			      inner join bd_defdoc doc on doc.code = depo.dt_paymode and doc.DEL_FLAG = '0' and doc.CODE_DEFDOCLIST = '110100'
					where depo.eu_pvtype='3'
					<if test="pkCc != null and pkCc != ''">
						 and depo.pk_cc = #{pkCc,jdbcType=VARCHAR}
					</if>
					<if test="pkCc == null or pkCc == ''">
						 and depo.flag_cc = 0
						<if test="pkOrg != null and pkOrg != ''">
							and depo.pk_org = #{pkOrg,jdbcType=VARCHAR}
						</if>
						<if test="pkEmp != null and pkEmp != ''">
							and depo.pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}
						</if>
						<if test="dateEnd != null and dateEnd != ''">
							and depo.date_pay &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},'yyyymmddhh24miss')
						</if>
					</if>
			union all
			  select doc.code pay_type,doc.ba_code,doc.name name_pay,0 amount
			    from bd_defdoc doc
			  where doc.DEL_FLAG = '0' and doc.CODE_DEFDOCLIST = '110100' and doc.val_attr like '%3%'
		) payinfo
		 group by payinfo.pay_type,payinfo.name_pay,payinfo.ba_code order by payinfo.ba_code asc
	</select>
	
	<select id="qryInsuPayInfoSd" resultType="DynaBean">
		select ybst.code,sum(ybst.tczf) tczf,sum(ybst.grzf) grzf from (
			select '07' code,
			  case when sum(city.amt_jjzf) is null then 0 else sum(city.amt_jjzf) end tczf,
			  case when sum(city.amt_grzhzf) is null then 0 else sum(city.amt_grzhzf) end grzf
			from ins_szyb_st_city city
			  inner join ins_szyb_st ybst on ybst.pk_insst = city.pk_insst
			  inner join bl_settle st on st.pk_settle = ybst.pk_settle
			  inner join PV_ENCOUNTER pv on pv.pk_pv = st.pk_pv
			  inner join bd_hp hp on hp.pk_hp = st.pk_insurance
			  inner join bd_hp fahp on fahp.pk_hp = hp.PK_PARENT
			where fahp.code = '07'
				<if test="pkCc != null and pkCc != ''">
					and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
				</if>
				<if test="pkCc == null or pkCc == ''">
					 and st.flag_cc = '0'
					<if test="pkOrg != null and pkOrg != ''">
						and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
					</if>
					<if test="pkEmp != null and pkEmp != ''">
						and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
					</if>
					<if test="dateEnd != null and dateEnd != ''">
						and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
						'yyyymmddhh24miss')
					</if>
				</if>
			union all
			select '05' code,
			  case when sum(city.akb068) is null then 0 else sum(city.akb068) end tczf,
			  case when sum(city.akb066) is null then 0 else sum(city.akb066) end grzf
			from ins_szyb_st_diff city
			  inner join ins_szyb_st ybst on ybst.pk_insst = city.pk_insst
			  inner join bl_settle st on st.pk_settle = ybst.pk_settle
			  inner join PV_ENCOUNTER pv on pv.pk_pv = st.pk_pv
			  inner join bd_hp hp on hp.pk_hp = st.pk_insurance
			  left join bd_hp fahp on fahp.pk_hp = hp.PK_PARENT
			where (fahp.code = '05' or hp.code = '05')
				<if test="pkCc != null and pkCc != ''">
					and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
				</if>
				<if test="pkCc == null or pkCc == ''">
					 and st.flag_cc = '0'
					<if test="pkOrg != null and pkOrg != ''">
						and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
					</if>
					<if test="pkEmp != null and pkEmp != ''">
						and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
					</if>
					<if test="dateEnd != null and dateEnd != ''">
						and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
						'yyyymmddhh24miss')
					</if>
				</if>
			union all
			select '06' code,
			  case sum(city.akb068) when  null then  0 else sum(city.akb068) end tczf,
			  case sum(city.akb066) when  null then  0 else sum(city.akb066) end grzf
			from ins_szyb_st_diff city
			  inner join ins_szyb_st ybst on ybst.pk_insst = city.pk_insst
			  inner join bl_settle st on st.pk_settle = ybst.pk_settle
			  inner join PV_ENCOUNTER pv on pv.pk_pv = st.pk_pv
			  inner join bd_hp hp on hp.pk_hp = st.pk_insurance
			  left join bd_hp fahp on fahp.pk_hp = hp.PK_PARENT
			where (fahp.code = 'Z06' or hp.code = 'Z06') 
				<if test="pkCc != null and pkCc != ''">
					and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
				</if>
				<if test="pkCc == null or pkCc == ''">
					 and st.flag_cc = '0'
					<if test="pkOrg != null and pkOrg != ''">
						and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
					</if>
					<if test="pkEmp != null and pkEmp != ''">
						and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
					</if>
					<if test="dateEnd != null and dateEnd != ''">
						and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
						'yyyymmddhh24miss')
					</if>
				</if>
			union all
			select '07' code,
			  case when sum(city.amt_jjzf) is null then 0 else sum(city.amt_jjzf) end *-1 tczf,
			  case when sum(city.amt_grzhzf) is null then 0 else sum(city.amt_grzhzf) end *-1 grzf
			from ins_szyb_st_city city
			  inner join ins_szyb_st ybst on ybst.pk_insst = city.pk_insst
			  inner join (
		          select bl_st.pk_settle,bl_st.pk_insurance,st_cal.pk_cc,bl_st.pk_pv,st_cal.date_st,st_cal.pk_emp_st,st_cal.flag_cc,st_cal.pk_org from bl_settle bl_st
			      inner join bl_settle st_cal on st_cal.pk_settle_canc = bl_st.pk_settle
			    where st_cal.dt_sttype = '21'
		        ) st on st.pk_settle = ybst.pk_settle
			  inner join PV_ENCOUNTER pv on pv.pk_pv = st.pk_pv
			  inner join bd_hp hp on hp.pk_hp = st.pk_insurance
			  inner join bd_hp fahp on fahp.pk_hp = hp.PK_PARENT
			where fahp.code = '07'
				<if test="pkCc != null and pkCc != ''">
					and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
				</if>
				<if test="pkCc == null or pkCc == ''">
					 and st.flag_cc = '0'
					<if test="pkOrg != null and pkOrg != ''">
						and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
					</if>
					<if test="pkEmp != null and pkEmp != ''">
						and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
					</if>
					<if test="dateEnd != null and dateEnd != ''">
						and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
						'yyyymmddhh24miss')
					</if>
				</if>
				union all
			select '05' code,
			  case when sum(city.akb068) is null then 0 else sum(city.akb068) end *-1 tczf,
			  case when sum(city.akb066) is null then 0 else sum(city.akb066) end *-1 grzf
			from ins_szyb_st_diff city
			  inner join ins_szyb_st ybst on ybst.pk_insst = city.pk_insst
			  inner join (
			  	select bl_st.pk_settle,bl_st.pk_insurance,st_cal.pk_cc,bl_st.pk_pv,st_cal.date_st,st_cal.pk_emp_st,st_cal.flag_cc,st_cal.pk_org from bl_settle bl_st
			      inner join bl_settle st_cal on st_cal.pk_settle_canc = bl_st.pk_settle
			    where st_cal.dt_sttype = '21'
			  ) st on st.pk_settle = ybst.pk_settle
			  inner join PV_ENCOUNTER pv on pv.pk_pv = st.pk_pv
			  inner join bd_hp hp on hp.pk_hp = st.pk_insurance
			  left join bd_hp fahp on fahp.pk_hp = hp.PK_PARENT
			where (fahp.code = '05' or hp.code = '05')
				<if test="pkCc != null and pkCc != ''">
					and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
				</if>
				<if test="pkCc == null or pkCc == ''">
					 and st.flag_cc = '0'
					<if test="pkOrg != null and pkOrg != ''">
						and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
					</if>
					<if test="pkEmp != null and pkEmp != ''">
						and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
					</if>
					<if test="dateEnd != null and dateEnd != ''">
						and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
						'yyyymmddhh24miss')
					</if>
				</if>
			union all
			select '06' code,
			  case sum(city.akb068) when  null then  0 else sum(city.akb068) end *-1 tczf,
			  case sum(city.akb066) when  null then  0 else sum(city.akb066) end *-1 grzf
			from ins_szyb_st_diff city
			  inner join ins_szyb_st ybst on ybst.pk_insst = city.pk_insst
			  inner join (
			  	select bl_st.pk_settle,bl_st.pk_insurance,st_cal.pk_cc,bl_st.pk_pv,st_cal.date_st,st_cal.pk_emp_st,st_cal.flag_cc,st_cal.pk_org from bl_settle bl_st
			      inner join bl_settle st_cal on st_cal.pk_settle_canc = bl_st.pk_settle
			    where st_cal.dt_sttype = '21'
			  ) st on st.pk_settle = ybst.pk_settle
			  inner join PV_ENCOUNTER pv on pv.pk_pv = st.pk_pv
			  inner join bd_hp hp on hp.pk_hp = st.pk_insurance
			  left join bd_hp fahp on fahp.pk_hp = hp.PK_PARENT
			where (fahp.code = 'Z06' or hp.code = 'Z06')
				<if test="pkCc != null and pkCc != ''">
					and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
				</if>
				<if test="pkCc == null or pkCc == ''">
					 and st.flag_cc = '0'
					<if test="pkOrg != null and pkOrg != ''">
						and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
					</if>
					<if test="pkEmp != null and pkEmp != ''">
						and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
					</if>
					<if test="dateEnd != null and dateEnd != ''">
						and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
						'yyyymmddhh24miss')
					</if>
				</if>
		) ybst group by ybst.code
	</select>

	<select id="qryQgInsuPayInfoSd" resultType="DynaBean">
		select sum(tczf) tczf,sum(grzf) grzf from (
			select
				sum(ybst.acct_pay) grzf,
				sum(ybst.medfee_sumamt-ybst.PSN_CASH_PAY-ybst.ACCT_PAY)  tczf
			from ins_qgyb_st ybst
				inner join bl_settle st on st.pk_settle = ybst.pk_settle
				inner join bd_hp hp on hp.pk_hp = st.pk_insurance
			where hp.DT_EXTHP = '01'
				<if test="pkCc != null and pkCc != ''">
					and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
				</if>
				<if test="pkCc == null or pkCc == ''">
					and st.flag_cc = '0'
					<if test="pkOrg != null and pkOrg != ''">
						and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
					</if>
					<if test="pkEmp != null and pkEmp != ''">
						and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
					</if>
					<if test="dateEnd != null and dateEnd != ''">
						and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
						'yyyymmddhh24miss')
					</if>
				</if>
			union all
			select
				sum(ybst.acct_pay) * -1  grzf,
				sum(ybst.medfee_sumamt-ybst.PSN_CASH_PAY-ybst.ACCT_PAY) *-1 tczf
			from ins_qgyb_st ybst
				inner join (
					select bl_st.pk_settle,bl_st.pk_insurance,st_cal.pk_cc,bl_st.pk_pv,st_cal.date_st,st_cal.pk_emp_st,st_cal.flag_cc,st_cal.pk_org from bl_settle bl_st
						inner join bl_settle st_cal on st_cal.pk_settle_canc = bl_st.pk_settle
					where st_cal.dt_sttype = '21'
				) st on st.pk_settle = ybst.pk_settle
				inner join bd_hp hp on hp.pk_hp = st.pk_insurance
			where hp.DT_EXTHP = '01'
				<if test="pkCc != null and pkCc != ''">
					and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
				</if>
				<if test="pkCc == null or pkCc == ''">
					and st.flag_cc = '0'
					<if test="pkOrg != null and pkOrg != ''">
						and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
					</if>
					<if test="pkEmp != null and pkEmp != ''">
						and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
					</if>
					<if test="dateEnd != null and dateEnd != ''">
						and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
						'yyyymmddhh24miss')
					</if>
				</if>
		)
	</select>

	<select id="qryQgOpInsuPayInfoSd" resultType="DynaBean">
		select sum(tczf) tczf,sum(grzf) grzf from (
		select
		sum(ybst.acct_pay) grzf,
		sum(ybst.medfee_sumamt-ybst.PSN_CASH_PAY-ybst.ACCT_PAY) tczf
		from ins_qgyb_st ybst
		inner join bl_settle st on st.pk_settle = ybst.pk_settle
		inner join bd_hp hp on hp.pk_hp = st.pk_insurance
		where hp.DT_EXTHP = '01' and st.eu_pvtype in (1,2,4)
		<if test="pkCc != null and pkCc != ''">
			and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
		</if>
		<if test="pkCc == null or pkCc == ''">
			and st.flag_cc = '0'
			<if test="pkOrg != null and pkOrg != ''">
				and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
			</if>
			<if test="pkEmp != null and pkEmp != ''">
				and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
			</if>
			<if test="dateEnd != null and dateEnd != ''">
				and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
				'yyyymmddhh24miss')
			</if>
			<if test=' euCctype=="1"'>
				and (st.dt_sttype='00' or st.DT_STTYPE = '20')
			</if>
			<if test=' euCctype=="2"'>
				and (st.dt_sttype='01' or st.DT_STTYPE = '21')
			</if>
		</if>
		union all
		select
		sum(ybst.acct_pay) * -1 grzf,
		sum(ybst.medfee_sumamt-ybst.PSN_CASH_PAY-ybst.ACCT_PAY) *-1 tczf
		from ins_qgyb_st ybst
		inner join (
			select bl_st.pk_settle,bl_st.pk_insurance,st_cal.pk_cc,bl_st.pk_pv,st_cal.date_st,st_cal.pk_emp_st,st_cal.flag_cc,st_cal.pk_org from bl_settle bl_st
				inner join bl_settle st_cal on st_cal.pk_settle_canc = bl_st.pk_settle
			where bl_st.eu_pvtype in (1,2,4)
				<if test=' euCctype=="1"'>
					and (bl_st.dt_sttype='00' or bl_st.DT_STTYPE = '20')
				</if>
				<if test=' euCctype=="2"'>
					and (bl_st.dt_sttype='01' or bl_st.DT_STTYPE = '21')
				</if>
		) st on st.pk_settle = ybst.pk_settle
		inner join bd_hp hp on hp.pk_hp = st.pk_insurance
		where hp.DT_EXTHP = '01'
		<if test="pkCc != null and pkCc != ''">
			and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
		</if>
		<if test="pkCc == null or pkCc == ''">
			and st.flag_cc = '0'
			<if test="pkOrg != null and pkOrg != ''">
				and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
			</if>
			<if test="pkEmp != null and pkEmp != ''">
				and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
			</if>
			<if test="dateEnd != null and dateEnd != ''">
				and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
				'yyyymmddhh24miss')
			</if>
		</if>
		)
	</select>
	
	<select id="qryPrepBackCnt" resultType="java.lang.Integer">
		select sum(case when eu_direct=1 then 0 else 1 end) cnt_back_depo
		from bl_deposit depo
		where depo.eu_dptype = 9 
		<if test="pkCc != null and pkCc != ''">
			and depo.pk_cc = #{pkCc,jdbcType=VARCHAR}
		</if>
		<if test="pkCc == null or pkCc == ''">
			 and depo.flag_cc = 0 
			<if test="pkOrg != null and pkOrg != ''">
				and depo.pk_org = #{pkOrg,jdbcType=VARCHAR}
			</if>
			<if test="pkEmp != null and pkEmp != ''">
				and depo.pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}
			</if>
			<if test="dateEnd != null and dateEnd != ''">
				and depo.date_pay &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},'yyyymmddhh24miss')
			</if>
		</if>
	</select>
	
	<select id="qryStCanlCnt" resultType="java.lang.Integer">
		select
			count(inv.code_inv) inv_canl_st
		from bl_invoice inv
		inner join bd_invcate cate on inv.pk_invcate=cate.pk_invcate
		where
		cate.eu_type = '1' and inv.flag_cancel = 1 
		<if test="pkCc != null and pkCc != ''">
			and inv.pk_cc_cancel = #{pkCc,jdbcType=VARCHAR}
		</if>
		<if test="pkCc == null or pkCc == ''">
			 and inv.flag_cc_cancel = 0
			<if test="pkOrg != null and pkOrg != ''">
				and inv.pk_org = #{pkOrg,jdbcType=VARCHAR}
			</if>
			<if test="pkEmp != null and pkEmp != ''">
				and inv.pk_emp_cancel = #{pkEmp,jdbcType=VARCHAR}
			</if>
			<if test="dateEnd != null and dateEnd != ''">
				and inv.date_cancel &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
				'yyyymmddhh24miss')
			</if>
		</if>
	</select>
	
	<select id="qryInvDtAmtList" resultType="DynaBean">
		select invdt.name_bill,sum(amount) amount from (
			SELECT
		        dt.code_bill,
		        dt.name_bill,
		        dt.amount
		      FROM bl_invoice_dt dt INNER JOIN bl_invoice inv ON inv.pk_invoice = dt.pk_invoice
		        INNER JOIN bl_st_inv stinv ON stinv.pk_invoice = inv.pk_invoice
		      WHERE
		      <if test="pkCc != null and pkCc != ''">
		      	inv.pk_cc = #{pkCc,jdbcType=VARCHAR}
		      </if>
		      <if test="pkCc == null or pkCc == ''">
		      	 inv.flag_cc = '0'
	      		 AND inv.pk_emp_inv = #{pkEmp,jdbcType=VARCHAR}
	      		 AND inv.date_inv &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},'yyyymmddhh24miss')
		      </if>
		    union all
		    
		    SELECT
		        dt.code_bill,
		        dt.name_bill,
		        (dt.amount*-1) as amount
		      FROM bl_invoice_dt dt INNER JOIN bl_invoice inv ON inv.pk_invoice = dt.pk_invoice
		        INNER JOIN bl_st_inv stinv ON stinv.pk_invoice = inv.pk_invoice
		      WHERE
		      	<if test="pkCc != null and pkCc != ''">
		      		inv.pk_cc_cancel = #{pkCc,jdbcType=VARCHAR}
		      	</if>
		      	<if test="pkCc == null or pkCc == ''">
		      		inv.flag_cc_cancel = '0'
		       		AND inv.pk_emp_cancel = #{pkEmp,jdbcType=VARCHAR}
	       		 	AND inv.date_cancel &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},'yyyymmddhh24miss')
		      	</if>
		      	 
			union all
			select item.code code_bill,item.name name_bill,0 amount from BD_INVCATE_ITEM item
			  inner join bd_invcate invcate on invcate.pk_invcate = item.pk_invcate
			where invcate.del_flag = '0' and item.DEL_FLAG = '0' and invcate.EU_TYPE = '1'
		) invdt
		group by invdt.name_bill
		order by invdt.name_bill
	</select>
	
	<select id="qryStDepoCnt" resultType="java.lang.Integer">
		select count(1) st_depo_cnt from bl_deposit depo
		  inner join bl_settle st on st.pk_settle = depo.pk_settle
		where depo.eu_dptype = '9' and depo.EU_DIRECT = '1' and not exists (
		  select 1 from bl_deposit back where back.pk_depo_back = depo.pk_depo and back.EU_DPTYPE = '9'
		) 
		<if test="pkCc != null and pkCc != ''">
			and st.pk_cc = #{pkCc,jdbcType=VARCHAR}
		</if>
		<if test="pkCc == null or pkCc == ''">
			and st.flag_cc = '0'
			<if test="pkOrg != null and pkOrg != ''">
				and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
			</if>
			<if test="pkEmp != null and pkEmp != ''">
				and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
			</if>
			<if test="dateEnd != null and dateEnd != ''">
				and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},'yyyymmddhh24miss')
			</if>
		</if>
	</select>
	
	<select id="qryDepoCnt" resultType="java.lang.Integer">
		select count(1) depo_cnt from bl_deposit depo
		where depo.eu_dptype = '9' and depo.EU_DIRECT = '1' and not exists (
		  select 1 from bl_deposit back where back.pk_depo_back = depo.pk_depo and back.EU_DPTYPE = '9'
		    <if test="pkCc != null and pkCc != ''">
				and back.pk_cc = #{pkCc,jdbcType=VARCHAR}
			</if>
			<if test="pkCc == null or pkCc == ''">
				and back.flag_cc = '0'
				<if test="pkOrg != null and pkOrg != ''">
					and back.pk_org = #{pkOrg,jdbcType=VARCHAR}
				</if>
				<if test="pkEmp != null and pkEmp != ''">
					and back.pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}
				</if>
				<if test="dateEnd != null and dateEnd != ''">
					and back.date_pay &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},'yyyymmddhh24miss')
				</if>
			</if>
		)
		<if test="pkCc != null and pkCc != ''">
			and depo.pk_cc = #{pkCc,jdbcType=VARCHAR}
		</if>
		<if test="pkCc == null or pkCc == ''">
			and depo.flag_cc = '0'
			<if test="pkOrg != null and pkOrg != ''">
				and depo.pk_org = #{pkOrg,jdbcType=VARCHAR}
			</if>
			<if test="pkEmp != null and pkEmp != ''">
				and depo.pk_emp_pay = #{pkEmp,jdbcType=VARCHAR}
			</if>
			<if test="dateEnd != null and dateEnd != ''">
				and depo.date_pay &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},'yyyymmddhh24miss')
			</if>
		</if>
	</select>
	
	<select id="qryStInvEBill" resultType="com.zebone.nhis.bl.pub.vo.InvInfo">
		select
			max(tmp.code_inv) endcode,
			min(tmp.code_inv) begincode,
			count(1) cnt
			from (
				SELECT
				inv.pk_invcate,
				inv.EBILLNO code_inv,
				inv.EBILLNO cc
				FROM bl_st_inv stinv
				INNER JOIN bl_invoice inv ON stinv.pk_invoice = inv.pk_invoice
				INNER JOIN bl_settle st ON st.pk_settle = stinv.pk_settle
				WHERE st.eu_pvtype = 3 and inv.EBILLNO is not null 
				<if test="pkCc != null and pkCc != ''">
					and inv.pk_cc_ebill = #{pkCc,jdbcType=VARCHAR}
				</if>
				
				<if test="pkCc == null or pkCc == ''">
					 AND inv.flag_cc_ebill = 0
					<if test="pkOrg != null and pkOrg != ''">
						and inv.pk_org = #{pkOrg,jdbcType=VARCHAR}
					</if>
					<if test="pkEmp != null and pkEmp != ''">
						and inv.pk_emp_ebill = #{pkEmp,jdbcType=VARCHAR}
					</if>
					<if test="dateEnd != null and dateEnd != ''">
						and inv.date_ebill &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
							'yyyymmddhh24miss')
					</if>
				</if>
				order by inv.EBILLNO asc
			) tmp
		group by
		to_number(tmp.cc-rownum)
		order by
		begincode asc
	</select>
	
	<select id="qryStInvEBillCanl" parameterType="java.util.HashMap"
		resultType="com.zebone.nhis.bl.pub.vo.InvalidStInv">
		select inv.pk_invcate,
			inv.pk_empinvoice,
			inv.EBILLNO code_inv
			from bl_invoice inv
			left join bd_invcate cate on inv.pk_invcate=cate.pk_invcate and cate.eu_type = '1'
			where 
			inv.flag_cancel_ebill = '1' and inv.EBILLNO is not null 
			<if test="pkCc != null and pkCc != ''">
				and inv.pk_cc_cancel_ebill = #{pkCc,jdbcType=VARCHAR}
			</if>
			
			<if test="pkCc == null or pkCc == ''">
				 and inv.flag_cc_cancel_ebill = '0' 
				<if test="pkOrg != null and pkOrg != ''">
					and inv.pk_org = #{pkOrg,jdbcType=VARCHAR}
				</if>
				<if test="pkEmp != null and pkEmp != ''">
					and inv.pk_emp_cancel_ebill = #{pkEmp,jdbcType=VARCHAR}
				</if>
				<if test="dateEnd != null and dateEnd != ''">
					and inv.date_ebill_cancel &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},
					'yyyymmddhh24miss')
				</if>
			</if>
		order by inv.code_inv asc
	</select>
	
	<select id="qryCashShortAmt" resultType="java.lang.Double">
		select sum(amount_round) amt_round from bl_settle st
		where 
		<if test="pkCc != null and pkCc != ''">
			st.pk_cc = #{pkCc,jdbcType=VARCHAR}
		</if>
		<if test="pkCc == null or pkCc == ''">
			st.flag_cc = '0'
			<if test="pkOrg != null and pkOrg != ''">
				and st.pk_org = #{pkOrg,jdbcType=VARCHAR}
			</if>
			<if test="pkEmp != null and pkEmp != ''">
				and st.pk_emp_st = #{pkEmp,jdbcType=VARCHAR}
			</if>
			<if test="dateEnd != null and dateEnd != ''">
				and st.date_st &lt;= to_date(#{dateEnd,jdbcType=VARCHAR},'yyyymmddhh24miss')
			</if>
		</if>
	</select>
</mapper>
