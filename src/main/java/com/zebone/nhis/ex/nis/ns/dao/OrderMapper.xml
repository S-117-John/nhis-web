<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zebone.nhis.ex.nis.ns.dao.OrderMapper">
    <select id="queryOrderCheckList" parameterType="java.util.Map"
            resultType="com.zebone.nhis.ex.nis.ns.vo.OrderCheckVo">
        select pv.pk_dept_ns  as                                                      pk_dept_ns_cur,
               pv.bed_no,
               pv.name_pi,
               pv.flag_spec,
               pi.code_ip,
               pi.birth_date,
               newborn.name   as                                                      newborn_name,
               dept.name_dept as                                                      name_dept_exec,
               unitdos.name   as                                                      name_unit_dosage,
               unit.name      as                                                      name_unit,
               us.name        as                                                      name_usage,
               us.pk_supplycate,
               unitcg.name    as                                                      name_unit_cg,
               freq.name      as                                                      name_freq,
               freq.cnt,
               freq.eu_extime,
               def.name       AS                                                      lab_name,
               freq.eu_cycle,
               ord.pk_org,
               ord.pk_dept,
               ord.pk_cnord,
               ord.pk_ord,
               ord.pk_pres,
               ord.pk_pi,
               ord.pk_pv,
               ord.ordsn,
               ord.groupno,
               ord.ordsn_parent,
               ord.name_ord,
               ord.code_ord,
               ord.eu_always,
               ord.eu_status_ord,
               ord.drip_speed,
               ord.date_start,
               ord.code_supply,
               ord.code_freq,
               ord.code_ordtype,
               ord.dosage,
               ord.pk_unit_dos,
               ord.quan,
               ord.pk_unit,
               ord.quan_cg,
               ord.pk_unit_cg,
               ord.price_cg,
               ord.days,
               ord.ords,
               ord.spec,
               ord.infant_no,
               ord.last_num,
               ord.first_num,
               ord.flag_fit,
               ord.desc_fit,
               ord.flag_bl,
               ord.flag_emer,
               ord.flag_first,
               ord.flag_stop,
               ord.flag_erase,
               ord.flag_stop_chk,
               ord.flag_erase_chk,
               ord.flag_durg,
               ord.flag_doctor,
               ord.flag_self,
               ord.flag_base,
               ord.flag_medout,
               ord.flag_note,
               ord.flag_pivas,
               ord.eu_st,
               ord.pk_emp_ord,
               ord.name_emp_ord,
               ord.date_chk,
               ord.pk_emp_chk,
               ord.pk_dept_exec,
               ord.pk_org_exec,
               ord.pack_size,
               ord.date_plan_ex,
               ord.date_stop,
               ord.pk_emp_stop,
               ord.name_emp_stop,
               ord.note_ord,
               ord.ts,
               hp.name                                                                name_hp,
               type.name                                                              name_ordtype,
               pres.eu_boil,
               CASE tt.VAL_ATT WHEN '1' THEN '是' WHEN '0' THEN '' ELSE tt.VAL_ATT END VAL_ATT,
        <!-- 添加用法容器费列，目前只支持oracle数据库 -->
        <if test='dbType == "oracle"'>
            (select wmsys.wm_concat(item.name)
             from CN_LAB_APPLY apply
                          inner join bd_item_defdoc defitem on defitem.CODE_DEFDOC = apply.DT_TUBETYPE
                          inner join bd_item item on item.pk_item = defitem.pk_item
             where defitem.eu_pvtype = '3'
               and defitem.code_defdoclist = '030203'
               and defitem.del_flag = '0'
               and apply.PK_CNORD = ord.pk_cnord
             group by apply.DT_TUBETYPE) as nameTubeItem,
        </if>
        <if test='dbType == "sqlserver"'>
            (select name = (stuff((select ',' + item.name
                                   from CN_LAB_APPLY apply1
                                                inner join bd_item_defdoc defitem on defitem.CODE_DEFDOC = apply1.DT_TUBETYPE
                                                inner join bd_item item on item.pk_item = defitem.pk_item
                                   where defitem.eu_pvtype = '3'
                                     and defitem.code_defdoclist = '030203'
                                     and defitem.del_flag = '0'
                                     and apply1.PK_CNORD = ord.pk_cnord
                                     and apply1.DT_TUBETYPE = applyt.DT_TUBETYPE for xml path ('')), 1, 1, ''))
             from CN_LAB_APPLY applyt
                          inner join bd_item_defdoc defitemt on defitemt.CODE_DEFDOC = applyt.DT_TUBETYPE
                          inner join bd_item itemt on itemt.pk_item = defitemt.pk_item
             where defitemt.eu_pvtype = '3'
               and defitemt.code_defdoclist = '030203'
               and defitemt.del_flag = '0'
               and applyt.PK_CNORD = ord.pk_cnord
             group by applyt.DT_TUBETYPE) as nameTubeItem,
        </if>
        ord.desc_ord,
        pd.dt_injtype
                from cn_order ord
                             left join bd_supply us on ord.code_supply = us.code
                             inner join bd_ou_dept dept on dept.pk_dept = ord.pk_dept_exec and dept.del_flag = '0'
                             inner join pv_encounter pv
                        on ord.pk_pv = pv.pk_pv and pv.eu_pvtype = '3' and pv.flag_in = '1' and pv.del_flag = '0'
                             inner join pi_master pi on pi.pk_pi = pv.pk_pi and pi.del_flag = '0'
                             left join bd_unit unit on unit.pk_unit = ord.pk_unit
                             left join bd_unit unitdos on unitdos.pk_unit = ord.pk_unit_dos
                             left join bd_unit unitcg on unitcg.pk_unit = ord.pk_unit_cg
                             inner join bd_term_freq freq on freq.code = ord.code_freq
                             left join pv_infant newborn on pv.pk_pv = newborn.pk_pv and ord.infant_no = newborn.sort_no
                             left join bd_ordtype type on type.code = ord.code_ordtype and type.del_flag = '0'
                             left join bd_hp hp on hp.pk_hp = pv.pk_insu and hp.del_flag = '0'
                             left join cn_prescription pres on pres.pk_pres = ord.pk_pres and pres.del_flag = '0'
                             left join bd_pd pd on ord.pk_ord = pd.pk_pd and pd.del_flag = '0'
                             LEFT JOIN (select att.*
                                        FROM BD_PD_ATT att
                                                     INNER JOIN BD_PD_ATT_DEFINE de
                                                ON de.PK_PDATTDEF = att.PK_PDATTDEF AND de.DEL_FLAG = '0'
                                        where de.CODE_ATT = 'BA11'
                                          AND att.del_flag = '0'
                                          and att.VAL_ATT is not null) tt
                        ON tt.PK_PD = ord.PK_ORD AND tt.PK_ORG = ord.PK_ORG
                             left join CN_LAB_APPLY lab on lab.pk_cnord = ord.pk_cnord and lab.del_flag = '0'
                             left join BD_DEFDOC def
                        on def.code = lab.dt_samptype and def.del_flag = '0' and def.code_defdoclist = '030200'
                where  ord.pk_pv in
        <foreach collection="pkPvs" item="pkPv" index="index" open="(" close=")" separator=",">
            #{pkPv}
        </foreach>
        <if test="euAlways != null  and euAlways != ''">
            and ord.eu_always = #{euAlways,jdbcType=VARCHAR}
        </if>
        <if test="flagEmer != null  and flagEmer != ''">
            <!-- 加急标志 -->
            and ord.flag_emer = #{flagEmer,jdbcType=CHAR}
        </if>
        <if test="ordtype != null  and ordtype != ''">
            and ord.code_ordtype like #{ordtype,jdbcType=VARCHAR} || '%'
        </if>
        <if test="pkDeptNs != null  and pkDeptNs != ''">
            and ord.pk_dept_ns = #{pkDeptNs,jdbcType=CHAR}
        </if>
        <if test="pkDept != null  and pkDept != ''">
            and ord.pk_dept = #{pkDept,jdbcType=CHAR}
        </if>
        <if test='flagN != "stop"'>
            <!-- 新停医嘱不添加护理医嘱过滤 -->
            and  (ord.flag_doctor = '1' or (ord.flag_doctor = '0' and ord.ordsn_parent != ord.ordsn))
        </if>
        <if test="flagN == null  or  flagN == ''">
            <!-- 未设置新开新停标志时，查询全部 -->
            and  (ord.eu_status_ord = '1'
                    or (ord.eu_status_ord > '1' and ord.flag_stop_chk = '0' and ord.flag_stop = '1' and
                        ord.date_stop is not null and
                        ord.date_stop &lt;= to_date(#{dateStopEnd}, 'YYYYMMDDHH24MISS') and ord.eu_always = '0')
                    or (ord.flag_erase_chk = '0' and ord.flag_erase = '1' and ord.eu_status_ord = '9'))
        </if>
        <if test='flagN == "new"'>
            <!-- 新开或新作废的 -->
            and  ((ord.eu_status_ord = '1' and ord.flag_erase = '0') or
                  (ord.flag_erase_chk = '0' and ord.flag_erase = '1' and ord.eu_status_ord = '9'))
        </if>
        <if test='flagN == "stop"'>
            <!-- 新停 -->
            and ((ord.eu_status_ord = '3' or ord.eu_status_ord = '2') and ord.flag_stop_chk = '0' and
                 ord.flag_stop = '1' and ord.date_stop is not null and
                 ord.date_stop &lt;= to_date(#{dateStopEnd}, 'YYYYMMDDHH24MISS') and ord.eu_always = '0')
        </if>
        <if test='flagN == "other"'>
            <!-- 新停以外的所有待核对医嘱 -->
            and  (ord.eu_status_ord = '1' or
                  (ord.flag_erase_chk = '0' and ord.flag_erase = '1' and ord.eu_status_ord = '9'))
        </if>
        <if test='ordtypeRange == "1" '>
            and  ((ord.eu_always='0' and ord.flag_stop_chk='0') or ( ord.eu_always='1')) and (ord.flag_erase='0')
        </if>
        <if test='ordtypeRange == "2" '><!-- 当天医嘱 -->
            and ( ord.date_start between to_date(#{curDateBegin},'YYYYMMDDHH24MISS') and to_date(#{curDateEnd},'YYYYMMDDHH24MISS'))
        </if>
        <if test='ordtypeRange == "3" '><!-- 3日内医嘱 -->
            and ( ord.date_start between (to_date(#{curDateBegin},'YYYYMMDDHH24MISS'))-2 and (to_date(#{curDateEnd},'YYYYMMDDHH24MISS')) )
        </if>
        <if test='ordtypeRange == "4" '><!-- 10日内医嘱 -->
            and ( ord.date_start between (to_date(#{curDateBegin},'YYYYMMDDHH24MISS'))-9 and (to_date(#{curDateEnd},'YYYYMMDDHH24MISS')) )
        </if>
        <if test='ordtypeRange == "5" '><!-- 当日停止 -->
            and ( ord.date_stop between to_date(#{curDateBegin},'YYYYMMDDHH24MISS') and to_date(#{curDateEnd},'YYYYMMDDHH24MISS'))
        </if>
        <if test='ordtypeRange == "9" '><!-- 当前医嘱 没作废 and  (  当天开立|当天开始 or （长期医嘱并且没有停止核对的） ) -->
            and  ord.flag_erase = '0'
            and ( (ord.date_enter between to_date(#{curDateBegin},'YYYYMMDDHH24MISS') and to_date(#{curDateEnd},'YYYYMMDDHH24MISS'))
            or (ord.date_start between to_date(#{curDateBegin},'YYYYMMDDHH24MISS') and to_date(#{curDateEnd},'YYYYMMDDHH24MISS'))
            or ( ord.date_stop between to_date(#{curDateBegin},'YYYYMMDDHH24MISS') and to_date(#{curDateEnd},'YYYYMMDDHH24MISS'))
            or (ord.eu_always = '0' and ord.flag_stop_chk = '0'))
        </if>
        <if test='ordOrder == "0"'>
            <!-- 排序方式 EX0069 0降序，1升序  默认降序-->
            order by pv.bed_no, ord.date_start desc, nvl(ord.groupno, 0) desc, ord.ordsn_parent,ord.ordsn
        </if>
        <if test='ordOrder == "1"'>
            <!-- 排序方式 EX0069 0降序，1升序  默认降序-->
            order by pv.bed_no, ord.date_start asc, nvl(ord.groupno,0) desc, ord.ordsn_parent,ord.ordsn
        </if>

    </select>
    <!--  查询已核对医嘱列表 -->
    <select id="queryOrderEcList" parameterType="java.util.Map" resultType="com.zebone.nhis.ex.nis.ns.vo.OrderCheckVo">
        select
                pv.pk_dept_ns  as                                                      pk_dept_ns_cur,
                pv.bed_no,
                pv.name_pi,
                unitdos.name   as                                                      name_unit_dosage,
                unit.name      as                                                      name_unit,
                us.name        as                                                      name_usage,
                unitcg.name    as                                                      name_unit_cg,
                freq.name      as                                                      name_freq,
                freq.cnt,
                def.name       AS                                                      lab_name,
                newborn.name   as                                                      newborn_name,
                dept.name_dept as                                                      name_dept_exec,
                type.name                                                              name_ordtype,
                ord.eu_st,
                ord.spec,
                ord.pk_org,
                ord.pk_dept,
                ord.pk_cnord,
                ord.pk_ord,
                ord.pk_pres,
                ord.pk_pi,
                ord.pk_pv,
                ord.ordsn,
                ord.days,
                ord.ords,
                ord.ordsn_parent,
                ord.name_ord,
                ord.code_ord,
                ord.eu_always,
                ord.eu_status_ord,
                ord.drip_speed,
                ord.date_start,
                ord.code_supply,
                ord.code_freq,
                ord.code_ordtype,
                ord.dosage,
                ord.groupno,
                ord.pk_unit_dos,
                ord.quan,
                ord.pk_unit,
                ord.quan_cg,
                ord.price_cg,
                ord.pk_unit_cg,
                ord.infant_no,
                ord.last_num,
                ord.first_num,
                ord.flag_fit,
                ord.desc_fit,
                ord.flag_bl,
                ord.flag_emer,
                ord.flag_first,
                ord.flag_stop,
                ord.flag_erase,
                ord.flag_stop_chk,
                ord.flag_erase_chk,
                ord.flag_durg,
                ord.flag_doctor,
                ord.flag_self,
                ord.flag_note,
                ord.flag_medout,
                ord.flag_pivas,
                ord.flag_base,
                ord.pk_emp_ord,
                ord.name_emp_ord,
                ord.date_chk,
                ord.pk_emp_chk,
                ord.pk_dept_exec,
                ord.date_plan_ex,
                ord.date_stop,
                ord.pk_emp_stop,
                ord.name_emp_stop,
                ord.ts,
                CASE tt.VAL_ATT WHEN '1' THEN '是' WHEN '0' THEN '' ELSE tt.VAL_ATT END VAL_ATT,
        <!-- 添加容器费列 -->
        <if test='dbType == "oracle"'>
            (select wmsys.wm_concat(item.name)
             from CN_LAB_APPLY apply
                          inner join bd_item_defdoc defitem on defitem.CODE_DEFDOC = apply.DT_TUBETYPE
                          inner join bd_item item on item.pk_item = defitem.pk_item
             where defitem.eu_pvtype = '3'
               and defitem.code_defdoclist = '030203'
               and defitem.del_flag = '0'
               and apply.PK_CNORD = ord.pk_cnord
             group by apply.DT_TUBETYPE) as nameTubeItem,
        </if>
        <if test='dbType == "sqlserver"'>
            (select name = (stuff((select ',' + item.name
                                   from CN_LAB_APPLY apply1
                                                inner join bd_item_defdoc defitem on defitem.CODE_DEFDOC = apply1.DT_TUBETYPE
                                                inner join bd_item item on item.pk_item = defitem.pk_item
                                   where defitem.eu_pvtype = '3'
                                     and defitem.code_defdoclist = '030203'
                                     and defitem.del_flag = '0'
                                     and apply1.PK_CNORD = ord.pk_cnord
                                     and apply1.DT_TUBETYPE = applyt.DT_TUBETYPE for xml path ('')), 1, 1, ''))
             from CN_LAB_APPLY applyt
                          inner join bd_item_defdoc defitemt on defitemt.CODE_DEFDOC = applyt.DT_TUBETYPE
                          inner join bd_item itemt on itemt.pk_item = defitemt.pk_item
             where defitemt.eu_pvtype = '3'
               and defitemt.code_defdoclist = '030203'
               and defitemt.del_flag = '0'
               and applyt.PK_CNORD = ord.pk_cnord
             group by applyt.DT_TUBETYPE) as nameTubeItem,
        </if>
        ord.note_ord,
        hp.name name_hp,
        pres.eu_boil
                from cn_order ord
                             left join bd_supply us on ord.code_supply = us.code
                             inner join bd_ou_dept dept on dept.pk_dept = ord.pk_dept_exec
                             inner join pv_encounter pv on ord.pk_pv = pv.pk_pv
                             left join bd_unit unit on unit.pk_unit = ord.pk_unit
                             left join bd_unit unitdos on unitdos.pk_unit = ord.pk_unit_dos
                             left join bd_unit unitcg on unitcg.pk_unit = ord.pk_unit_cg
                             inner join bd_term_freq freq on freq.code = ord.code_freq
                             left join pv_infant newborn on pv.pk_pv = newborn.pk_pv and ord.infant_no = newborn.sort_no
                             left join bd_ordtype type on type.code = ord.code_ordtype and type.del_flag = '0'
                             left join bd_hp hp on hp.pk_hp = pv.pk_insu and hp.del_flag = '0'
                             left join cn_prescription pres on pres.pk_pres = ord.pk_pres and pres.del_flag = '0'
                             LEFT JOIN (select att.*
                                        FROM BD_PD_ATT att
                                                     INNER JOIN BD_PD_ATT_DEFINE de
                                                ON de.PK_PDATTDEF = att.PK_PDATTDEF AND de.DEL_FLAG = '0'
                                        where de.CODE_ATT = 'BA11'
                                          AND att.del_flag = '0'
                                          and att.VAL_ATT is not null) tt
                        ON tt.PK_PD = ord.PK_ORD AND tt.PK_ORG = ord.PK_ORG
                             left join CN_LAB_APPLY lab on lab.pk_cnord = ord.pk_cnord and lab.del_flag = '0'
                             left join BD_DEFDOC def
                        on def.code = lab.dt_samptype and def.del_flag = '0' and def.code_defdoclist = '030200'
                where (ord.flag_doctor = '1' or (ord.flag_doctor = '0' and ord.ordsn_parent != ord.ordsn))
        <if test="euAlways != null  and euAlways != ''">
            and ord.eu_always = #{euAlways,jdbcType=VARCHAR}
        </if>
        <if test="ordtype != null  and ordtype != ''">
            and ord.code_ordtype like #{ordtype,jdbcType=VARCHAR} || '%'
        </if>
        <if test="pkDeptNs != null  and pkDeptNs != ''">
            and ord.pk_dept_ns = #{pkDeptNs,jdbcType=CHAR}
        </if>
        <if test="pkDept != null  and pkDept != ''">
            and ord.pk_dept = #{pkDept,jdbcType=CHAR}
        </if>
        <if test='flagN == "stop"'>
            <!-- 新停已核对 -->
            and ord.flag_stop_chk = '1'
        </if>
        <if test="chkDate != null  and chkDate != ''">
            <!-- 审核日期 -->
            and to_char(ord.date_chk, 'YYYYMMDD') = #{chkDate,jdbcType=VARCHAR}
        </if>
        <if test="chkStopDate != null  and chkStopDate != ''">
            <!-- 停止审核日期 -->
            and to_char(ord.date_stop_chk, 'YYYYMMDD') = #{chkStopDate,jdbcType=VARCHAR}
        </if>
        <if test="flagEmer != null  and flagEmer != ''">
            <!-- 加急标志 -->
            and ord.flag_emer = #{flagEmer,jdbcType=CHAR}
        </if>
        and ord.eu_status_ord ${statusOrd}   and ord.PK_PV in
        <foreach collection="pkPvs" item="pkPv" index="index" open="(" close=")" separator=",">
            #{pkPv}
        </foreach>
        <if test='ordtypeRange == "1" '>
            and  ((ord.eu_always='0' and ord.flag_stop_chk='0') or ( ord.eu_always='1')) and (ord.flag_erase='0')
        </if>
        <if test='ordtypeRange == "2" '><!-- 当天医嘱 -->
            and ( ord.date_start between to_date(#{curDateBegin},'YYYYMMDDHH24MISS') and to_date(#{curDateEnd},'YYYYMMDDHH24MISS'))
        </if>
        <if test='ordtypeRange == "3" '><!-- 3日内医嘱 -->
            and ( ord.date_start between (to_date(#{curDateBegin},'YYYYMMDDHH24MISS'))-2 and (to_date(#{curDateEnd},'YYYYMMDDHH24MISS')) )
        </if>
        <if test='ordtypeRange == "4" '><!-- 10日内医嘱 -->
            and ( ord.date_start between (to_date(#{curDateBegin},'YYYYMMDDHH24MISS'))-9 and (to_date(#{curDateEnd},'YYYYMMDDHH24MISS')) )
        </if>
        <if test='ordtypeRange == "5" '><!-- 当日停止 -->
            and ( ord.date_stop between to_date(#{curDateBegin},'YYYYMMDDHH24MISS') and to_date(#{curDateEnd},'YYYYMMDDHH24MISS'))
        </if>
        <if test='ordtypeRange == "9" '><!-- 当前医嘱 没作废 and  (  当天开立|当天开始 or （长期医嘱并且没有停止核对的） ) -->
            and  ord.flag_erase = '0'
            and ( (ord.date_enter between to_date(#{curDateBegin},'YYYYMMDDHH24MISS') and to_date(#{curDateEnd},'YYYYMMDDHH24MISS'))
            or (ord.date_start between to_date(#{curDateBegin},'YYYYMMDDHH24MISS') and to_date(#{curDateEnd},'YYYYMMDDHH24MISS'))
            or ( ord.date_stop between to_date(#{curDateBegin},'YYYYMMDDHH24MISS') and to_date(#{curDateEnd},'YYYYMMDDHH24MISS'))
            or (ord.eu_always = '0' and ord.flag_stop_chk = '0'))
        </if>
        <if test='ordOrder == "0"'>
            <!-- 排序方式 EX0069 0降序，1升序  默认降序-->
            order by pv.bed_no, ord.date_start desc, nvl(ord.groupno, 0) desc, ord.ordsn_parent, ord.ordsn
        </if>
        <if test='ordOrder == "1"'>
            <!-- 排序方式 EX0069 0降序，1升序  默认降序-->
            order by pv.bed_no, ord.date_start asc, nvl(ord.groupno, 0) desc, ord.ordsn_parent, ord.ordsn
        </if>
    </select>
    <!-- 根据不同条件查询护嘱 -->
    <select id="queryOrderNsList" parameterType="java.util.Map" resultType="com.zebone.nhis.ex.nis.ns.vo.OrderCheckVo">
        select pv.pk_dept_ns                                                             as pk_dept_ns_cur,
               pv.bed_no,
               pv.name_pi,
               unitdos.name                                                              as name_unit_dosage,
               unit.name                                                                 as name_unit,
               us.name                                                                   as name_usage,
               unitcg.name                                                               as name_unit_cg,
               freq.name                                                                 as name_freq,
               freq.cnt,
               newborn.name                                                              as newborn_name,
               dept.name_dept                                                            as name_dept_exec,
               type.name                                                                    name_ordtype,
               ord.pk_pi,
               ord.pk_org,
               ord.pk_pv,
               ord.pk_cnord,
               ord.flag_bl,
               ord.code_ord,
               ord.ordsn,
               ord.ordsn_parent,
               ord.eu_always,
               ord.date_start,
               ord.name_ord,
               ord.spec,
               ord.dosage,
               ord.pk_unit_dos,
               ord.code_supply,
               ord.pk_ord,
               ord.quan,
               ord.pk_unit,
               ord.quan_cg,
               ord.pk_unit_cg,
               ord.price_cg,
               ord.code_freq,
               ord.code_ordtype,
               ord.last_num,
               ord.first_num,
               ord.flag_first,
               ord.infant_no,
               ord.flag_stop,
               ord.flag_erase,
               ord.flag_stop_chk,
               ord.flag_erase_chk,
               ord.flag_self,
               ord.flag_base,
               ord.flag_note,
               ord.eu_status_ord,
               ord.drip_speed,
               ord.name_emp_ord,
               ord.pk_dept,
               ord.pk_emp_ord,
               ord.pk_emp_chk,
               ord.date_chk,
               ord.pk_pres,
               ord.pk_dept_exec,
               ord.date_stop,
               ord.flag_durg,
               ord.pk_emp_stop,
               ord.name_emp_stop,
               ord.note_ord,
               ord.desc_ord,
               ord.pk_emp_erase,
               ord.name_emp_erase,
               ord.date_erase,
               ord.groupno,
               ord.ts,
               ord.name_emp_input,
               ordtype.name                                                                 ordtype,
               (select count(1) from ex_order_occ occ where occ.pk_cnord = ord.pk_cnord) as count_occ
        from cn_order ord
                     left join bd_supply us on ord.code_supply = us.code
                     inner join bd_ou_dept dept on dept.pk_dept = ord.pk_dept_exec
                     inner join pv_encounter pv on ord.pk_pv = pv.pk_pv
                     left join bd_ordtype ordtype on ordtype.code = ord.code_ordtype and ordtype.del_flag = '0'
                     left join bd_unit unit on unit.pk_unit = ord.pk_unit
                     left join bd_unit unitdos on unitdos.pk_unit = ord.pk_unit_dos
                     left join bd_unit unitcg on unitcg.pk_unit = ord.pk_unit_cg
                     inner join bd_term_freq freq on freq.code = ord.code_freq
                     left join pv_infant newborn on pv.pk_pv = newborn.pk_pv and ord.infant_no = newborn.sort_no
                     left join bd_ordtype type on type.code = ord.code_ordtype and type.del_flag = '0'
                where ord.flag_doctor = '0'
        <if test="pkCnord != null">
            and ord.pk_cnord = #{pkCnord,jdbcType=INTEGER}
        </if>
        <if test="ordSnParent != null">
            and ord.ordsn_parent = #{ordSnParent,jdbcType=INTEGER}
        </if>
        <if test="ordSnParent == null or ordSnParent == ''">
            and ord.ordsn_parent = ord.ordsn
        </if>
        <if test="pkPv != null  and pkPv != ''">
            and ord.pk_pv = #{pkPv,jdbcType=VARCHAR}
        </if>
        <if test="euAlways != null  and euAlways != ''">
            and ord.eu_always = #{euAlways,jdbcType=VARCHAR}
        </if>
        <if test="sortno != null">
            and ord.infant_no = #{sortno,jdbcType=INTEGER}
        </if>
        <if test="pkDeptNs != null  and pkDeptNs != ''">
            and ord.pk_dept_ns = #{pkDeptNs,jdbcType=CHAR}
        </if>
        <if test="pkDept != null  and pkDept != ''">
            and ord.pk_dept = #{pkDept,jdbcType=CHAR}
        </if>
        <if test='flagCk == "0"'>
            <!-- 未核对 -->
            and ord.eu_status_ord &lt; 2
        </if>
        <if test='flagCk == "1"'>
            <!-- 已核对 -->
            and ord.eu_status_ord &gt;= 2
        </if>
        order by pv.bed_no, ord.ordsn_parent, ord.ordsn, ord.date_start desc
    </select>
    <update id="updateOrdNsInfo">
        update cn_order set eu_status_ord = #{euStatus,jdbcType=CHAR}
        <!-- 针对护嘱核对的情况 -->
        <if test="pkEmpChk != null  and pkEmpChk != ''">
            , pk_emp_chk = #{pkEmpChk,jdbcType=CHAR}
        </if>
        <if test="nameEmpChk != null  and nameEmpChk != ''">
            , name_emp_chk = #{nameEmpChk,jdbcType=VARCHAR}
        </if>
        <if test="dateChk != null  and dateChk != ''">
            , date_chk = #{dateChk,jdbcType=TIMESTAMP}
        </if>
        <!-- 针对护嘱停止的情况 -->
        <if test="dateStop != null  and dateStop != ''">
            , date_stop = #{dateStop,jdbcType=TIMESTAMP}
        </if>
        <if test="pkEmpStop != null  and pkEmpStop != ''">
            , pk_emp_stop = #{pkEmpStop,jdbcType=CHAR}
        </if>
        <if test="nameEmpStop != null  and nameEmpStop != ''">
            , name_emp_stop = #{nameEmpStop,jdbcType=VARCHAR}
        </if>
        <if test="flagStop != null  and flagStop != ''">
            , flag_stop = #{flagStop,jdbcType=CHAR}
        </if>
        <if test="dateStopChk != null  and dateStopChk != ''">
            , date_stop_chk = #{dateStopChk,jdbcType=TIMESTAMP}
        </if>
        <if test="pkEmpStopChk != null  and pkEmpStopChk != ''">
            , pk_emp_stop_chk = #{pkEmpStopChk,jdbcType=CHAR}
        </if>
        <if test="nameEmpStopChk != null  and nameEmpStopChk != ''">
            , name_emp_stop_chk = #{nameEmpStopChk,jdbcType=VARCHAR}
        </if>
        <if test="flagStopChk != null  and flagStopChk != ''">
            , flag_stop_chk = #{flagStopChk,jdbcType=CHAR}
        </if>
        <!-- 针对护嘱作废的情况 -->
        <if test="dateErase != null  and dateErase != ''">
            , date_erase = #{dateErase,jdbcType=TIMESTAMP}
        </if>
        <if test="pkEmpErase != null  and pkEmpErase != ''">
            , pk_emp_erase = #{pkEmpErase,jdbcType=CHAR}
        </if>
        <if test="nameEmpErase != null  and nameEmpErase != ''">
            , name_emp_erase = #{nameEmpErase,jdbcType=VARCHAR}
        </if>
        <if test="flagErase != null  and flagErase != ''">
            , flag_erase = #{flagErase,jdbcType=CHAR}
        </if>
        <if test="dateEraseChk != null  and dateEraseChk != ''">
            , date_erase_chk = #{dateEraseChk,jdbcType=TIMESTAMP}
        </if>
        <if test="pkEmpEraseChk != null  and pkEmpEraseChk != ''">
            , pk_emp_erase_chk = #{pkEmpEraseChk,jdbcType=CHAR}
        </if>
        <if test="nameEraseChk != null  and nameEraseChk != ''">
            , name_erase_chk = #{nameEraseChk,jdbcType=VARCHAR}
        </if>
        <if test="flagEraseChk != null  and flagEraseChk != ''">
            , flag_erase_chk = #{flagEraseChk,jdbcType=CHAR}
        </if>
        where pk_cnord in
        <foreach item="pkOrd" index="index" collection="pkOrds" open="(" separator="," close=")">
            #{pkOrd}
        </foreach>
    </update>
    <update id="updateOrdInfo">
        update cn_order set eu_status_ord = #{euStatus,jdbcType=CHAR}
        <!-- 针对医嘱核对的情况 -->
        <if test="pkEmpChk != null  and pkEmpChk != ''">
            , pk_emp_chk = #{pkEmpChk,jdbcType=CHAR}
        </if>
        <if test="nameEmpChk != null  and nameEmpChk != ''">
            , name_emp_chk = #{nameEmpChk,jdbcType=VARCHAR}
        </if>
        <if test="dateChk != null  and dateChk != ''">
            , date_chk = #{dateChk,jdbcType=TIMESTAMP}
        </if>
        <!-- 针对医嘱停止的情况 -->
        <if test="dateStopChk != null  and dateStopChk != ''">
            , date_stop_chk = #{dateStopChk,jdbcType=TIMESTAMP}
        </if>
        <if test="pkEmpStopChk != null  and pkEmpStopChk != ''">
            , pk_emp_stop_chk = #{pkEmpStopChk,jdbcType=CHAR}
        </if>
        <if test="nameEmpStopChk != null  and nameEmpStopChk != ''">
            , name_emp_stop_chk = #{nameEmpStopChk,jdbcType=VARCHAR}
        </if>
        <if test="flagStopChk != null  and flagStopChk != ''">
            , flag_stop_chk = #{flagStopChk,jdbcType=CHAR}
        </if>
        <!-- 针对护嘱作废的情况 -->
        <if test="dateEraseChk != null  and dateEraseChk != ''">
            , date_erase_chk = #{dateEraseChk,jdbcType=TIMESTAMP}
        </if>
        <if test="pkEmpEraseChk != null  and pkEmpEraseChk != ''">
            , pk_emp_erase_chk = #{pkEmpEraseChk,jdbcType=CHAR}
        </if>
        <if test="nameEraseChk != null  and nameEraseChk != ''">
            , name_erase_chk = #{nameEraseChk,jdbcType=VARCHAR}
        </if>
        <if test="flagEraseChk != null  and flagEraseChk != ''">
            , flag_erase_chk = #{flagEraseChk,jdbcType=CHAR}
        </if>
        <!--  where ordsn_parent in
        <foreach collection="parentNos" item="parentNo" index="index" open="(" close=")" separator=",">
               #{parentNo}
         </foreach>
        -->
        where pk_cnord  in
        <foreach collection="pkCnords" item="pkCnord" index="index" open="(" close=")" separator=",">
            #{pkCnord}
        </foreach>
        <if test="whereSql != null  and whereSql != ''">
            ${whereSql}
        </if>
    </update>

    <!-- 根据医嘱主键，查询医嘱对应的费用列表
	<select id="queryOrdFeeByPk" parameterType="java.util.Map" resultType="DynaBean">
	 select '用法附加费' note,
  			sp.name name_supply,
  			spitem.pk_item,
  			spitem.quan,
  			item.name name_item,
  			item.code code_item,
  			item.spec,
  			item.pk_unit,
  			item.price
       from cn_order ord
      inner join bd_supply sp on ord.code_supply = sp.code
      inner join bd_supply_item spitem on sp.pk_supply = spitem.pk_supply and spitem.del_flag = '0'
      inner join bd_item item on item.pk_item = spitem.pk_item and item.del_flag = '0'
       left join bd_unit unit on unit.pk_unit = item.pk_unit
      where spitem.eu_pvtype = '3'
        and ord.pk_cnord = #{pkCnord,jdbcType=CHAR}
</select> 
-->
    <!-- 根据医嘱主键，查询医嘱对应的费用列表-->
    <select id="queryOrdFeeByPk" parameterType="java.util.Map" resultType="DynaBean">
        select sp.NAME || '- 用法附加费' note,
               item.name            name_item,
               item.code            code_item,
               spitem.quan,
               item.spec,
               item.pk_unit,
               unit.name            name_unit,
               item.price
        from cn_order ord
                     inner join bd_supply sp on ord.code_supply = sp.code
                     inner join bd_supply_item spitem on sp.pk_supply = spitem.pk_supply and spitem.del_flag = '0'
                     inner join bd_item item on item.pk_item = spitem.pk_item and item.del_flag = '0'
                     left join bd_unit unit on unit.pk_unit = item.pk_unit
                where
        <if test='dbType == "oracle"'>
            (spitem.eu_pvtype = '3' or spitem.eu_pvtype is null)
        </if>
        <if test='dbType == "sqlserver"'>
            (spitem.eu_pvtype = '3' or (spitem.eu_pvtype is null or spitem.eu_pvtype=''))
        </if>
        and ord.pk_cnord =
        #{pkCnord,jdbcType=CHAR}
        union all
                select ''          note,
                       CASE
                               WHEN oi.flag_pd = '0' THEN
                                       item.NAME
                               ELSE
                                       pd.NAME
                               END name_item,
                       CASE
                               WHEN oi.flag_pd = '0' THEN
                                       item.code
                               ELSE
                                       pd.code
                               END code_item,
                       oi.quan,
                       CASE
                               WHEN oi.flag_pd = '0' THEN
                                       item.spec
                               ELSE
                                       pd.spec
                               END spec,
                       item.pk_unit,
                       unit.NAME   name_unit,
                       CASE
                               WHEN oi.flag_pd = '0' THEN
                                       item.price
                               ELSE
                                       pd.price / pd.pack_size
                               END price
                from bd_ord_item oi
                             left join bd_item item on item.pk_item = oi.pk_item and item.del_flag = '0'
                             left join bd_unit unit on unit.pk_unit = item.pk_unit
                             left outer join bd_pd pd ON oi.pk_item = pd.pk_pd AND oi.flag_pd = '1'
                where oi.del_flag = '0'
                  and oi.pk_ord = #{pkOrd,jdbcType=CHAR}
    </select>
    <select id="queryOrdByParent" parameterType="java.util.Map"
            resultType="com.zebone.nhis.common.module.cn.ipdw.CnOrder">
        select pk_cnord
        from cn_order
                where  ordsn_parent  in
        <foreach collection="parentList" item="ordsnParent" index="index" open="(" close=")" separator=",">
            #{ordsnParent}
        </foreach>
        <if test="euStatusOrd != null  and euStatusOrd != ''">
            and eu_status_ord in (${euStatusOrd})
        </if>
        <if test="flagDoctor != null  and flagDoctor != ''">
            and flag_doctor = #{flagDoctor,jdbcType=VARCHAR}
        </if>
    </select>

    <!-- 根据医嘱主键，查询医嘱对应的草药列表-->
    <select id="queryPresDtByOrd" parameterType="java.util.Map" resultType="DynaBean">
        select pres.pres_no,    <!--处方号-->
        pres.date_pres,    <!--日期-->
        pres.eu_boil,    <!--煎药方式-->
        bt.name boil_type,    <!--煎法-->
        pres.name_emp_ord,    <!--医生-->
        ord.note_ord,        <!--备注-->
        ppt.name pres_type, <!--处方性质-->
        ord.ords,            <!--付数-->
        pd.name name_pd,    <!--药品名称-->
        pd.code code_pd,    <!--药品编码-->
        pd.spec,            <!--规格-->
        herb.quan,            <!--用量-->
        unit.name name_unit,<!--单位-->
        ug.name usage_type,    <!--服法-->
        pd.eu_herbtype        <!--草药类型-->
        from cn_prescription pres
                     inner join cn_order ord on pres.pk_pres = ord.pk_pres
                     inner join cn_ord_herb herb on ord.pk_cnord = herb.pk_cnord
                     inner join bd_pd pd on herb.pk_pd = pd.pk_pd
                     inner join bd_unit unit on herb.pk_unit = unit.pk_unit
                     left join bd_defdoc bt on pres.dt_boiltype = bt.code and bt.code_defdoclist = '030411'
                     left join bd_defdoc ug on herb.dt_herbusage = ug.code and ug.code_defdoclist = '030410'
                     left join bd_defdoc ppt on pres.dt_properties = ppt.code and ppt.code_defdoclist = '060103'
        where ord.pk_cnord = #{pkCnord,jdbcType=CHAR}
    </select>

    <select id="querySupplyItemByCode" parameterType="java.util.Map" resultType="DynaBean">
        select item.NAME, item.PRICE * supitem.QUAN as price, item.PRICE price_one, supitem.QUAN, item.spec
        from bd_supply sup
                     inner join BD_SUPPLY_ITEM supitem on sup.PK_SUPPLY = supitem.PK_SUPPLY
                     inner join BD_ITEM item on item.PK_ITEM = supitem.PK_ITEM
                where sup.DEL_FLAG = 0
                  and supitem.DEL_FLAG = 0
                  and item.DEL_FLAG = 0
                  and item.FLAG_ACTIVE = 1
                  and sup.code = #{codeSupply,jdbcType=VARCHAR}
        <if test="euPvtype != null  and euPvtype != ''">
            and (supitem.eu_pvtype = #{euPvtype,jdbcType=VARCHAR} or supitem.eu_pvtype is null or
                 supitem.eu_pvtype = '')
        </if>
    </select>

    <select id="queryLisItemByPkCnorder" parameterType="java.util.Map" resultType="DynaBean">
        select item.name, item.PRICE * bid.QUAN AS price, item.PRICE price_one, bid.QUAN, item.spec
        from CN_LAB_APPLY apl
                     INNER JOIN bd_item_defdoc bid
                ON bid.code_defdoc = apl.dt_tubetype and bid.code_defdoclist = '030203' and bid.eu_pvtype='3'
                     INNER JOIN bd_item item ON bid.pk_item = item.pk_item
        where apl.pk_cnord = #{pkCnorder,jdbcType=VARCHAR}
    </select>
    <select id="getOrder" resultType="com.zebone.nhis.ex.nis.ns.vo.OrderCheckVo">
        select pv.pk_dept_ns                                                     as pk_dept_ns_cur,
               pv.bed_no,
               pv.name_pi,
               pv.flag_spec,
               pi.code_ip,
               pi.birth_date,
               newborn.name                                                      as newborn_name,
               dept.name_dept                                                    as name_dept_exec,
               unitdos.name                                                      as name_unit_dosage,
               unit.name                                                         as name_unit,
               us.name                                                           as name_usage,
               us.pk_supplycate,
               unitcg.name                                                       as name_unit_cg,
               freq.name                                                         as name_freq,
               freq.cnt,
               def.name                                                          AS lab_name,
               freq.eu_cycle,
               ord.pk_org,
               ord.pk_dept,
               ord.pk_cnord,
               ord.pk_ord,
               ord.pk_pres,
               ord.pk_pi,
               ord.pk_pv,
               ord.ordsn,
               ord.groupno,
               ord.ordsn_parent,
               ord.name_ord,
               ord.code_ord,
               ord.eu_always,
               ord.eu_status_ord,
               ord.drip_speed,
               ord.date_start,
               ord.code_supply,
               ord.code_freq,
               ord.code_ordtype,
               ord.dosage,
                pd.pack_size,
		       pd.PK_UNIT_MIN as pk_unit,
               ord.pk_unit_dos,
               ord.quan,
               ord.pk_unit,
               ord.quan_cg,
               ord.pk_unit_cg,
               case when ord.flag_durg = '1' then pd.price else ord.price_cg end as price_cg,
               ord.days,
               ord.ords,
               ord.spec,
               ord.infant_no,
               ord.last_num,
               ord.first_num,
               ord.flag_fit,
               ord.desc_fit,
               ord.flag_bl,
               ord.flag_emer,
               ord.flag_first,
               ord.flag_stop,
               ord.flag_erase,
               ord.flag_stop_chk,
               ord.flag_erase_chk,
               ord.flag_durg,
               ord.flag_doctor,
               ord.flag_self,
               ord.flag_base,
               ord.flag_medout,
               ord.flag_note,
               ord.flag_pivas,
               ord.eu_st,
               ord.pk_emp_ord,
               ord.name_emp_ord,
               ord.date_chk,
               ord.pk_emp_chk,
               ord.pk_dept_exec,
               ord.pk_org_exec,
               ord.pack_size,
               ord.date_plan_ex,
               ord.date_stop,
               ord.pk_emp_stop,
               ord.name_emp_stop,
               ord.note_ord,
               ord.ts,
               hp.name                                                              name_hp,
               type.name                                                            name_ordtype,
               pres.eu_boil,
               ord.desc_ord,
               pd.dt_injtype
        from cn_order ord
                     left join bd_supply us on ord.code_supply = us.code
                     inner join bd_ou_dept dept on dept.pk_dept = ord.pk_dept_exec and dept.del_flag = '0'
                     inner join pv_encounter pv
                on ord.pk_pv = pv.pk_pv and pv.eu_pvtype = '3' and pv.flag_in = '1' and pv.del_flag = '0'
                     inner join pi_master pi on pi.pk_pi = pv.pk_pi and pi.del_flag = '0'
                     left join bd_unit unit on unit.pk_unit = ord.pk_unit
                     left join bd_unit unitdos on unitdos.pk_unit = ord.pk_unit_dos
                     left join bd_unit unitcg on unitcg.pk_unit = ord.pk_unit_cg
                     inner join bd_term_freq freq on freq.code = ord.code_freq
                     left join pv_infant newborn on pv.pk_pv = newborn.pk_pv and ord.infant_no = newborn.sort_no
                     left join bd_ordtype type on type.code = ord.code_ordtype and type.del_flag = '0'
                     left join bd_hp hp on hp.pk_hp = pv.pk_insu and hp.del_flag = '0'
                     left join cn_prescription pres on pres.pk_pres = ord.pk_pres and pres.del_flag = '0'
                     left join bd_pd pd on ord.pk_ord = pd.pk_pd and pd.del_flag = '0'
                     left join CN_LAB_APPLY lab on lab.pk_cnord = ord.pk_cnord and lab.del_flag = '0'
                     left join BD_DEFDOC def
                on def.code = lab.dt_samptype and def.del_flag = '0' and def.code_defdoclist = '030200'
                where ord.ORDSN in
        <foreach collection="pklist" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
</mapper>